<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Dento Digital NAVLOG</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
    /* --- SCREEN / EDITOR STYLES --- */
    body {
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        background: #f7f7f7;
        margin: 0;
        color: #333;
        -webkit-font-smoothing: antialiased;
    }
    h1 {
        background: linear-gradient(135deg, #beab72, #9e8b52); 
        color: white;
        margin: 0;
        padding: 16px 25px;
        font-size: 24px;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h5 {
        background: #002147;
        color: #b0c4de;
        margin: 0;
        padding: 5px 25px 10px;
        font-weight: normal;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .container { padding: 20px 25px; }
    
    /* --- ANIMATIONS --- */
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse-dot {
        0% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); }
        50% { transform: scale(1.5); opacity: 0.7; box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); }
        100% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
    }

    @keyframes radar-spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .graph-dot {
        transform-box: fill-box;
        transform-origin: center;
    }

    fieldset {
        border: 1px solid #d4d4d4;
        margin-bottom: 20px;
        background: #fff;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        animation: fadeInUp 0.6s ease-out forwards;
        opacity: 0; 
    }
    fieldset:hover {
        box-shadow: 0 8px 15px rgba(0,0,0,0.05);
    }
    /* Stagger animations */
    fieldset:nth-of-type(1) { animation-delay: 0.1s; }
    fieldset:nth-of-type(2) { animation-delay: 0.2s; }
    fieldset:nth-of-type(3) { animation-delay: 0.3s; }
    fieldset:nth-of-type(4) { animation-delay: 0.4s; }
    fieldset:nth-of-type(5) { animation-delay: 0.5s; }
    fieldset:nth-of-type(6) { animation-delay: 0.6s; }

    legend {
        padding: 0 8px;
        font-weight: 700;
        color: #002147;
        font-size: 14px;
        background: #f7f7f7;
        border-radius: 4px;
    }
    .row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 10px;
        align-items: flex-end;
    }
    .metar-row {
        display: flex;
        flex-wrap: wrap;
        align-items: flex-start;
        gap: 20px;
        margin-top: 15px;
        border-top: 1px dashed #eee;
        padding-top: 15px;
    }
    .metar-input-group {
        display: flex;
        flex-direction: column;
        flex-basis: 250px;
        flex-shrink: 0;
        flex-grow: 1;
    }
    .metar-output {
        flex-grow: 1;
        min-width: 300px;
    }

    /* Visual Metar Widget */
    .metar-visual-widget {
        margin-top: 10px;
        background: linear-gradient(145deg, #005baa, #004a8f);
        border-radius: 12px;
        color: white;
        padding: 15px;
        display: flex;
        flex-direction: column;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 4px 10px rgba(0,91,170,0.3);
        font-family: 'Segoe UI', sans-serif;
        transition: transform 0.2s;
    }
    .metar-visual-widget:hover { transform: translateY(-2px); }
    
    .widget-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .flight-category { background: #28a745; padding: 4px 12px; border-radius: 12px; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .flight-category.ifr { background: #dc3545; }
    .flight-category.mvfr { background: #007bff; }
    .weather-info { font-size: 13px; line-height: 1.4; }
    .weather-info div { display: flex; align-items: center; gap: 6px; }
    .temp-display { text-align: right; font-size: 20px; font-weight: bold; }
    .temp-icon { font-size: 24px; margin-right: 5px; }
    .compass-container { position: relative; width: 200px; height: 200px; margin: 0 auto; }
    canvas#windCompass { width: 100%; height: 100%; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); }
    .wind-text { text-align: center; background: rgba(0,0,0,0.2); padding: 4px 10px; border-radius: 10px; margin: -20px auto 0; width: fit-content; position: relative; z-index: 10; font-weight: bold; font-size: 14px; backdrop-filter: blur(4px); }

    /* Traffic Radar Widget */
    .traffic-widget {
        background: #111827;
        color: #10b981;
        border-radius: 12px;
        padding: 15px;
        position: relative;
        overflow: hidden;
        min-height: 160px;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: inset 0 0 20px rgba(0,0,0,0.8);
    }
    .radar-screen {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 2px solid #059669;
        position: relative;
        background: radial-gradient(circle, #064e3b 0%, #065f46 30%, #111827 70%);
        flex-shrink: 0;
    }
    .radar-sweep {
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        border-radius: 50%;
        background: conic-gradient(from 0deg, transparent 0deg, rgba(16, 185, 129, 0.5) 30deg, transparent 30.1deg);
        animation: radar-spin 3s linear infinite;
        border-right: 1px solid rgba(16, 185, 129, 0.8);
    }
    .radar-blip {
        position: absolute;
        width: 4px;
        height: 4px;
        background: #34d399;
        border-radius: 50%;
        box-shadow: 0 0 4px #34d399;
    }
    .traffic-info { flex-grow: 1; }
    .traffic-status-title { font-size: 16px; font-weight: bold; margin-bottom: 5px; color: white; }
    .traffic-subtitle { font-size: 12px; color: #9ca3af; margin-bottom: 10px; }
    .traffic-slots { 
        background: rgba(255,255,255,0.1); 
        padding: 8px; 
        border-radius: 6px; 
        font-size: 12px; 
        color: #d1fae5;
    }
    .status-bad { color: #ef4444; }
    .status-good { color: #10b981; }

    /* Form Fields */
    .field {
        display: flex;
        flex-direction: column;
        font-size: 12px;
        flex-grow: 1;
    }
    .field label { margin-bottom: 4px; color: #555; font-weight: 500; }
    .field input, .field textarea, .field select, .wpField input, .wpField select {
        padding: 10px;
        min-width: 100px;
        border: 1px solid #d1d5db;
        font-size: 13px;
        border-radius: 6px;
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        background: #fdfdfd;
    }
    .field input:focus, .field textarea:focus, .field select:focus, 
    .wpField input:focus, .wpField select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
        outline: none;
        background: #fff;
        transform: scale(1.02);
    }
    textarea { width: 100%; min-height: 100px; resize: vertical; }
    
    /* Calc Readouts */
    .calc-readout {
        font-size: 11px;
        margin-top: 4px;
        font-weight: 700;
        color: #005baa;
        height: 16px; 
        transition: color 0.3s;
    }
    .calc-readout.danger { color: #dc3545; animation: shake 0.5s; }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }

    /* Table Wrapper */
    .table-wrapper {
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; 
        margin-top: 15px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    table { width: 100%; border-collapse: collapse; background: #fff; }
    th {
        background: #f8fafc;
        color: #475569;
        font-weight: 700;
        border-bottom: 2px solid #e2e8f0;
        border-right: 1px solid #e2e8f0;
        padding: 10px 6px;
        font-size: 12px;
        text-transform: uppercase;
        white-space: nowrap;
    }
    td {
        border: 1px solid #f1f5f9;
        padding: 6px 4px;
        text-align: center;
        font-size: 12px;
    }
    #navlog tbody tr:nth-child(even) { background-color: #f8fafc; }
    input[readonly] { background: #f1f5f9; color: #64748b; font-weight: 600; cursor: default; }
    
    /* Buttons */
    button {
        padding: 10px 18px;
        margin: 4px 6px 10px 0;
        border: none;
        background: linear-gradient(to bottom, #3b82f6, #2563eb);
        color: white;
        cursor: pointer;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
    }
    button:hover { 
        background: linear-gradient(to bottom, #2563eb, #1d4ed8);
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
    }
    button:active { transform: translateY(1px) scale(0.98); }
    
    button[onclick*="calculateAll"] { 
        background: linear-gradient(to bottom, #22c55e, #16a34a);
        box-shadow: 0 2px 4px rgba(22, 163, 74, 0.2);
    }
    button[onclick*="calculateAll"]:hover { 
        background: linear-gradient(to bottom, #16a34a, #15803d);
        box-shadow: 0 4px 8px rgba(22, 163, 74, 0.3);
    }
    
    /* Feature Buttons */
    #reverseBtn { background: linear-gradient(to bottom, #94a3b8, #64748b); }
    #mapBtn { background: linear-gradient(to bottom, #06b6d4, #0891b2); }
    #fetchMetarBtn { background: linear-gradient(to bottom, #f59e0b, #d97706); }
    #checkTrafficBtn { background: linear-gradient(to bottom, #ec4899, #db2777); }
    
    .wpField { display: flex; flex-direction: column; min-width: 120px; }
    .wpField select { font-size: 12px; padding: 6px; margin-bottom: 4px; cursor: pointer; }
    .calculated-flash { animation: flashGreen 0.6s ease-out; }
    @keyframes flashGreen {
        0% { background-color: #fff; transform: scale(1); }
        50% { background-color: #dcfce7; transform: scale(1.05); }
        100% { background-color: #fff; transform: scale(1); }
    }

    /* Map Modal */
    .map-modal {
        display: none;
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 10000;
        align-items: center; justify-content: center;
        backdrop-filter: blur(4px);
    }
    .map-content {
        width: 90%; height: 90%; background: white;
        border-radius: 12px; overflow: hidden; position: relative;
        display: flex; flex-direction: column;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        animation: fadeInUp 0.4s ease-out;
    }
    #map { flex-grow: 1; width: 100%; }
    .map-close {
        position: absolute; top: 15px; right: 15px; z-index: 10001;
        background: white; border: none; padding: 8px 16px;
        cursor: pointer; font-weight: bold; border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); color: #333;
        transition: transform 0.2s;
    }
    .map-close:hover { transform: scale(1.05); }

    /* Mass & Balance */
    .mb-container { display: flex; flex-wrap: wrap; gap: 20px; }
    .mb-inputs { flex: 1; min-width: 300px; display: flex; flex-direction: column; gap: 15px; }
    .mb-input-group { display: flex; flex-direction: column; gap: 5px; }
    .mb-input-header { display: flex; justify-content: space-between; align-items: center; }
    .mb-input-header label { font-size: 13px; font-weight: 600; color: #444; }
    .mb-input-header input { width: 60px; text-align: right; font-family: monospace; padding: 4px 6px; font-weight: bold; border: 1px solid #cbd5e1; border-radius: 6px; }
    .mb-slider { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; appearance: none; outline: none; cursor: pointer; }
    .mb-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: currentColor; cursor: pointer; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .slider-blue { accent-color: #2563eb; color: #2563eb; }
    .slider-amber { accent-color: #d97706; color: #d97706; }
    .slider-purple { accent-color: #9333ea; color: #9333ea; }
    
    .mb-graph-container { flex: 1; min-width: 300px; border: 1px solid #e0e0e0; background: #fff; border-radius: 12px; padding: 10px; position: relative; }
    .mb-status { margin-top: 10px; padding: 10px; border-radius: 8px; font-weight: bold; text-align: center; font-size: 14px; }
    .mb-safe { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
    .mb-unsafe { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; animation: shake 0.5s; }
    .mb-table { width: 100%; font-size: 12px; margin-top: 10px; }
    .mb-table th { background: #f1f5f9; text-align: right; padding: 6px 8px; }
    .mb-table td { text-align: right; padding: 6px 8px; border-bottom: 1px solid #eee; }

    /* Fuel Table */
    .fuel-calc-table { width: 100%; font-size: 12px; border-collapse: separate; border-spacing: 0; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
    .fuel-calc-table th { text-align: left; background: #f8fafc; padding: 8px; border-bottom: 1px solid #e2e8f0; font-weight: 700; color: #475569; }
    .fuel-calc-table td { padding: 8px; border-bottom: 1px solid #f1f5f9; }
    .fuel-calc-table input { width: 100%; border: none; background: transparent; font-family: monospace; text-align: right; font-weight: bold; color: #334155; }
    .fuel-total-row { background: #f1f5f9; font-weight: bold; color: #1e293b; }

    /* --- CUSTOM PRINT CSS FIXED FOR KNEEBOARD (SIDE BY SIDE) --- */
    #printSheetWrapper { 
        display: none; 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(60, 60, 60, 0.9);
        z-index: 9999;
        overflow-y: auto; 
        padding: 20px;
        box-sizing: border-box;
    }
    body.show-overlay #printSheetWrapper { display: flex; justify-content: center; }
    body.show-overlay #editor, body.show-overlay h1, body.show-overlay h5 { display: none; }
    
    #overlayCloseBtn { 
        position: fixed; top: 20px; right: 20px; 
        padding: 10px 20px; background: #1e293b; color: white; 
        z-index: 10000; border-radius: 8px; 
        font-weight: bold; border: 1px solid #475569; cursor: pointer;
    }

    /* PRINT SHEET CONTAINER (A4 Landscape) */
    .print-sheet {
        width: 297mm; /* A4 Landscape Width */
        height: 210mm; /* A4 Landscape Height */
        background: white;
        display: flex;
        overflow: hidden;
        page-break-after: always;
        margin-bottom: 20px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.5);
    }

    /* HALF PAGE SLOT (A5) */
    .half-sheet {
        width: 50%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center; /* VERTICALLY CENTER CONTENT */
        border-right: 1px dashed #ccc; /* Cut Line */
        position: relative;
        overflow: hidden;
    }
    .half-sheet:last-child { border-right: none; }

    /* DENTO PRINT PAGE (Scaled Down to fit A5) */
    .dento-page-scaled { 
        width: 210mm; 
        height: 296mm; 
        background: white; 
        padding: 10mm; 
        box-sizing: border-box; 
        display: flex; flex-direction: column;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
        /* SCALING MAGIC */
        transform: scale(0.62); /* REDUCED SCALE TO 0.62 TO ENSURE FOOTER FITS */
        transform-origin: center center; /* CENTER SCALING */
    }

    /* Grid Lines */
    .dento-form { border: 2px solid #000; width: 100%; height: 100%; display: flex; flex-direction: column; }
    
    /* Header */
    .header-top { height: 160px; display: flex; border-bottom: 1px solid black; }
    .header-left { width: 20%; border-right: 1px solid black; display: flex; flex-direction: column; }
    .header-right { width: 80%; display: flex; flex-direction: column; }
    
    /* Transponder */
    .xpdr-row { height: 33.3%; border-bottom: 1px solid black; display: flex; }
    .xpdr-row:last-child { border-bottom: none; }
    .xpdr-label { 
        width: 60%; background: #ccc; font-size: 10px; font-weight: bold; 
        display: flex; align-items: center; padding-left: 4px; 
        border-right: 1px solid black; 
    }
    .xpdr-val { width: 40%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; }
    
    /* Header Fields */
    .fd-row { flex: 1; display: flex; border-bottom: 1px solid black; }
    .fd-cell { flex: 1; border-right: 1px solid black; padding: 0 5px; display: flex; align-items: center; font-size: 12px; overflow: hidden; }
    .fd-cell:last-child { border-right: none; }
    .p-label { font-weight: bold; margin-right: 6px; font-size: 11px; }
    .p-value { font-family: 'Courier New', monospace; font-weight: bold; font-size: 13px; }
    
    .rw-row { height: 30px; display: flex; border-bottom: 1px solid black; }
    .rw-cell { border-right: 1px solid black; padding: 0 5px; display: flex; align-items: center; font-size: 10px; }
    
    /* Main Table */
    .navlog-print-table { 
        width: 100%; 
        flex-grow: 1; 
        border-collapse: collapse; 
        table-layout: fixed; 
    }
    .navlog-print-table th { 
        background: #ccc; 
        border: 1px solid black; 
        font-size: 9px; 
        height: 30px; 
        text-align: center; 
        padding: 2px;
        overflow: hidden;
        white-space: normal; 
        line-height: 1;
    }
    .navlog-print-table td { 
        border: 1px solid black; 
        height: 35px; 
        font-size: 11px; 
        text-align: center; 
        vertical-align: middle; 
        padding: 2px;
        overflow: hidden;
        white-space: nowrap;
    }
    
    .col-fromto { width: 16%; }
    .col-msa { width: 5%; }
    .col-alt { width: 5%; }
    .col-tas { width: 5%; }
    .col-tr { width: 6%; }
    .col-wv { width: 8%; }
    .col-hdg { width: 6%; }
    .col-gs { width: 6%; }
    .col-dist { width: 7%; }
    .col-time { width: 7%; }
    .col-eta { width: 10%; }
    .col-ata { width: 10%; }

    .split-cell { display: flex; flex-direction: column; height: 100%; justify-content: space-around; }
    .split-top { border-bottom: 1px dashed #666; height: 50%; display: flex; align-items: center; justify-content: center; }
    .split-bottom { height: 50%; display: flex; align-items: center; justify-content: center; }

    /* Footer */
    .footer-section { height: 180px; display: flex; border-top: 1px solid black; }
    .footer-left { width: 30%; border-right: 1px solid black; display: flex; flex-direction: column; }
    .footer-mid { width: 63%; display: flex; flex-direction: column; }
    .footer-right { 
        width: 35px; 
        background-color: #999 !important; /* FORCE COLOR */
        display: flex; align-items: center; justify-content: center; 
        border-left: 1px solid black; 
        -webkit-print-color-adjust: exact;
    }
    
    /* Distress */
    .distress-bar { background: #ccc; height: 20px; font-size: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid black; }
    
    /* Stations Table - FIXED BORDERS */
    .stations-table { width: 100%; border-collapse: collapse; height: 60px; }
    .stations-table th { background: #fff; font-size: 10px; height: 20px; border: 1px solid black !important; text-align: center; }
    .stations-table td { border: 1px solid black !important; font-size: 11px; text-align: center; }
    
    /* Fuel Section */
    .fuel-header { background: #ccc; text-align: center; font-weight: bold; font-size: 10px; border-top: 1px solid black; border-bottom: 1px solid black; padding: 2px; }
    .fuel-row { display: flex; border-bottom: 1px solid black; height: 20px; font-size: 11px; }
    .fuel-row:last-child { border-bottom: none; }
    .fuel-lbl { width: 50%; border-right: 1px solid black; padding-left: 5px; display: flex; align-items: center; font-weight: bold; }
    .fuel-val { width: 50%; display: flex; align-items: center; justify-content: center; font-family: monospace; }
    
    .mb-print-box { padding: 4px; font-size: 10px; display: flex; justify-content: space-between; border-top: 1px solid black; margin-top: auto; }

    /* Clearance */
    .clearance-header { background: #ccc; text-align: center; font-weight: bold; font-size: 12px; border-bottom: 1px solid black; padding: 2px; }
    .clearance-box { flex-grow: 1; padding: 5px; font-family: 'Courier New', monospace; font-size: 12px; white-space: pre-wrap; }

    /* Vertical Text Bar */
    .vertical-text { 
        transform: rotate(-90deg); 
        color: white; 
        font-weight: bold; 
        font-size: 18px; 
        white-space: nowrap; 
        font-family: Arial, sans-serif;
        letter-spacing: 1px;
        background: transparent !important; /* Prevent white bg on text */
    }

    @media print {
        @page { size: A4 landscape; margin: 0; }
        body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; overflow: visible; }
        #editor, h1, h5, #fetchMetarBtn, button { display: none !important; }
        #printSheetWrapper { display: block !important; position: static; background: white; overflow: visible; padding: 0; }
        .print-sheet { box-shadow: none; margin: 0; width: 100%; height: 100%; page-break-after: always; }
        #overlayCloseBtn { display: none; }
    }

    @media (max-width: 768px) {
        .container { padding: 10px 15px; }
        .row, .metar-row { gap: 12px; }
        .field, .metar-input-group, .metar-output { width: 100%; flex-basis: 100%; min-width: 0; }
        button { width: 100%; margin: 6px 0; }
        input, select, textarea { font-size: 16px !important; }
    }
</style>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</head>
<body>

<h1>Dento Digital Navlog</h1>
<h5>CREATED BY MICHAEL MITRY</H5>

<div id="editor" class="container">
<fieldset>
<legend>Flight Info</legend>
<div class="row">
    <div class="field">
        <label>Pilot</label>
        <input id="pilot">
    </div>
    <div class="field">
        <label>A/C Reg</label>
        <select id="acreg">
            <option value="" disabled selected>Select A/C</option>
            <option value="5B-CMK">5B-CMK</option>
            <option value="5B-CMN">5B-CMN</option>
            <option value="5B-CLT">5B-CLT</option>
        </select>
    </div>
    <div class="field">
        <label>From</label>
        <input id="from" onchange="suggestAlternate()">
    </div>
    <div class="field">
        <label>To</label>
        <input id="to" onchange="suggestAlternate()">
    </div>
    <div class="field">
        <label>Total Distance (NM)</label>
        <input id="totalDist" readonly>
    </div>
    <div class="field">
        <label>Planned Flight Time</label>
        <input id="plannedTime" placeholder="hh:mm">
    </div>
</div>

<div class="row">
    <div class="field">
        <label>Alternate</label>
        <input id="alt" onchange="calculateAll()">
    </div>
    <div class="field">
        <label>Alt Distance (NM)</label>
        <input id="altDist" onchange="calculateAll()">
    </div>
    <div class="field">
        <label>Dep Time (UTC / LT)</label>
        <input id="depTime" value="08:00" placeholder="hh:mm">
    </div>
    <div class="field">
        <label>Variation (E+ / W-)</label>
        <input id="variation" value="4">
    </div>
    <div class="field">
        <label>Fuel Burn (L/hr)</label>
        <input id="fuelburn" value="10" onchange="calculateAll()">
    </div>
</div>

<div class="metar-row">
    <div class="metar-input-group">
        <label for="metarIcao">METAR Station (ICAO)</label>
        <input id="metarIcao" placeholder="e.g., LCLK or LCPH" oninput="autoSave()">
        <button id="fetchMetarBtn" onclick="getMetar()">‚òÅÔ∏è Get Live METAR</button>
    </div>
    <div class="metar-output">
        <label for="rawMetar">Raw METAR Report</label>
        <textarea id="rawMetar" readonly placeholder="METAR data will appear here..."></textarea>
        <div id="visualMetar" class="metar-visual-widget" style="display:none;">
            <div class="widget-header">
                <div class="flight-category" id="vMetarCat">VFR</div>
                <div class="temp-display"><span class="temp-icon">‚òÄÔ∏è</span><span id="vMetarTemp">--¬∞C</span></div>
            </div>
            <div class="weather-info">
                <div><span>üëÅÔ∏è</span> <span id="vMetarVis">-- km</span></div>
                <div><span>‚òÅÔ∏è</span> <span id="vMetarCloud">--</span></div>
            </div>
            <div class="compass-container">
                <canvas id="windCompass" width="200" height="200"></canvas>
            </div>
            <div class="wind-text" id="vMetarWind">---¬∞ -- kt</div>
        </div>
    </div>
</div>
</fieldset>

<fieldset>
<legend>Traffic & Circuit Availability</legend>
<div class="metar-row" style="border-top:none; margin-top:0;">
    <div class="metar-input-group">
        <label>Check Current Traffic</label>
        <button id="checkTrafficBtn" onclick="checkTraffic()">üì° Scan Circuit Traffic</button>
        <p style="font-size:11px; color:#666; margin-top:5px;">
            Scans live airspace via OpenSky Network. <br>Fallback estimates used if live data unavailable.
        </p>
    </div>
    <div class="metar-output">
        <div id="trafficWidget" class="traffic-widget" style="display:none;">
            <div class="radar-screen">
                <div class="radar-sweep"></div>
                </div>
            <div class="traffic-info">
                <div id="tfStatusTitle" class="traffic-status-title">Scanning...</div>
                <div id="tfSubtitle" class="traffic-subtitle">Analyzing airspace density...</div>
                <div id="tfSlots" class="traffic-slots">
                    Waiting for data...
                </div>
            </div>
        </div>
    </div>
</div>
</fieldset>

<fieldset>
<legend>Brakes / Runway / Temperature</legend>
<div class="row">
    <div class="field">
        <label>Brakes Off</label>
        <input id="brakesOff" placeholder="hh:mm">
    </div>
    <div class="field">
        <label>Brakes On</label>
        <input id="brakesOn" placeholder="hh:mm">
    </div>
    <div class="field">
        <label>Takeoff RWY / Wind / Temp</label>
        <input id="tkofInfo" placeholder="e.g. RWY 22 250/15 +20¬∞C" oninput="calculateRunwayComponents('tkof')">
        <div id="tkofCalc" class="calc-readout"></div>
    </div>
    <div class="field">
        <label>Landing RWY / Wind / Temp</label>
        <input id="ldgInfo" placeholder="e.g. RWY 04 040/10 +24¬∞C" oninput="calculateRunwayComponents('ldg')">
        <div id="ldgCalc" class="calc-readout"></div>
    </div>
</div>
</fieldset>

<fieldset>
<legend>Mass & Balance (Pipistrel Explorer)</legend>
<div class="mb-container">
    <div class="mb-inputs">
        <div class="mb-input-group">
            <div class="mb-input-header">
                <label>Empty Weight (kg)</label>
                <input type="number" id="mb_empty" value="371" readonly style="background:#f1f5f9; color:#64748b; border:none;">
            </div>
        </div>

        <div class="mb-input-group">
            <div class="mb-input-header">
                <label>Pilot (kg)</label>
                <input type="number" id="mb_pilot" value="60" min="0" max="120" oninput="syncMbSlider('mb_pilot', 'mb_pilot_range')">
            </div>
            <input type="range" id="mb_pilot_range" min="0" max="120" value="60" class="mb-slider slider-blue" oninput="syncMbNumber('mb_pilot', 'mb_pilot_range')">
        </div>

        <div class="mb-input-group">
            <div class="mb-input-header">
                <label>Co-Pilot (kg)</label>
                <input type="number" id="mb_copilot" value="80" min="0" max="120" oninput="syncMbSlider('mb_copilot', 'mb_copilot_range')">
            </div>
            <input type="range" id="mb_copilot_range" min="0" max="120" value="80" class="mb-slider slider-blue" oninput="syncMbNumber('mb_copilot', 'mb_copilot_range')">
        </div>

        <div class="mb-input-group">
            <div class="mb-input-header">
                <label>Fuel Left (L)</label>
                <input type="number" id="mb_fuelL" value="36" min="0" max="50" oninput="syncMbSlider('mb_fuelL', 'mb_fuelL_range')">
            </div>
            <input type="range" id="mb_fuelL_range" min="0" max="50" value="36" class="mb-slider slider-amber" oninput="syncMbNumber('mb_fuelL', 'mb_fuelL_range')">
        </div>

        <div class="mb-input-group">
            <div class="mb-input-header">
                <label>Fuel Right (L)</label>
                <input type="number" id="mb_fuelR" value="36" min="0" max="50" oninput="syncMbSlider('mb_fuelR', 'mb_fuelR_range')">
            </div>
            <input type="range" id="mb_fuelR_range" min="0" max="50" value="36" class="mb-slider slider-amber" oninput="syncMbNumber('mb_fuelR', 'mb_fuelR_range')">
        </div>

        <div class="mb-input-group">
            <div class="mb-input-header">
                <label>Baggage (kg)</label>
                <input type="number" id="mb_bag" value="10" min="0" max="25" oninput="syncMbSlider('mb_bag', 'mb_bag_range')">
            </div>
            <input type="range" id="mb_bag_range" min="0" max="25" value="10" class="mb-slider slider-purple" oninput="syncMbNumber('mb_bag', 'mb_bag_range')">
        </div>
        
        <table class="mb-table">
            <thead>
                <tr><th>Total Wt</th><th>Moment</th><th>CG (mm)</th></tr>
            </thead>
            <tbody>
                <tr>
                    <td id="mb_res_weight">593 kg</td>
                    <td id="mb_res_moment">--</td>
                    <td id="mb_res_cg" style="font-weight:bold; color:#005baa;">286</td>
                </tr>
            </tbody>
        </table>
        
        <div id="mb_status" class="mb-status mb-safe">WITHIN LIMITS</div>
    </div>
    
    <div class="mb-graph-container">
        <div id="mb_graph" style="width:100%; height:300px;"></div>
    </div>
</div>
</fieldset>

<button onclick="addRow()">‚ûï Add Waypoint</button>
<button onclick="calculateAll();">üß† Auto-Calculate</button>
<button id="reverseBtn" onclick="reverseRoute()">‚áÑ Reverse Route</button>
<button id="mapBtn" onclick="openMap()">üó∫Ô∏è Show Map</button>
<button onclick="manualSave()">üíæ Download Data</button>
<button onclick="manualLoad()">üìÇ Upload Data</button>
<button onclick="previewOverlay()">üëÄ Preview layout</button>
<button onclick="exportPDF()">üìÑ Print / PDF</button>
<button onclick="saveAsImage()" style="background: linear-gradient(to bottom, #8b5cf6, #7c3aed); box-shadow: 0 2px 4px rgba(139, 92, 246, 0.2);">üíæ Save Image (PNG)</button>

<div class="table-wrapper">
<table id="navlog">
<thead>
<tr>
    <th>FROM</th>
    <th>TO</th>
    <th>MSA</th>
    <th>ALT</th>
    <th>TAS</th>
    <th>TR (T)</th>
    <th>W/V (dir/spd)</th>
    <th>WCA</th>
    <th>HDG (T)</th>
    <th>HDG (M)</th>
    <th>G/S</th>
    <th>Dist</th>
    <th>Time</th>
    <th>ETA</th>
    <th>ATA</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div class="row" style="margin-top:10px;">
    <div style="flex:1;">
        <fieldset>
            <legend>Fuel Planning</legend>
            <table class="fuel-calc-table">
                <thead>
                    <tr><th>Item</th><th>Fuel (L)</th><th>Time (min)</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Taxi</td>
                        <td><input id="fuel_taxi" value="3" onchange="calculateAll()"></td>
                        <td>--</td>
                    </tr>
                    <tr>
                        <td>Trip</td>
                        <td><input id="fuel_trip" readonly></td>
                        <td><input id="time_trip" readonly></td>
                    </tr>
                    <tr>
                        <td>Contingency (5%)</td>
                        <td><input id="fuel_cont" readonly></td>
                        <td><input id="time_cont" readonly></td>
                    </tr>
                    <tr>
                        <td>Alternate</td>
                        <td><input id="fuel_alt" readonly></td>
                        <td><input id="time_alt" readonly></td>
                    </tr>
                    <tr>
                        <td>Final Reserve (45')</td>
                        <td><input id="fuel_res" readonly></td>
                        <td>45</td>
                    </tr>
                    <tr>
                        <td>Extra</td>
                        <td><input id="fuel_extra" readonly></td>
                        <td><input id="time_extra" readonly></td>
                    </tr>
                    <tr class="fuel-total-row">
                        <td>TOTAL REQUIRED</td>
                        <td><input id="fuel_min" readonly></td>
                        <td><input id="time_min" readonly></td>
                    </tr>
                    <tr>
                        <td style="border-top:2px solid #333; font-weight:bold;">BLOCK FUEL (FOB)</td>
                        <td style="border-top:2px solid #333;"><input id="fob" placeholder="Total L" style="background:#fff; border:1px solid #ccc; text-align:right; padding-right:4px;" onchange="calculateAll()"></td>
                        <td style="border-top:2px solid #333;"><input id="time_endurance" readonly style="font-weight:bold;"></td>
                    </tr>
                </tbody>
            </table>
        </fieldset>

        <fieldset>
            <legend>Stations</legend>
            <table id="stationsTable">
                <thead><tr><th>STATION</th><th>CRS</th><th>FREQ</th></tr></thead>
                <tbody>
                    <tr><td><input></td><td><input></td><td><input></td></tr>
                    <tr><td><input></td><td><input></td><td><input></td></tr>
                    <tr><td><input></td><td><input></td><td><input></td></tr>
                </tbody>
            </table>
        </fieldset>
    </div>
    <div style="flex:2%;">
        <fieldset>
            <legend>Clearance / Observations</legend>
            <textarea id="clearance"></textarea>
        </fieldset>
    </div>
</div>
</div> 
<div id="mapModal" class="map-modal">
    <div class="map-content">
        <button class="map-close" onclick="closeMap()">Close Map</button>
        <div id="map"></div>
    </div>
</div>

<div id="printSheetWrapper">
    <button id="overlayCloseBtn" type="button" onclick="closeOverlay()">Close Preview</button>
    <div id="printPagesContainer"></div>
</div>

<script>
/* ---------- JS Logic ---------- */
const STORAGE_KEY = 'dentoNavlogData';

// UPDATED WAYPOINTS WITH COORDINATES
const WAYPOINT_DATA = {
    "LCLK": '34¬∞52\'23.25"N 33¬∞37\'22.15"E',
    "LCPH": '34¬∞43\'4.14"N 32¬∞29\'1.83"E',
    "SALT LAKE": '34¬∞53\'36.04"N 33¬∞37\'36.58"E',
    "SIA": '34¬∞57\'17.88"N 33¬∞23\'22.33"E',
    "MOSFILOTI": '34¬∞57\'8.99"N 33¬∞25\'31.30"E',
    "KALOCHORIO": '34¬∞55\'40.29"N 33¬∞32\'11.60"E',
    "KALO CHORIO": '34¬∞55\'40.29"N 33¬∞32\'11.60"E',
    "ALAMPRA": '34¬∞59\'19.21"N 33¬∞24\'3.14"E',
    "MARKI": '35¬∞1\'25.36"N 33¬∞19\'33.79"E',
    "DIPOTAMOS DAM": '34¬∞51\'24.08"N 33¬∞21\'17.74"E',
    "KALAVASOS DAM": '34¬∞48\'16.26"N 33¬∞15\'25.48"E',
    "GERMASOGEIA DAM": '34¬∞44\'53.68"N 33¬∞5\'13.02"E',
    "KOURIS DAM": '34¬∞43\'40.06"N 32¬∞55\'5.51"E',
    "PACHNA": '34¬∞46\'41.27"N 32¬∞47\'35.00"E', 
    "TRACHYPEDOULA": '34¬∞48\'1.96"N 32¬∞40\'44.51"E',
    "ACHELEIA": '34¬∞44\'20.55"N 32¬∞29\'10.21"E',
    "ERGATES": '35¬∞3\'15.21"N 33¬∞14\'38.57"E',
    "TAMASOS DAM": '35¬∞0\'46.43"N 33¬∞14\'51.23"E',
    "KLIROU DAM": '35¬∞01\'18.00"N 33¬∞10\'38.00"E',
    "KILIROU DAM": '35¬∞1\'53.39"N 33¬∞10\'19.74"E',
    "MENIKO": '35¬∞6\'13.51"N 33¬∞8\'33.66"E'
};

const WAYPOINTS = Object.keys(WAYPOINT_DATA).sort();

/* --- TRAFFIC CHECKER (NEW) --- */
async function checkTraffic() {
    const dep = document.getElementById('from').value.toUpperCase().trim();
    if (dep.length < 4) { alert("Please enter a valid 4-letter ICAO departure."); return; }
    
    const widget = document.getElementById('trafficWidget');
    widget.style.display = 'flex';
    document.getElementById('tfStatusTitle').innerText = "Connecting to Satellite...";
    document.getElementById('tfStatusTitle').style.color = "#fbbf24"; // amber
    document.getElementById('tfSlots').innerText = "Querying OpenSky Network...";
    
    // Clear old blips
    const screen = document.querySelector('.radar-screen');
    const oldBlips = screen.querySelectorAll('.radar-blip');
    oldBlips.forEach(b => b.remove());

    // 1. Get Coordinates
    let coords = getLatLon(dep);
    // If not found in our waypoint list, default to LCLK for demo
    if (!coords) { coords = { lat: 34.87, lon: 33.62 }; } 

    // 2. Define Bounding Box (approx 0.1 degree radius ~ 6NM)
    const box = {
        lamin: coords.lat - 0.1,
        lamax: coords.lat + 0.1,
        lomin: coords.lon - 0.1,
        lomax: coords.lon + 0.1
    };

    // 3. OpenSky API (Free)
    const url = `https://opensky-network.org/api/states/all?lamin=${box.lamin}&lomin=${box.lomin}&lamax=${box.lamax}&lomax=${box.lomax}`;
    // Use CorsProxy for speed
    const proxy = `https://corsproxy.io/?${encodeURIComponent(url)}`;

    try {
        // Use timeout to fallback quickly if API is slow
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 6000); // 6 sec timeout

        const resp = await fetch(proxy, { signal: controller.signal });
        clearTimeout(timeoutId);
        
        let count = 0;
        if (resp.ok) {
            const data = await resp.json();
            if (data.states) count = data.states.length;
            updateTrafficUI(count, true);
        } else {
            throw new Error("API Limit");
        }
    } catch (e) {
        console.warn("Traffic API failed, using estimator fallback", e);
        // Fallback: Estimate based on Time of Day
        const hour = new Date().getHours();
        // Busy: 08-11 and 15-18
        let mockCount = (hour >= 8 && hour <= 11) || (hour >= 15 && hour <= 18) ? 4 : 1; 
        updateTrafficUI(mockCount, false);
    }
}

function updateTrafficUI(count, isReal) {
    const title = document.getElementById('tfStatusTitle');
    const sub = document.getElementById('tfSubtitle');
    const slots = document.getElementById('tfSlots');
    const screen = document.querySelector('.radar-screen');

    // Add Blips visually
    for(let i=0; i<count; i++) {
        const blip = document.createElement('div');
        blip.className = 'radar-blip';
        // Random position within circle
        const angle = Math.random() * 360;
        const dist = Math.random() * 40 + 10; // 10px to 50px from center
        blip.style.top = `calc(50% + ${Math.sin(angle)*dist}px)`;
        blip.style.left = `calc(50% + ${Math.cos(angle)*dist}px)`;
        screen.appendChild(blip);
    }

    if (count >= 3) {
        title.innerText = `‚ö†Ô∏è HIGH TRAFFIC (${count} aircraft)`;
        title.className = "traffic-status-title status-bad";
        sub.innerText = isReal ? "Live radar indicates circuit saturation." : "Estimated peak hours. Circuits likely unavailable.";
        
        // Suggest Slots
        const now = new Date();
        const nextSlot = new Date(now.getTime() + 90*60000); // +90 mins
        const hh = String(nextSlot.getHours()).padStart(2,'0');
        const mm = String(nextSlot.getMinutes()).padStart(2,'0');
        
        slots.innerHTML = `<strong>‚õî CIRCUITS NOT RECOMMENDED</strong><br>Airport is crowded. Best alternative time: <strong>${hh}:${mm} LT</strong>`;
    } else {
        title.innerText = `‚úÖ LOW TRAFFIC (${count} aircraft)`;
        title.className = "traffic-status-title status-good";
        sub.innerText = isReal ? "Live radar shows clear airspace." : "Estimated quiet hours.";
        slots.innerHTML = `<strong>üöÄ GOOD FOR CIRCUITS</strong><br>Airspace is relatively empty. Proceed with caution.`;
    }
}

/* --- COORDINATE UTILITIES --- */
function parseCoordinate(coordStr) {
    const regex = /(\d+)¬∞\s*(\d+)'\s*([\d.]+)"([NSEW])/;
    const parts = coordStr.match(regex);
    if (!parts) return null;
    const deg = parseFloat(parts[1]);
    const min = parseFloat(parts[2]);
    const sec = parseFloat(parts[3]);
    const dir = parts[4];
    let decimal = deg + (min / 60) + (sec / 3600);
    if (dir === 'S' || dir === 'W') decimal *= -1;
    return decimal;
}

function getLatLon(wpName) {
    // Case insensitive match
    const key = Object.keys(WAYPOINT_DATA).find(k => k.toUpperCase() === wpName.toUpperCase());
    if (!key) return null;
    const raw = WAYPOINT_DATA[key];
    const [latStr, lonStr] = raw.split(/\s+(?=\d)/); 
    if (!latStr || !lonStr) return null;
    return { lat: parseCoordinate(latStr.trim()), lon: parseCoordinate(lonStr.trim()) };
}

function calculateDistance(coord1, coord2) {
    const R = 3440.065; // Radius of Earth in NM
    const dLat = deg2rad(coord2.lat - coord1.lat);
    const dLon = deg2rad(coord2.lon - coord1.lon);
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(deg2rad(coord1.lat)) * Math.cos(deg2rad(coord2.lat)) * Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function calculateBearing(coord1, coord2) {
    const y = Math.sin(deg2rad(coord2.lon - coord1.lon)) * Math.cos(deg2rad(coord2.lat));
    const x = Math.cos(deg2rad(coord1.lat)) * Math.sin(deg2rad(coord2.lat)) -
              Math.sin(deg2rad(coord1.lat)) * Math.cos(deg2rad(coord2.lat)) * Math.cos(deg2rad(coord2.lon - coord1.lon));
    let brng = rad2deg(Math.atan2(y, x));
    return (brng + 360) % 360;
}

/* --- AUTO ALTERNATE LOGIC --- */
function suggestAlternate() {
    const toVal = document.getElementById('to').value.toUpperCase().trim();
    let altVal = "";
    
    if (toVal === "LCLK") altVal = "LCPH";
    else if (toVal === "LCPH") altVal = "LCLK";
    
    if (altVal) {
        document.getElementById('alt').value = altVal;
        const c1 = getLatLon(toVal);
        const c2 = getLatLon(altVal);
        if(c1 && c2) {
            const dist = calculateDistance(c1, c2);
            document.getElementById('altDist').value = dist.toFixed(1);
        }
    }
    calculateAll();
}

/* --- METAR FETCHER --- */
async function getMetar() {
    const icao = document.getElementById('metarIcao').value.toUpperCase().trim();
    const metarOutput = document.getElementById('rawMetar');
    const button = document.getElementById('fetchMetarBtn');

    if (icao.length !== 4) { metarOutput.value = "Error: Invalid ICAO."; return; }
    
    button.textContent = "Fetching..."; button.disabled = true;
    metarOutput.value = "Fetching METAR for " + icao + "...";

    const targetUrl = `https://aviationweather.gov/api/data/metar?ids=${icao}&format=json`;
    const ts = new Date().getTime();
    
    // Robust Proxy Chain
    const proxies = [
        { url: `https://corsproxy.io/?${encodeURIComponent(targetUrl)}&_t=${ts}`, type: 'direct' },
        { url: `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}&_t=${ts}`, type: 'direct' },
        { url: `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}&_t=${ts}`, type: 'allorigins' }
    ];

    let success = false;

    // Helper timeout
    const fetchWithTimeout = (url, timeoutMs) => Promise.race([
        fetch(url), new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), timeoutMs))
    ]);

    for (const proxy of proxies) {
        try {
            const resp = await fetchWithTimeout(proxy.url, 10000);
            if (!resp.ok) continue; 
            
            let data;
            if (proxy.type === 'allorigins') {
                const wrapper = await resp.json();
                data = JSON.parse(wrapper.contents);
            } else {
                data = await resp.json();
            }
            
            let fetchedData = null;
            if (Array.isArray(data) && data.length > 0) fetchedData = data[0].rawOb;
            else if (typeof data === 'object' && data.rawOb) fetchedData = data.rawOb;
            
            if (fetchedData) {
                metarOutput.value = fetchedData;
                parseAndRenderMetar(fetchedData);
                success = true;
                break;
            } else {
                 metarOutput.value = `No METAR found for ${icao}.`; 
                 success = true; 
                 break;
            }
        } catch (error) { console.warn("Proxy failed", error); }
    }
    if (!success) metarOutput.value = "Error: Network/CORS issue.";
    button.textContent = "‚òÅÔ∏è Get Live METAR"; button.disabled = false; autoSave();
}

function parseAndRenderMetar(raw) {
    const widget = document.getElementById('visualMetar');
    widget.style.display = 'flex';
    let windDir = 0, windSpd = 0, vis = 9999, temp = 0, clouds = "Clear", flightCat = "VFR";
    
    const windMatch = raw.match(/\b(\d{3}|VRB)(\d{2,3})(?:G(\d{2,3}))?KT\b/);
    if (windMatch) {
        windDir = (windMatch[1] === "VRB") ? 0 : parseInt(windMatch[1]);
        windSpd = parseInt(windMatch[2]);
        document.getElementById('vMetarWind').textContent = `${windMatch[1] === "VRB" ? "VRB" : windDir.toString().padStart(3,'0')}¬∞ ${windSpd} kt`;
    }
    if (raw.includes("CAVOK")) { vis = 10000; document.getElementById('vMetarVis').textContent = "10 km+"; }
    else {
        const visMatch = raw.match(/\b(\d{4})\b/);
        if (visMatch) { let v = parseInt(visMatch[1]); vis = v; document.getElementById('vMetarVis').textContent = (v === 9999) ? "10 km+" : `${v} m`; }
    }
    const cloudMatch = raw.match(/(FEW|SCT|BKN|OVC|VV)(\d{3})/);
    if (raw.includes("CAVOK") || raw.includes("SKC") || raw.includes("NSC")) clouds = "None";
    else if (cloudMatch) clouds = `${cloudMatch[1]} ${parseInt(cloudMatch[2])*100} ft`;
    document.getElementById('vMetarCloud').textContent = clouds;

    const tempMatch = raw.match(/\b(M?\d{2})\/(M?\d{2})\b/);
    if (tempMatch) { temp = parseInt(tempMatch[1].replace('M','-')); document.getElementById('vMetarTemp').textContent = `${temp}¬∞C`; }

    let isIfr = false;
    if (vis < 5000) isIfr = true;
    if (cloudMatch && (cloudMatch[1] === "BKN" || cloudMatch[1] === "OVC")) { if (parseInt(cloudMatch[2]) * 100 < 1500) isIfr = true; }
    
    const catEl = document.getElementById('vMetarCat');
    catEl.textContent = isIfr ? "IFR" : "VFR";
    catEl.className = isIfr ? "flight-category ifr" : "flight-category";

    drawCompass(windDir, windSpd, windMatch && windMatch[1] === "VRB");
}

function drawCompass(windDir, windSpd, isVrb) {
    const canvas = document.getElementById('windCompass');
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height, cx = w/2, cy = h/2, r = w/2 - 20;
    ctx.clearRect(0,0,w,h);
    ctx.strokeStyle = "rgba(255,255,255,0.4)"; ctx.lineWidth = 2;
    for(let i=0; i<360; i+=10) {
        ctx.save(); ctx.translate(cx, cy); ctx.rotate(i * Math.PI/180);
        let len = (i % 90 === 0) ? 10 : 5; if(i % 30 === 0) len = 8;
        ctx.beginPath(); ctx.moveTo(0, -r); ctx.lineTo(0, -r + len); ctx.stroke(); ctx.restore();
    }
    ctx.fillStyle = "rgba(255,255,255,0.8)"; ctx.font = "bold 14px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
    const labelR = r - 20;
    ctx.fillText("N", cx, cy - labelR); ctx.fillText("S", cx, cy + labelR); ctx.fillText("E", cx + labelR, cy); ctx.fillText("W", cx - labelR, cy);
    ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(cx, cy, 3, 0, Math.PI*2); ctx.fill();
    if (windSpd > 0 && !isVrb) {
        ctx.save(); ctx.translate(cx, cy); ctx.rotate((windDir) * Math.PI/180);
        ctx.beginPath(); ctx.moveTo(0, -20); ctx.lineTo(-6, -35); ctx.lineTo(6, -35); ctx.closePath(); ctx.fillStyle = "white"; ctx.fill();
        ctx.beginPath(); ctx.moveTo(0, -35); ctx.lineTo(0, -r + 10); ctx.lineWidth = 4; ctx.strokeStyle = "white"; ctx.stroke(); ctx.restore();
    }
}

/* --- MASS & BALANCE CALCULATOR --- */
const MB_CONSTANTS = {
    arm_empty: 245, arm_pilot: 370, arm_copilot: 370, arm_fuel: 215, arm_baggage: 1160,
    mac: 898, r: 43, minCG: 267, maxCG: 356, maxWeight: 600, kneeWeight: 480, fwdLimitTop: 295
};

function syncMbNumber(numId, rangeId) {
    const range = document.getElementById(rangeId);
    const num = document.getElementById(numId);
    num.value = range.value;
    calculateMassBalance();
}

function syncMbSlider(numId, rangeId) {
    const range = document.getElementById(rangeId);
    const num = document.getElementById(numId);
    range.value = num.value;
    calculateMassBalance();
}

function calculateMassBalance() {
    const emptyW = parseFloat(document.getElementById('mb_empty').value) || 371;
    const pilot = parseFloat(document.getElementById('mb_pilot').value) || 0;
    const copilot = parseFloat(document.getElementById('mb_copilot').value) || 0;
    const fuelL = parseFloat(document.getElementById('mb_fuelL').value) || 0;
    const fuelR = parseFloat(document.getElementById('mb_fuelR').value) || 0;
    const bag = parseFloat(document.getElementById('mb_bag').value) || 0;

    const fuelTotal = fuelL + fuelR;
    const totalWeight = emptyW + pilot + copilot + fuelTotal + bag;
    const moment = (emptyW * MB_CONSTANTS.arm_empty) + ((pilot + copilot) * MB_CONSTANTS.arm_pilot) +
                    (fuelTotal * MB_CONSTANTS.arm_fuel) + (bag * MB_CONSTANTS.arm_baggage);
    
    const cg = totalWeight > 0 ? moment / totalWeight : 0;
    const macPercent = (100 * ((cg - MB_CONSTANTS.r) / MB_CONSTANTS.mac));

    document.getElementById('mb_res_weight').textContent = totalWeight + " kg";
    document.getElementById('mb_res_moment').textContent = Math.round(moment);
    document.getElementById('mb_res_cg').textContent = cg.toFixed(0) + " mm (" + macPercent.toFixed(1) + "% MAC)";

    let isWeightOk = totalWeight <= MB_CONSTANTS.maxWeight;
    let allowedMinCG = MB_CONSTANTS.minCG;

    if (totalWeight > MB_CONSTANTS.kneeWeight) {
        const dy = MB_CONSTANTS.maxWeight - MB_CONSTANTS.kneeWeight;
        const dx = MB_CONSTANTS.fwdLimitTop - MB_CONSTANTS.minCG;
        const weightAbove = totalWeight - MB_CONSTANTS.kneeWeight;
        allowedMinCG = MB_CONSTANTS.minCG + (weightAbove * (dx / dy));
    }
    
    const isCgOk = cg >= allowedMinCG && cg <= MB_CONSTANTS.maxCG;
    const statusDiv = document.getElementById('mb_status');
    
    if (isWeightOk && isCgOk) {
        statusDiv.className = "mb-status mb-safe"; statusDiv.textContent = "WITHIN LIMITS";
    } else {
        statusDiv.className = "mb-status mb-unsafe"; statusDiv.textContent = "OUTSIDE ENVELOPE";
    }

    drawMBGraph(cg, totalWeight, isWeightOk && isCgOk);
    autoSave();
}

function drawMBGraph(cg, weight, isSafe) {
    const container = document.getElementById('mb_graph');
    if (!container) return;
    
    const getX = (val) => ((val - 220) / (400 - 220)) * 100;
    const getY = (val) => 100 - ((val - 320) / (620 - 320)) * 100;
    
    const p1 = `${getX(MB_CONSTANTS.minCG)},${getY(410)}`; 
    const p2 = `${getX(MB_CONSTANTS.minCG)},${getY(MB_CONSTANTS.kneeWeight)}`; 
    const p3 = `${getX(MB_CONSTANTS.fwdLimitTop)},${getY(MB_CONSTANTS.maxWeight)}`; 
    const p4 = `${getX(MB_CONSTANTS.maxCG)},${getY(MB_CONSTANTS.maxWeight)}`; 
    const p5 = `${getX(MB_CONSTANTS.maxCG)},${getY(410)}`; 
    
    const curX = getX(cg);
    const curY = getY(weight);
    const dotColor = isSafe ? "#2563eb" : "#dc2626";

    const svgHtml = `
    <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none">
        ${[240,260,280,300,320,340,360,380].map(x => `<line x1="${getX(x)}" y1="0" x2="${getX(x)}" y2="100" stroke="#e2e8f0" stroke-width="0.3" /><text x="${getX(x)}" y="98" font-size="3" fill="#94a3b8" text-anchor="middle">${x}</text>`).join('')}
        ${[350,400,450,500,550,600].map(y => `<line x1="0" y1="${getY(y)}" x2="100" y2="${getY(y)}" stroke="#e2e8f0" stroke-width="0.3" /><text x="1" y="${getY(y)+1}" font-size="3" fill="#94a3b8">${y}</text>`).join('')}
        <polygon points="${p1} ${p2} ${p3} ${p4} ${p5}" fill="rgba(16, 185, 129, 0.1)" stroke="#ef4444" stroke-width="0.8" />
        <line x1="${curX}" y1="${curY}" x2="${curX}" y2="100" stroke="${dotColor}" stroke-width="0.4" stroke-dasharray="2" opacity="0.6"/>
        <line x1="0" y1="${curY}" x2="${curX}" y2="${curY}" stroke="${dotColor}" stroke-width="0.4" stroke-dasharray="2" opacity="0.6"/>
        <circle cx="${curX}" cy="${curY}" r="2" fill="${dotColor}" stroke="white" stroke-width="0.5" class="graph-dot" style="animation: pulse-dot 2s infinite;" />
    </svg>
    `;
    container.innerHTML = svgHtml;
}

/* --- COMMON LOGIC --- */
function getCellValue(row, col) {
    const cell = row.children[col]; if (!cell) return "";
    let el = cell.querySelector("input, textarea"); if (el) return el.value || "";
    el = cell.querySelector("select"); if (el) return el.value || ""; return "";
}
function setCellValue(row, col, value) {
    const cell = row.children[col]; if (!cell) return;
    let input = cell.querySelector("input, textarea");
    if (col >= 7 && col <= 10 || col === 12 || col === 13) { cell.classList.add('calculated-flash'); setTimeout(() => cell.classList.remove('calculated-flash'), 600); }
    if (input) input.value = value || "";
    const sel = cell.querySelector("select");
    if (sel) { let found = false; for (const opt of sel.options) { if (opt.value === value || opt.text === value) { sel.value = opt.value; found = true; break; } } if (!found) sel.value = ""; }
}
function handleWpSelectChange(sel) {
    const text = sel.value; const input = sel.nextElementSibling; if (input) input.value = text;
    const row = sel.closest("tr"); if (!row) return; calculateLeg(row);
}
function calculateLeg(row) {
    const fromVal = getCellValue(row, 0); const toVal = getCellValue(row, 1);
    if (fromVal && toVal) {
        const c1 = getLatLon(fromVal); const c2 = getLatLon(toVal);
        if (c1 && c2) {
            const dist = calculateDistance(c1, c2); const tr = calculateBearing(c1, c2);
            setCellValue(row, 5, Math.round(tr)); setCellValue(row, 11, dist.toFixed(1)); calculateAll();
        }
    }
}
function createWpOptions() { return WAYPOINTS.map(wp => `<option value="${wp}">${wp}</option>`).join(''); }
function addRow() {
    const wpOptions = createWpOptions();
    const rowHTML = `<tr><td><div class="wpField"><select onchange="handleWpSelectChange(this); autoSave();"><option value=""></option>${wpOptions}</select><input oninput="autoSave()"></div></td><td><div class="wpField"><select onchange="handleWpSelectChange(this); autoSave();"><option value=""></option>${wpOptions}</select><input oninput="autoSave()"></div></td><td><input type="number" min="0" oninput="autoSave()"></td><td><input type="number" min="0" oninput="autoSave()"></td><td><input type="number" min="0" value="95" oninput="autoSave()"></td><td><input type="number" min="0" max="360" oninput="autoSave()"></td><td><input placeholder="ddd/ss" oninput="autoSave()"></td><td><input readonly></td><td><input readonly></td><td><input readonly></td><td><input readonly></td><td><input type="number" min="0" oninput="autoSave()"></td><td><input readonly></td><td><input readonly></td><td><input oninput="autoSave()"></td></tr>`;
    document.querySelector("#navlog tbody").insertAdjacentHTML("beforeend", rowHTML);
    setupAutoSaveListeners(document.querySelector("#navlog tbody tr:last-child")); autoSave();
}
function deg2rad(d){ return d * Math.PI / 180; }
function rad2deg(r){ return r * 180 / Math.PI; }
function calculateAll() {
    const variation = parseFloat(document.getElementById("variation").value) || 0;
    const fuelburn = parseFloat(document.getElementById("fuelburn").value) || 0;
    const depTimeStr = document.getElementById("depTime").value || "08:00";
    let rows = document.querySelectorAll("#navlog tbody tr");
    let cumulativeMinutes = 0, totalDist = 0, totalTimeMin = 0;
    rows.forEach(row => {
        const TAS = parseFloat(getCellValue(row, 4)) || 0;
        const TR = parseFloat(getCellValue(row, 5)) || 0;
        const windStr = getCellValue(row, 6).trim();
        const dist = parseFloat(getCellValue(row, 11)) || 0;
        let wDir = 0, wSpd = 0;
        if (windStr.includes("/")) { const parts = windStr.split("/"); wDir = parseFloat(parts[0]) || 0; wSpd = parseFloat(parts[1]) || 0; }
        let rel = deg2rad(wDir - TR);
        let WCA = 0; if (TAS > 0) { let x = (wSpd / TAS) * Math.sin(rel); if (x > 1) x = 1; if (x < -1) x = -1; WCA = rad2deg(Math.asin(x)); }
        let HDG_T = (TR + WCA + 360) % 360;
        let GS = TAS - wSpd * Math.cos(rel); if (!isFinite(GS) || GS <= 0) GS = TAS;
        let legMin = 0; if (GS > 0 && dist > 0) legMin = dist / GS * 60;
        cumulativeMinutes += legMin; totalDist += dist; totalTimeMin += legMin;
        const eta = computeETA(depTimeStr, cumulativeMinutes);
        let HDG_M = (HDG_T - variation + 360) % 360;
        setCellValue(row, 7, WCA.toFixed(1)); setCellValue(row, 8, HDG_T.toFixed(0)); setCellValue(row, 9, HDG_M.toFixed(0)); setCellValue(row,10, GS.toFixed(0)); setCellValue(row,12, legMin ? legMin.toFixed(0) + " min" : ""); setCellValue(row,13, eta);
    });
    document.getElementById("totalDist").value = totalDist.toFixed(1);
    const totalHours = Math.floor(totalTimeMin / 60); const totalMins = Math.round(totalTimeMin % 60);
    document.getElementById("plannedTime").value = String(totalHours).padStart(2,'0') + ":" + String(totalMins).padStart(2,'0');
    
    // Fuel Calcs
    const fob = parseFloat(document.getElementById('fob').value) || 0;
    const taxiFuel = parseFloat(document.getElementById('fuel_taxi').value) || 3;
    const tripMin = totalTimeMin; const tripFuel = (tripMin / 60) * fuelburn;
    const contMin = Math.max(tripMin * 0.05, 5); const contFuel = (contMin / 60) * fuelburn;
    const altDist = parseFloat(document.getElementById('altDist').value) || 0;
    const altMin = (altDist / 95) * 60; const altFuel = (altMin / 60) * fuelburn;
    const resMin = 45; const resFuel = (resMin / 60) * fuelburn;
    const minReqFuel = taxiFuel + tripFuel + contFuel + altFuel + resFuel;
    const extraFuel = Math.max(0, fob - minReqFuel); const extraTime = (extraFuel / fuelburn) * 60;
    const totalEnduranceTime = (fob / fuelburn) * 60;
    
    const fmt = (n) => n.toFixed(1); const fmtTime = (n) => Math.round(n);
    document.getElementById('fuel_trip').value = fmt(tripFuel); document.getElementById('time_trip').value = fmtTime(tripMin);
    document.getElementById('fuel_cont').value = fmt(contFuel); document.getElementById('time_cont').value = fmtTime(contMin);
    document.getElementById('fuel_alt').value = fmt(altFuel); document.getElementById('time_alt').value = fmtTime(altMin);
    document.getElementById('fuel_res').value = fmt(resFuel);
    document.getElementById('fuel_extra').value = fmt(extraFuel); document.getElementById('time_extra').value = fmtTime(extraTime);
    document.getElementById('fuel_min').value = fmt(minReqFuel);
    if(fob > 0) { const eh = Math.floor(totalEnduranceTime / 60); const em = Math.round(totalEnduranceTime % 60); document.getElementById('time_endurance').value = `${eh}:${String(em).padStart(2,'0')}`; } else { document.getElementById('time_endurance').value = "--:--"; }
    autoSave();
}
function computeETA(depTimeStr, addedMin) {
    const [h,m] = depTimeStr.split(":").map(x => parseInt(x) || 0);
    const base = new Date("2025-01-01T00:00:00"); base.setHours(h,m,0,0); base.setMinutes(base.getMinutes() + addedMin);
    const hh = String(base.getHours()).padStart(2,"0"); const mm = String(base.getMinutes()).padStart(2,"0"); return `${hh}:${mm}`;
}
function autoSave() {
    const data = {
        top: {
            pilot: document.getElementById("pilot").value, acreg: document.getElementById("acreg").value, from: document.getElementById("from").value, to: document.getElementById("to").value, plannedTime: document.getElementById("plannedTime").value, alt: document.getElementById("alt").value, altDist: document.getElementById("altDist").value, depTime: document.getElementById("depTime").value, variation: document.getElementById("variation").value, fuelburn: document.getElementById("fuelburn").value, brakesOff: document.getElementById("brakesOff").value, brakesOn: document.getElementById("brakesOn").value, tkofInfo: document.getElementById("tkofInfo").value, ldgInfo: document.getElementById("ldgInfo").value, fob: document.getElementById("fob").value, clearance: document.getElementById("clearance").value, metarIcao: document.getElementById("metarIcao").value, rawMetar: document.getElementById("rawMetar").value, fuel_taxi: document.getElementById('fuel_taxi').value,
            mb_pilot: document.getElementById('mb_pilot').value, mb_copilot: document.getElementById('mb_copilot').value, mb_fuelL: document.getElementById('mb_fuelL').value, mb_fuelR: document.getElementById('mb_fuelR').value, mb_bag: document.getElementById('mb_bag').value
        }, rows: [], stations: []
    };
    document.querySelectorAll("#navlog tbody tr").forEach(r => { const rowData = []; for (let i = 0; i < r.children.length; i++) rowData.push(getCellValue(r, i)); data.rows.push(rowData); });
    document.querySelectorAll("#stationsTable tbody tr").forEach(r => { data.stations.push(Array.from(r.children).map(c => { const inp = c.querySelector("input"); return inp ? inp.value : ""; })); });
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch (e) { console.error("Save error", e); }
}
function createNavlogRowHtml() {
    const wpOptions = createWpOptions();
    return `<tr><td><div class="wpField"><select onchange="handleWpSelectChange(this); autoSave();"><option value=""></option>${wpOptions}</select><input oninput="autoSave()"></div></td><td><div class="wpField"><select onchange="handleWpSelectChange(this); autoSave();"><option value=""></option>${wpOptions}</select><input oninput="autoSave()"></div></td><td><input type="number" min="0" oninput="autoSave()"></td><td><input type="number" min="0" oninput="autoSave()"></td><td><input type="number" min="0" value="95" oninput="autoSave()"></td><td><input type="number" min="0" max="360" oninput="autoSave()"></td><td><input placeholder="ddd/ss" oninput="autoSave()"></td><td><input readonly></td><td><input readonly></td><td><input readonly></td><td><input readonly></td><td><input type="number" min="0" oninput="autoSave()"></td><td><input readonly></td><td><input readonly></td><td><input oninput="autoSave()"></td></tr>`;
}
function loadDataToForm(data) {
    const t = data.top || {};
    document.getElementById("pilot").value = t.pilot || ""; document.getElementById("acreg").value = t.acreg || ""; document.getElementById("from").value = t.from || ""; document.getElementById("to").value = t.to || ""; document.getElementById("plannedTime").value = t.plannedTime || ""; document.getElementById("alt").value = t.alt || ""; document.getElementById("altDist").value = t.altDist || ""; document.getElementById("depTime").value = t.depTime || "08:00"; document.getElementById("variation").value = t.variation || "4"; document.getElementById("fuelburn").value = t.fuelburn || "10"; document.getElementById("brakesOff").value = t.brakesOff || ""; document.getElementById("brakesOn").value = t.brakesOn || ""; document.getElementById("tkofInfo").value = t.tkofInfo || ""; document.getElementById("ldgInfo").value = t.ldgInfo || ""; document.getElementById("fob").value = t.fob || ""; document.getElementById("clearance").value = t.clearance || ""; document.getElementById("metarIcao").value = t.metarIcao || ""; document.getElementById("rawMetar").value = t.rawMetar || "";
    if(t.fuel_taxi) document.getElementById('fuel_taxi').value = t.fuel_taxi;
    if(t.mb_pilot) { document.getElementById('mb_pilot').value = t.mb_pilot; document.getElementById('mb_pilot_range').value = t.mb_pilot; }
    if(t.mb_copilot) { document.getElementById('mb_copilot').value = t.mb_copilot; document.getElementById('mb_copilot_range').value = t.mb_copilot; }
    if(t.mb_fuelL) { document.getElementById('mb_fuelL').value = t.mb_fuelL; document.getElementById('mb_fuelL_range').value = t.mb_fuelL; }
    if(t.mb_fuelR) { document.getElementById('mb_fuelR').value = t.mb_fuelR; document.getElementById('mb_fuelR_range').value = t.mb_fuelR; }
    if(t.mb_bag) { document.getElementById('mb_bag').value = t.mb_bag; document.getElementById('mb_bag_range').value = t.mb_bag; }
    calculateMassBalance();
    if (t.rawMetar) setTimeout(() => parseAndRenderMetar(t.rawMetar), 100);
    const tbody = document.querySelector("#navlog tbody"); tbody.innerHTML = "";
    (data.rows || []).forEach(rowArr => { tbody.insertAdjacentHTML("beforeend", createNavlogRowHtml()); const last = tbody.querySelector("tr:last-child"); rowArr.forEach((val, i) => setCellValue(last, i, val)); });
    const stationRows = document.querySelectorAll("#stationsTable tbody tr");
    (data.stations || []).forEach((rowArr, rowIndex) => { if (stationRows[rowIndex]) rowArr.forEach((val, colIndex) => { const inp = stationRows[rowIndex].children[colIndex].querySelector("input"); if (inp) inp.value = val; }); });
    calculateAll();
}
function autoLoad() { try { const savedData = localStorage.getItem(STORAGE_KEY); if (!savedData) return false; loadDataToForm(JSON.parse(savedData)); return true; } catch (e) { return false; } }
function manualSave() { autoSave(); const data = JSON.parse(localStorage.getItem(STORAGE_KEY)); const pilotName = (document.getElementById("pilot").value || "Pilot").replace(/[^a-z0-9]/gi, '_'); const reg = (document.getElementById("acreg").value || "Reg").replace(/[^a-z0-9]/gi, '_'); const date = new Date().toISOString().slice(0, 10); const filename = `Navlog_${pilotName}_${reg}_${date}.json`; const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"}); const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
function manualLoad() { const input = document.createElement("input"); input.type = "file"; input.accept = ".json"; input.onchange = e => { const file = e.target.files[0]; const reader = new FileReader(); reader.onload = () => { loadDataToForm(JSON.parse(reader.result)); setupAutoSaveListeners(); autoSave(); }; reader.readAsText(file); }; input.click(); }
function setupAutoSaveListeners(root = document) { const inputs = root.querySelectorAll('input:not([readonly]):not([type="hidden"]), textarea, select'); inputs.forEach(input => { input.removeEventListener('input', autoSave); input.removeEventListener('change', autoSave); if (input.tagName === 'SELECT') input.addEventListener('change', autoSave); else input.addEventListener('input', autoSave); }); }
function reverseRoute() {
    if (!confirm("Are you sure you want to reverse the route?")) return;
    const tbody = document.querySelector("#navlog tbody");
    const rows = Array.from(tbody.children);
    let legData = rows.map(row => ({
        from: getCellValue(row, 0), to: getCellValue(row, 1), msa: getCellValue(row, 2), alt: getCellValue(row, 3), tas: getCellValue(row, 4), tr: parseFloat(getCellValue(row, 5)) || 0, wind: getCellValue(row, 6), dist: parseFloat(getCellValue(row, 11)) || 0
    })).reverse().map(leg => {
        const originalFrom = leg.from; leg.from = leg.to; leg.to = originalFrom;
        const c1 = getLatLon(leg.from); const c2 = getLatLon(leg.to);
        if (!c1 || !c2) leg.tr = (leg.tr + 180) % 360; 
        return leg;
    });
    tbody.innerHTML = "";
    legData.forEach(data => {
        tbody.insertAdjacentHTML("beforeend", createNavlogRowHtml());
        const row = tbody.lastElementChild;
        updateCellWithSelect(row, 0, data.from); updateCellWithSelect(row, 1, data.to); setCellValue(row, 2, data.msa); setCellValue(row, 3, data.alt); setCellValue(row, 4, data.tas); setCellValue(row, 6, data.wind); setCellValue(row, 5, Math.round(data.tr)); setCellValue(row, 11, data.dist);
        calculateLeg(row);
    });
    if (legData.length > 0) { document.getElementById("from").value = legData[0].from; document.getElementById("to").value = legData[legData.length - 1].to; }
    calculateAll();
}
function updateCellWithSelect(row, col, value) { const cell = row.children[col]; const input = cell.querySelector("input"); const select = cell.querySelector("select"); if (input) input.value = value; if (select) select.value = value; }
function calculateRunwayComponents(type) {
    const inputId = type === 'tkof' ? 'tkofInfo' : 'ldgInfo'; const outputId = type === 'tkof' ? 'tkofCalc' : 'ldgCalc'; const raw = document.getElementById(inputId).value; const outDiv = document.getElementById(outputId);
    const rwyMatch = raw.match(/(?:RWY|Rwy|Runway)\s?(\d{2})/); const windMatch = raw.match(/(\d{3})\/(\d{1,3})/);
    if (rwyMatch && windMatch) {
        const rwyHdg = parseInt(rwyMatch[1]) * 10; const windDir = parseInt(windMatch[1]); const windSpd = parseInt(windMatch[2]);
        const diff = Math.abs(windDir - rwyHdg) * (Math.PI / 180); const hw = Math.round(Math.cos(diff) * windSpd); const xw = Math.round(Math.abs(Math.sin(diff) * windSpd));
        const limit = 15; const isDanger = xw > limit;
        let text = `HW: ${hw}kt | XW: ${xw}kt`; if (isDanger) text = `‚ö†Ô∏è XW: ${xw}kt (LIMIT EXCEEDED)`;
        outDiv.textContent = text; outDiv.className = isDanger ? "calc-readout danger" : "calc-readout";
    } else { outDiv.textContent = ""; }
}

/* --- MAP FUNCTIONS --- */
let mapInstance = null;
let mapLayers = [];

function openMap() {
    const modal = document.getElementById('mapModal');
    modal.style.display = 'flex';
    
    if (!mapInstance) {
        // Init map centered on Cyprus
        mapInstance = L.map('map').setView([35.00, 33.30], 9);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
        }).addTo(mapInstance);
    }
    setTimeout(() => {
        mapInstance.invalidateSize();
        plotRouteOnMap(); 
    }, 200);
}

function closeMap() {
    document.getElementById('mapModal').style.display = 'none';
}

function plotRouteOnMap() {
    mapLayers.forEach(l => mapInstance.removeLayer(l));
    mapLayers = [];
    const routeCoords = [];
    const rows = document.querySelectorAll("#navlog tbody tr");
    const plottedMarkers = new Set(); 
    const addMarker = (coords, label) => {
        const key = label.toUpperCase(); 
        if (plottedMarkers.has(key)) return;
        const m = L.marker([coords.lat, coords.lon]).bindPopup(`<b>${label}</b>`).addTo(mapInstance);
        mapLayers.push(m);
        plottedMarkers.add(key);
    };
    rows.forEach((row, index) => {
        const fromVal = getCellValue(row, 0); 
        const toVal = getCellValue(row, 1);   
        if (fromVal) {
            const c1 = getLatLon(fromVal);
            if (c1) { addMarker(c1, fromVal); routeCoords.push([c1.lat, c1.lon]); }
        }
        if (index === rows.length - 1 && toVal) {
            const c2 = getLatLon(toVal);
            if (c2) { addMarker(c2, toVal); routeCoords.push([c2.lat, c2.lon]); }
        }
    });
    if (routeCoords.length > 1) {
        const polyline = L.polyline(routeCoords, {color: 'blue', weight: 4, opacity: 0.7}).addTo(mapInstance);
        mapLayers.push(polyline);
        mapInstance.fitBounds(polyline.getBounds(), {padding: [50, 50]});
    }
}

/* --- PRINT LAYOUT LOGIC (SIDE BY SIDE A5) --- */
function getHtmlForPage(rows, pageIndex, totalDist) {
    const legsPerPage = 5;
    const startIdx = pageIndex * legsPerPage;
    const pageRows = rows.slice(startIdx, startIdx + legsPerPage);
    
    // Safety Getters
    const safeVal = (id) => document.getElementById(id) ? document.getElementById(id).value : "";
    const safeText = (id) => document.getElementById(id) ? document.getElementById(id).textContent : "";

    const d = {
        pilot: safeVal("pilot"), reg: safeVal("acreg"), from: safeVal("from"), to: safeVal("to"), 
        dist: totalDist, time: safeVal("plannedTime"), alt: safeVal("alt"), 
        altDist: safeVal("altDist"), bkOff: safeVal("brakesOff"), bkOn: safeVal("brakesOn"), 
        tkof: safeVal("tkofInfo"), ldg: safeVal("ldgInfo"), fob: safeVal("fob"), 
        fuelReq: safeVal("fuel_min"), clearance: safeVal("clearance")
    };
    const mb = { cg: safeText('mb_res_cg'), wt: safeText('mb_res_weight') };
    
    const stationRows = document.querySelectorAll("#stationsTable tbody tr");
    const stations = Array.from(stationRows).map(r => ({ 
        st: r.children[0].querySelector("input")?.value || "", 
        crs: r.children[1].querySelector("input")?.value || "", 
        frq: r.children[2].querySelector("input")?.value || "" 
    }));

    return `
    <div class="dento-page-scaled">
        <div class="dento-form">
            <div class="header-top">
                <div class="header-left">
                    <div class="p-col gray" style="height:25px; border-bottom:1px solid black; font-weight:bold; font-size:10px; padding:2px;">TRANSPONDER</div>
                    <div class="xpdr-row"><div class="xpdr-label">Distress</div><div class="xpdr-val">7700</div></div>
                    <div class="xpdr-row"><div class="xpdr-label">Com Fail</div><div class="xpdr-val">7500</div></div>
                    <div class="xpdr-row"><div class="xpdr-label">Conspicuity</div><div class="xpdr-val">7000</div></div>
                </div>
                <div class="header-right">
                    <div class="fd-row"><div class="fd-cell" style="width:70%"><span class="p-label">Pilot:</span> <span class="p-value">${d.pilot}</span></div><div class="fd-cell" style="width:30%"><span class="p-label">A/C Reg:</span> <span class="p-value">${d.reg}</span></div></div>
                    <div class="fd-row"><div class="fd-cell"><span class="p-label">From:</span> <span class="p-value">${d.from}</span></div><div class="fd-cell"><span class="p-label">To:</span> <span class="p-value">${d.to}</span></div></div>
                    <div class="fd-row"><div class="fd-cell"><span class="p-label">Distance:</span> <span class="p-value">${d.dist}</span></div><div class="fd-cell"><span class="p-label">Flight Time:</span> <span class="p-value">${d.time}</span></div></div>
                    <div class="fd-row"><div class="fd-cell"><span class="p-label">Alternative:</span> <span class="p-value">${d.alt}</span></div><div class="fd-cell"><span class="p-label">Distance:</span> <span class="p-value">${d.altDist}</span></div></div>
                    <div class="rw-row"><div class="rw-cell" style="width:25%"><span class="p-label">Brakes Off:</span> <span class="p-value">${d.bkOff}</span></div><div class="rw-cell" style="width:35%"><span class="p-label">Takeoff:</span></div><div class="rw-cell" style="flex:1"><span class="p-value">${d.tkof}</span></div></div>
                    <div class="rw-row" style="border-bottom:none;"><div class="rw-cell" style="width:25%"><span class="p-label">Brakes On:</span> <span class="p-value">${d.bkOn}</span></div><div class="rw-cell" style="width:35%"><span class="p-label">Landing:</span></div><div class="rw-cell" style="flex:1"><span class="p-value">${d.ldg}</span></div></div>
                </div>
            </div>
            <table class="navlog-print-table">
                <thead><tr><th class="col-fromto">FROM / TO</th><th class="col-msa">MSA</th><th class="col-alt">ALT</th><th class="col-tas">TAS</th><th class="col-tr">TR<br>(T)</th><th class="col-wv">W/V</th><th class="col-hdg">HDG<br>(T)</th><th class="col-hdg">HDG<br>(M)</th><th class="col-gs">G/S</th><th class="col-dist">Dist</th><th class="col-time">Time</th><th class="col-eta">ETA</th><th class="col-eta">ATA</th></tr></thead>
                <tbody>${generatePrintRows(pageRows, 5)}</tbody>
            </table>
            <div class="footer-section">
                <div class="footer-left">
                    <div class="distress-bar">"Distress 121.50"</div>
                    <table class="stations-table">
                        <tr><th>STATION</th><th>CRS</th><th>FREQ</th></tr>
                        <tr><td>${stations[0]?.st||''}</td><td>${stations[0]?.crs||''}</td><td>${stations[0]?.frq||''}</td></tr>
                        <tr><td>${stations[1]?.st||''}</td><td>${stations[1]?.crs||''}</td><td>${stations[1]?.frq||''}</td></tr>
                        <tr><td>${stations[2]?.st||''}</td><td>${stations[2]?.crs||''}</td><td>${stations[2]?.frq||''}</td></tr>
                    </table>
                    <div class="fuel-header">FUEL & M/B</div>
                    <div class="fuel-row"><div class="fuel-lbl">FOB</div><div class="fuel-val">${d.fob}</div></div>
                    <div class="fuel-row"><div class="fuel-lbl">Fuel Req</div><div class="fuel-val">${d.fuelReq}</div></div>
                    <div class="mb-print-box"><span>CG: <b>${mb.cg}</b></span><span>GW: <b>${mb.wt}</b></span></div>
                </div>
                <div class="footer-mid">
                    <div class="clearance-header">Clearance / Observations</div>
                    <div class="clearance-box">${d.clearance}</div>
                </div>
                <div class="footer-right"><div class="vertical-text">DENTO AVIATION</div></div>
            </div>
        </div>
    </div>`;
}

function generatePrintLayout() {
    const container = document.getElementById("printPagesContainer"); 
    if(!container) return;
    container.innerHTML = "";
    
    const rows = Array.from(document.querySelectorAll("#navlog tbody tr"));
    const legsPerPage = 5; 
    const totalPages = Math.ceil(Math.max(rows.length, 1) / legsPerPage);
    const totalDist = document.getElementById("totalDist") ? document.getElementById("totalDist").value : "";

    for (let i = 0; i < totalPages; i += 2) {
        const pageLeftHTML = getHtmlForPage(rows, i, totalDist);
        let pageRightHTML = "";
        if (i + 1 < totalPages) {
            pageRightHTML = getHtmlForPage(rows, i + 1, totalDist);
        } else if (totalPages === 1) {
            pageRightHTML = pageLeftHTML; 
        } else {
            pageRightHTML = ""; 
        }

        const sheetHTML = `
        <div class="print-sheet">
            <div class="half-sheet">${pageLeftHTML}</div>
            <div class="half-sheet">${pageRightHTML}</div>
        </div>`;
        
        container.innerHTML += sheetHTML;
    }
}

/* --- SAVE AS IMAGE FUNCTION --- */
function saveAsImage() {
    // 1. Generate the layout hidden (but attached to DOM)
    generatePrintLayout();
    document.body.classList.add("show-overlay");
    
    const sheets = document.querySelectorAll('.print-sheet');
    if (sheets.length === 0) return;

    // Use the first sheet (standard for kneeboard)
    const target = sheets[0];

    // 2. Use html2canvas
    html2canvas(target, {
        scale: 2, // High resolution (retina)
        useCORS: true, // Allow external assets if any
        logging: false
    }).then(canvas => {
        // 3. Create Download
        const link = document.createElement('a');
        link.download = 'Navlog_Kneeboard.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        // 4. Cleanup
        document.body.classList.remove("show-overlay");
    }).catch(err => {
        console.error("Image generation failed:", err);
        alert("Could not generate image. Please try 'Print / PDF' instead.");
        document.body.classList.remove("show-overlay");
    });
}

function generatePrintRows(rows, targetCount) {
    let html = "";
    rows.forEach(row => { html += `<tr><td class="split-cell"><div class="split-top">${getCellValue(row, 0)}</div><div class="split-bottom">${getCellValue(row, 1)}</div></td><td>${getCellValue(row, 2)}</td><td>${getCellValue(row, 3)}</td><td>${getCellValue(row, 4)}</td><td>${getCellValue(row, 5)}</td><td>${getCellValue(row, 6)}</td><td>${getCellValue(row, 8)}</td><td>${getCellValue(row, 9)}</td><td>${getCellValue(row, 10)}</td><td>${getCellValue(row, 11)}</td><td>${getCellValue(row, 12)}</td><td>${getCellValue(row, 13)}</td><td>${getCellValue(row, 14)}</td></tr>`; });
    for(let i = rows.length; i < targetCount; i++) { html += `<tr><td class="split-cell"><div class="split-top"></div><div class="split-bottom"></div></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>`; }
    return html;
}

function previewOverlay() { generatePrintLayout(); document.body.classList.add("show-overlay"); }
function closeOverlay() { document.body.classList.remove("show-overlay"); }
function exportPDF(){ generatePrintLayout(); document.body.classList.add("show-overlay"); setTimeout(() => { window.print(); document.body.classList.remove("show-overlay"); }, 500); }
window.onload = function() { calculateMassBalance(); if (!autoLoad() || document.querySelectorAll("#navlog tbody tr").length === 0) { addRow(); addRow(); calculateAll(); autoSave(); } setupAutoSaveListeners(); };
</script>
</body>
</html>