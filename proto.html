<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dento Digital NAVLOG</title>
<style>
Â  Â  /* --- PROFESSIONAL LOOK & FEEL --- */
Â  Â  body {
Â  Â  Â  Â  font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; /* Modern Font Stack */
Â  Â  Â  Â  background: #f7f7f7; /* Clean Off-white background */
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  color: #333;
Â  Â  }
Â  Â  h1 {
Â  Â  Â  Â  background: #002147; /* Rich Navy Blue Header */
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  padding: 16px 25px; /* Increased vertical padding */
Â  Â  Â  Â  font-size: 24px;
Â  Â  Â  Â  letter-spacing: 0.5px;
Â  Â  }
Â  Â  h5 {
Â  Â  Â  Â  background: #002147;
Â  Â  Â  Â  color: #b0c4de;
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  padding: 0 25px 10px;
Â  Â  Â  Â  font-weight: normal;
Â  Â  Â  Â  font-size: 11px;
Â  Â  Â  Â  text-transform: uppercase;
Â  Â  }
Â  Â  .container {
Â  Â  Â  Â  padding: 20px 25px; /* Increased padding */
Â  Â  }
Â  Â  fieldset {
Â  Â  Â  Â  border: 1px solid #d4d4d4; /* Lighter border for clean look */
Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  background: #fff;
Â  Â  Â  Â  border-radius: 6px; /* Subtle rounding */
Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* Soft drop shadow */
Â  Â  }
Â  Â  legend {
Â  Â  Â  Â  padding: 0 8px;
Â  Â  Â  Â  font-weight: 600; /* Slightly bolder */
Â  Â  Â  Â  color: #002147; /* Match header color */
Â  Â  Â  Â  font-size: 13px;
Â  Â  }
Â  Â  .row {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  Â  gap: 20px; /* Increased gap */
Â  Â  Â  Â  margin-bottom: 10px;
Â  Â  Â  Â  align-items: flex-end; /* Align inputs to the bottom */
Â  Â  }
Â  Â  /* New style for Metar area */
Â  Â  .metar-row {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  margin-top: 15px;
Â  Â  }
Â  Â  .metar-input-group {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  flex-basis: 250px;
Â  Â  Â  Â  flex-shrink: 0;
Â  Â  }
Â  Â  .metar-output {
Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  min-width: 300px;
Â  Â  }
Â  Â  .field {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  flex-grow: 1; /* Allow fields to grow */
Â  Â  }
Â  Â  .field label {
Â  Â  Â  Â  margin-bottom: 4px;
Â  Â  Â  Â  color: #555;
Â  Â  }
Â  Â  .field input, .field textarea, .wpField input, .wpField select {
Â  Â  Â  Â  padding: 8px;
Â  Â  Â  Â  min-width: 100px;
Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  font-size: 13px; /* Slightly larger font */
Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  transition: border-color 0.2s, box-shadow 0.2s; /* ANIMATION */
Â  Â  }
Â  Â  .field input:focus, .field textarea:focus, .wpField input:focus, .wpField select:focus {
Â  Â  Â  Â  border-color: #007bff; /* Accent blue focus */
Â  Â  Â  Â  box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25); /* Subtle glow */
Â  Â  Â  Â  outline: none;
Â  Â  }
Â  Â  textarea {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  min-height: 100px; /* Increased height */
Â  Â  Â  Â  resize: vertical;
Â  Â  }
Â  Â  table {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  border-collapse: collapse;
Â  Â  Â  Â  background: #fff;
Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  overflow: hidden; /* Ensures rounded corners */
Â  Â  }
Â  Â  th {
Â  Â  Â  Â  background: #e9ecef; /* Light gray header */
Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  padding: 8px 4px;
Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  text-transform: uppercase;
Â  Â  }
Â  Â  td {
Â  Â  Â  Â  border: 1px solid #e0e0e0; /* Lighter cell borders */
Â  Â  Â  Â  padding: 6px 4px;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  font-size: 12px;
Â  Â  }
Â  Â  /* Zebra Striping for table clarity */
Â  Â  #navlog tbody tr:nth-child(even) {
Â  Â  Â  Â  background-color: #f9f9f9;
Â  Â  }
Â  Â  input[readonly] {
Â  Â  Â  Â  background: #e9ecef; /* Slightly darker read-only background */
Â  Â  Â  Â  color: #555;
Â  Â  Â  Â  font-weight: bold;
Â  Â  }
Â  Â  button {
Â  Â  Â  Â  padding: 10px 15px;
Â  Â  Â  Â  margin: 4px 6px 10px 0;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  background: #007bff; /* Accent Blue button */
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  border-radius: 4px;
Â  Â  Â  Â  font-size: 13px;
Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  transition: background 0.2s, transform 0.2s; /* ANIMATION */
Â  Â  }
Â  Â  button:hover {
Â  Â  Â  Â  background: #0056b3; /* Darker blue on hover */
Â  Â  Â  Â  transform: translateY(-1px); /* Subtle lift ANIMATION */
Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
Â  Â  }
Â  Â  button:active {
Â  Â  Â  Â  transform: translateY(0);
Â  Â  }
Â  Â  /* Special button color for calculation */
Â  Â  button[onclick*="calculateAll"] {
Â  Â  Â  Â  background: #28a745; /* Green for Calculate */
Â  Â  }
Â  Â  button[onclick*="calculateAll"]:hover {
Â  Â  Â  Â  background: #1e7e34;
Â  Â  }
Â  Â  /* Special button color for METAR */
Â  Â  #fetchMetarBtn {
Â  Â  Â  Â  background: #ffc107; /* Yellow/Amber for Weather */
Â  Â  Â  Â  color: #333;
Â  Â  }
Â  Â  #fetchMetarBtn:hover {
Â  Â  Â  Â  background: #e0a800;
Â  Â  }

Â  Â  /* waypoint field (dropdown + input) */
Â  Â  .wpField {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  }
Â  Â  .wpField select {
Â  Â  Â  Â  font-size: 12px;
Â  Â  Â  Â  padding: 6px;
Â  Â  Â  Â  margin-bottom: 4px;
Â  Â  }

Â  Â  /* ---------- PRINT OVERLAY (Excel layout) ---------- */

Â  Â  /* Hidden by default on screen */
Â  Â  #printSheetWrapper {
Â  Â  Â  Â  display: none;
Â  Â  }

Â  Â  /* Show overlay + hide editor in preview mode */
Â  Â  body.show-overlay #printSheetWrapper {
Â  Â  Â  Â  display: block;
Â  Â  }
Â  Â  body.show-overlay #editor,
Â  Â  body.show-overlay h1,
Â  Â  body.show-overlay h5 {
Â  Â  Â  Â  display: none;
Â  Â  }

Â  Â  .printPage {
Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  width: 210mm; Â  /* A4 portrait */
Â  Â  Â  Â  height: 297mm;
Â  Â  Â  Â  background: url("navlog_excel_template.png") no-repeat center;
Â  Â  Â  Â  background-size: contain;
Â  Â  Â  Â  page-break-after: always;
Â  Â  }
Â  Â  .fieldPrint {
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  font-size: 9pt;
Â  Â  Â  Â  white-space: nowrap;
Â  Â  }

Â  Â  #overlayCloseBtn {
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  top: 8px;
Â  Â  Â  Â  right: 8px;
Â  Â  Â  Â  padding: 4px 8px;
Â  Â  Â  Â  background: rgba(0,0,0,0.65);
Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  font-size: 11px;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  border-radius: 3px;
Â  Â  Â  Â  z-index: 10;
Â  Â  }

Â  Â  /* ---- Tuned positions ---- */
Â  Â  /* Top flight info (same on all pages) */
Â  Â  .top_pilot Â  Â  { top: 13.4%; left: 38%; width: 30%; }
Â  Â  .top_acreg Â  Â  { top: 13.5%; left: 77%; width: 20%; }

Â  Â  .top_from Â  Â  Â { top: 15.3%; left: 40%; width: 30%; }
Â  Â  .top_to Â  Â  Â  Â { top: 15.3%; left: 78%; width: 20%; }

Â  Â  .top_distance Â { top: 18%; Â left: 41%; width: 20%; }
Â  Â  .top_fltTime Â  { top: 18%; Â left: 81%; width: 20%; }

Â  Â  .top_alt Â  Â  Â  { top: 20%; Â left: 40%; width: 30%; }
Â  Â  .top_altDist Â  { top: 20%; Â left: 82%; width: 20%; }

Â  Â  .top_brakesOff { top: 21.5%; left: 27%; width: 15%; }
Â  Â  .top_brakesOn Â { top: 23%; Â left: 27%; width: 15%; }

Â  Â  .top_tkofInfo Â { top: 21.5%; left: 58%; width: 30%; }
Â  Â  .top_ldgInfo Â  { top: 22.78%; Â left: 58%; width: 30%; }

Â  Â  /* MAIN ROW TOPS FOR OTHER COLUMNS (MSA / ALT / TAS / etc.) */
Â  Â  .r1 { top: 27%; }
Â  Â  .r2 { top: 32%; }
Â  Â  .r3 { top: 36%; }
Â  Â  .r4 { top: 40%; }
Â  Â  .r5 { top: 44%; }

Â  Â  .c-from { left: 6%; Â width: 15%; }
Â  Â  .c-msa Â { left: 22%; width: 6%; Â }
Â  Â  .c-alt Â { left: 29%; width: 6%; Â }
Â  Â  .c-tas Â { left: 37%; width: 6%; Â }
Â  Â  .c-tr Â  { left: 42%; width: 6%; Â }
Â  Â  .c-wv Â  { left: 47%; width: 8%; Â }
Â  Â  .c-hdgt { left: 54%; width: 6%; Â }
Â  Â  .c-hdgm { left: 60%; width: 6%; Â }
Â  Â  .c-gs Â  { left: 67%; width: 6%; Â }
Â  Â  .c-dist { left: 73%; width: 6%; Â }
Â  Â  .c-time { left: 79%; width: 6%; Â }

Â  Â  /* FROM/TO COLUMN â€“ separate line per row */
Â  Â  .r1_from { top: 25.5%; Â }
Â  Â  .r1_to Â  { top: 28.4%; Â }
Â  Â  .r2_from { top: 29.5%; Â }
Â  Â  .r2_to Â  { top: 32%; Â }
Â  Â  .r3_from { top: 33.5%; Â }
Â  Â  .r3_to Â  { top: 36.2%; Â }
Â  Â  .r4_from { top: 37.5%; Â }
Â  Â  .r4_to Â  { top: 40%; Â }
Â  Â  .r5_from { top: 41.6%; Â }
Â  Â  .r5_to Â  { top: 44%; Â }

Â  Â  /* Fuel + clearance */
Â  Â  .bottom_fob Â  Â  Â { top: 52%; left: 25%; width: 15%; }
Â  Â  .bottom_fuelReq Â { top: 53.5%; left: 25%; width: 15%; }
Â  Â  .bottom_clearance{ top: 47%; left: 35%; width: 55%; height: 18%; white-space: pre-wrap; }
Â  Â  /* End of tuned positions - DO NOT CHANGE LINES ABOVE THIS COMMENT */

Â  Â  /* ANIMATION FOR CALCULATED FIELDS (optional visual feedback) */
Â  Â  @keyframes flashGreen {
Â  Â  Â  Â  0% { background-color: #fff; }
Â  Â  Â  Â  50% { background-color: #e6ffed; } /* Light green flash */
Â  Â  Â  Â  100% { background-color: #fff; }
Â  Â  }
Â  Â  .calculated-flash {
Â  Â  Â  Â  animation: flashGreen 0.6s ease-out;
Â  Â  }
Â  Â  #navlog tbody tr:nth-child(even) .calculated-flash {
Â  Â  Â  Â  animation: flashGreen 0.6s ease-out;
Â  Â  }

Â  Â  /* PRINT MODE */
Â  Â  @media print {
Â  Â  Â  Â  body { background: #fff; }
Â  Â  Â  Â  #editor, h1, h5 { display: none !important; }
Â  Â  Â  Â  #printSheetWrapper { display: block !important; }
Â  Â  Â  Â  button { display: none !important; }
Â  Â  }
</style>
</head>
<body>

<h1>Dento Digital Navlog</h1>
<h5>CREATED BY MICHAEL MITRY</H5>

<div id="editor" class="container">

<fieldset>
<legend>Flight Info</legend>
<div class="row">
Â  Â  <div class="field">
Â  Â  Â  Â  <label>Pilot</label>
Â  Â  Â  Â  <input id="pilot">
Â  Â  </div>
Â  Â  <div class="field">
Â  Â  Â  Â  <label>A/C Reg</label>
Â  Â  Â  Â  <input id="acreg">
Â  Â  </div>
Â  Â  <div class="field">
Â  Â  Â  Â  <label>From</label>
Â  Â  Â  Â  <input id="from">
Â  Â  </div>
Â  Â  <div class="field">
Â  Â  Â  Â  <label>To</label>
Â  Â  Â  Â  <input id="to">
Â  Â  </div>
Â  Â  <div class="field">
Â  Â  Â  Â  <label>Total Distance (NM)</label>
Â  Â  Â  Â  <input id="totalDist" readonly>
Â  Â  </div>
Â  Â  <div class="field">
Â  Â  Â  Â  <label>Planned Flight Time</label>
Â  Â  Â  Â  <input id="plannedTime" placeholder="hh:mm">
Â  Â  </div>
</div>

<div class="row">
Â  Â  <div class="field">
Â  Â  Â  Â  <label>Alternate</label>
Â  Â  Â  Â  <input id="alt">
Â  Â  Â  </div>
Â  Â  <div class="field">
Â  Â  Â  Â  <label>Alt Distance (NM)</label>
Â  Â  Â  Â  <input id="altDist">
Â  Â  </div>
Â  Â  <div class="field">
Â  Â  Â  Â  <label>Dep Time (UTC / LT)</label>
Â  Â  Â  Â  <input id="depTime" value="08:00" placeholder="hh:mm">
Â  Â  </div>
Â  Â  <div class="field">
Â  Â  Â  Â  <label>Variation (E+ / W-)</label>
Â  Â  Â  Â  <input id="variation" value="4">
Â  Â  </div>
Â  Â  <div class="field">
Â  Â  Â  Â  <label>Fuel Burn (L/hr)</label>
Â  Â  Â  Â  <input id="fuelburn" value="10">
Â  Â  </div>
</div>

<div class="metar-row">
Â  Â  <div class="metar-input-group">
Â  Â  Â  Â  <label for="metarIcao">METAR Station (ICAO)</label>
Â  Â  Â  Â  <input id="metarIcao" placeholder="e.g., LCLK or LCPH" oninput="autoSave()">
Â  Â  Â  Â  <button id="fetchMetarBtn" onclick="getMetar()">â˜ï¸ Get Live METAR</button>
Â  Â  </div>
Â  Â  <div class="metar-output">
Â  Â  Â  Â  <label for="rawMetar">Raw METAR Report</label>
Â  Â  Â  Â  <textarea id="rawMetar" readonly placeholder="METAR data will appear here..."></textarea>
Â  Â  </div>
</div>
</fieldset>

<fieldset>
<legend>Brakes / Runway / Temperature</legend>
<div class="row">
Â  Â  <div class="field">
Â  Â  Â  Â  <label>Brakes Off</label>
Â  Â  Â  Â  <input id="brakesOff" placeholder="hh:mm">
Â  Â  </div>
Â  Â  <div class="field">
Â  Â  Â  Â  <label>Brakes On</label>
Â  Â  Â  Â  <input id="brakesOn" placeholder="hh:mm">
Â  Â  </div>
Â  Â  <div class="field">
Â  Â  Â  Â  <label>Takeoff RWY / Wind / Temp</label>
Â  Â  Â  Â  <input id="tkofInfo" placeholder="e.g. 2000' 040/10 +20Â°C">
Â  Â  </div>
Â  Â  <div class="field">
Â  Â  Â  Â  <label>Landing RWY / Wind / Temp</label>
Â  Â  Â  Â  <input id="ldgInfo" placeholder="e.g. 5000' 220/12 +24Â°C">
Â  Â  </div>
</div>
</fieldset>

<button onclick="addRow()">â• Add Waypoint</button>
<button onclick="calculateAll();">ğŸ§  Auto-Calculate</button>
<button onclick="manualSave()">ğŸ’¾ Download Data</button>
<button onclick="manualLoad()">ğŸ“‚ Upload Data</button>
<button onclick="previewOverlay()">ğŸ‘€ Preview layout</button>
<button onclick="exportPDF()">ğŸ“„ Print / PDF</button>

<table id="navlog">
<thead>
<tr>
Â  Â  <th>FROM</th>
Â  Â  <th>TO</th>
Â  Â  <th>MSA</th>
Â  Â  <th>ALT</th>
Â  Â  <th>TAS</th>
Â  Â  <th>TR (T)</th>
Â  Â  <th>W/V (dir/spd)</th>
Â  Â  <th>WCA</th>
Â  Â  <th>HDG (T)</th>
Â  Â  <th>HDG (M)</th>
Â  Â  <th>G/S</th>
Â  Â  <th>Dist</th>
Â  Â  <th>Time</th>
Â  Â  <th>ETA</th>
Â  Â  <th>ATA</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div class="row" style="margin-top:10px;">
Â  Â  <div style="flex:1;">
Â  Â  Â  Â  <fieldset>
Â  Â  Â  Â  Â  Â  <legend>Fuel</legend>
Â  Â  Â  Â  Â  Â  <div class="field">
Â  Â  Â  Â  Â  Â  Â  Â  <label>FOB (start)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input id="fob">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="field">
Â  Â  Â  Â  Â  Â  Â  Â  <label>Fuel Required (calc)</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input id="fuelReq" readonly>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </fieldset>

Â  Â  Â  Â  <fieldset>
Â  Â  Â  Â  Â  Â  <legend>Stations</legend>
Â  Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><th>STATION</th><th>CRS</th><th>FREQ</th></tr>
Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><input oninput="autoSave()"></td><td><input oninput="autoSave()"></td><td><input oninput="autoSave()"></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><input oninput="autoSave()"></td><td><input oninput="autoSave()"></td><td><input oninput="autoSave()"></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td><input oninput="autoSave()"></td><td><input oninput="autoSave()"></td><td><input oninput="autoSave()"></td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </fieldset>
Â  Â  </div>
Â  Â  <div style="flex:2%;">
Â  Â  Â  Â  <fieldset>
Â  Â  Â  Â  Â  Â  <legend>Clearance / Observations</legend>
Â  Â  Â  Â  Â  Â  <textarea id="clearance"></textarea>
Â  Â  Â  Â  </fieldset>
Â  Â  </div>
</div>

</div> <div id="printSheetWrapper">
Â  <div class="printPage" id="page1">
Â  Â  <button id="overlayCloseBtn" type="button" onclick="closeOverlay()">Back</button>

Â  Â  <div id="p1_pilot" Â  Â  Â class="fieldPrint top_pilot"></div>
Â  Â  <div id="p1_acreg" Â  Â  Â class="fieldPrint top_acreg"></div>
Â  Â  <div id="p1_from" Â  Â  Â  class="fieldPrint top_from"></div>
Â  Â  <div id="p1_to" Â  Â  Â  Â  class="fieldPrint top_to"></div>
Â  Â  <div id="p1_distance" Â  class="fieldPrint top_distance"></div>
Â  Â  <div id="p1_fltTime" Â  Â class="fieldPrint top_fltTime"></div>
Â  Â  <div id="p1_alt" Â  Â  Â  Â class="fieldPrint top_alt"></div>
Â  Â  <div id="p1_altDist" Â  Â class="fieldPrint top_altDist"></div>
Â  Â  <div id="p1_brakesOff" Â class="fieldPrint top_brakesOff"></div>
Â  Â  <div id="p1_brakesOn" Â  class="fieldPrint top_brakesOn"></div>
Â  Â  <div id="p1_tkofInfo" Â  class="fieldPrint top_tkofInfo"></div>
Â  Â  <div id="p1_ldgInfo" Â  Â class="fieldPrint top_ldgInfo"></div>

Â  Â  <div id="p1_r1_from" class="fieldPrint r1_from c-from"></div>
Â  Â  <div id="p1_r1_to" Â  class="fieldPrint r1_to Â  c-from"></div>
Â  Â  <div id="p1_r2_from" class="fieldPrint r2_from c-from"></div>
Â  Â  <div id="p1_r2_to" Â  class="fieldPrint r2_to Â  c-from"></div>
Â  Â  <div id="p1_r3_from" class="fieldPrint r3_from c-from"></div>
Â  Â  <div id="p1_r3_to" Â  class="fieldPrint r3_to Â  c-from"></div>
Â  Â  <div id="p1_r4_from" class="fieldPrint r4_from c-from"></div>
Â  Â  <div id="p1_r4_to" Â  class="fieldPrint r4_to Â  c-from"></div>
Â  Â  <div id="p1_r5_from" class="fieldPrint r5_from c-from"></div>
Â  Â  <div id="p1_r5_to" Â  class="fieldPrint r5_to Â  c-from"></div>

Â  Â  <div id="p1_r1_msa" Â  class="fieldPrint r1 c-msa"></div>
Â  Â  <div id="p1_r1_alt" Â  class="fieldPrint r1 c-alt"></div>
Â  Â  <div id="p1_r1_tas" Â  class="fieldPrint r1 c-tas"></div>
Â  Â  <div id="p1_r1_tr" Â  Â class="fieldPrint r1 c-tr"></div>
Â  Â  <div id="p1_r1_wv" Â  Â class="fieldPrint r1 c-wv"></div>
Â  Â  <div id="p1_r1_hdgt" Â class="fieldPrint r1 c-hdgt"></div>
Â  Â  <div id="p1_r1_hdgm" Â class="fieldPrint r1 c-hdgm"></div>
Â  Â  <div id="p1_r1_gs" Â  Â class="fieldPrint r1 c-gs"></div>
Â  Â  <div id="p1_r1_dist" Â class="fieldPrint r1 c-dist"></div>
Â  Â  <div id="p1_r1_time" Â class="fieldPrint r1 c-time"></div>

Â  Â  <div id="p1_r2_msa" Â  class="fieldPrint r2 c-msa"></div>
Â  Â  <div id="p1_r2_alt" Â  class="fieldPrint r2 c-alt"></div>
Â  Â  <div id="p1_r2_tas" Â  class="fieldPrint r2 c-tas"></div>
Â  Â  <div id="p2_r2_tr" Â  Â class="fieldPrint r2 c-tr"></div>
Â  Â  <div id="p2_r2_wv" Â  Â class="fieldPrint r2 c-wv"></div>
Â  Â  <div id="p2_r2_hdgt" Â class="fieldPrint r2 c-hdgt"></div>
Â  Â  <div id="p2_r2_hdgm" Â class="fieldPrint r2 c-hdgm"></div>
Â  Â  <div id="p2_r2_gs" Â  Â class="fieldPrint r2 c-gs"></div>
Â  Â  <div id="p2_r2_dist" Â class="fieldPrint r2 c-dist"></div>
Â  Â  <div id="p2_r2_time" Â class="fieldPrint r2 c-time"></div>

Â  Â  <div id="p1_r3_msa" Â  class="fieldPrint r3 c-msa"></div>
Â  Â  <div id="p1_r3_alt" Â  class="fieldPrint r3 c-alt"></div>
Â  Â  <div id="p1_r3_tas" Â  class="fieldPrint r3 c-tas"></div>
Â  Â  <div id="p1_r3_tr" Â  Â class="fieldPrint r3 c-tr"></div>
Â  Â  <div id="p1_r3_wv" Â  Â class="fieldPrint r3 c-wv"></div>
Â  Â  <div id="p1_r3_hdgt" Â class="fieldPrint r3 c-hdgt"></div>
Â  Â  <div id="p1_r3_hdgm" Â class="fieldPrint r3 c-hdgm"></div>
Â  Â  <div id="p1_r3_gs" Â  Â class="fieldPrint r3 c-gs"></div>
Â  Â  <div id="p1_r3_dist" Â class="fieldPrint r3 c-dist"></div>
Â  Â  <div id="p1_r3_time" Â class="fieldPrint r3 c-time"></div>

Â  Â  <div id="p1_r4_msa" Â  class="fieldPrint r4 c-msa"></div>
Â  Â  <div id="p1_r4_alt" Â  class="fieldPrint r4 c-alt"></div>
Â  Â  <div id="p1_r4_tas" Â  class="fieldPrint r4 c-tas"></div>
Â  Â  <div id="p1_r4_tr" Â  Â class="fieldPrint r4 c-tr"></div>
Â  Â  <div id="p1_r4_wv" Â  Â class="fieldPrint r4 c-wv"></div>
Â  Â  <div id="p1_r4_hdgt" Â class="fieldPrint r4 c-hdgt"></div>
Â  Â  <div id="p1_r4_hdgm" Â class="fieldPrint r4 c-hdgm"></div>
Â  Â  <div id="p1_r4_gs" Â  Â class="fieldPrint r4 c-gs"></div>
Â  Â  <div id="p1_r4_dist" Â class="fieldPrint r4 c-dist"></div>
Â  Â  <div id="p1_r4_time" Â class="fieldPrint r4 c-time"></div>

Â  Â  <div id="p1_r5_msa" Â  class="fieldPrint r5 c-msa"></div>
Â  Â  <div id="p1_r5_alt" Â  class="fieldPrint r5 c-alt"></div>
Â  Â  <div id="p1_r5_tas" Â  class="fieldPrint r5 c-tas"></div>
Â  Â  <div id="p1_r5_tr" Â  Â class="fieldPrint r5 c-tr"></div>
Â  Â  <div id="p1_r5_wv" Â  Â class="fieldPrint r5 c-wv"></div>
Â  Â  <div id="p1_r5_hdgt" Â class="fieldPrint r5 c-hdgt"></div>
Â  Â  <div id="p1_r5_hdgm" Â class="fieldPrint r5 c-hdgm"></div>
Â  Â  <div id="p1_r5_gs" Â  Â class="fieldPrint r5 c-gs"></div>
Â  Â  <div id="p1_r5_dist" Â class="fieldPrint r5 c-dist"></div>
Â  Â  <div id="p1_r5_time" Â class="fieldPrint r1 c-time"></div>

Â  Â  <div id="p1_fob" Â  Â  Â class="fieldPrint bottom_fob"></div>
Â  Â  <div id="p1_fuelReq" Â class="fieldPrint bottom_fuelReq"></div>
Â  Â  <div id="p1_clearance"class="fieldPrint bottom_clearance"></div>
Â  </div>

Â  <div class="printPage" id="page2">
Â  Â  <div id="p2_pilot" Â  Â  Â class="fieldPrint top_pilot"></div>
Â  Â  <div id="p2_acreg" Â  Â  Â class="fieldPrint top_acreg"></div>
Â  Â  <div id="p2_from" Â  Â  Â  class="fieldPrint top_from"></div>
Â  Â  <div id="p2_to" Â  Â  Â  Â  class="fieldPrint top_to"></div>
Â  Â  <div id="p2_distance" Â  class="fieldPrint top_distance"></div>
Â  Â  <div id="p2_fltTime" Â  Â class="fieldPrint top_fltTime"></div>
Â  Â  <div id="p2_alt" Â  Â  Â  Â class="fieldPrint top_alt"></div>
Â  Â  <div id="p2_altDist" Â  Â class="fieldPrint top_altDist"></div>
Â  Â  <div id="p2_brakesOff" Â class="fieldPrint top_brakesOff"></div>
Â  Â  <div id="p2_brakesOn" Â  class="fieldPrint top_brakesOn"></div>
Â  Â  <div id="p2_tkofInfo" Â  class="fieldPrint top_tkofInfo"></div>
Â  Â  <div id="p2_ldgInfo" Â  Â class="fieldPrint top_ldgInfo"></div>

Â  Â  <div id="p2_r1_from" class="fieldPrint r1_from c-from"></div>
Â  Â  <div id="p2_r1_to" Â  class="fieldPrint r1_to Â  c-from"></div>
Â  Â  <div id="p2_r2_from" class="fieldPrint r2_from c-from"></div>
Â  Â  <div id="p2_r2_to" Â  class="fieldPrint r2_to Â  c-from"></div>
Â  Â  <div id="p2_r3_from" class="fieldPrint r3_from c-from"></div>
Â  Â  <div id="p2_r3_to" Â  class="fieldPrint r3_to Â  c-from"></div>
Â  Â  <div id="p2_r4_from" class="fieldPrint r4_from c-from"></div>
Â  Â  <div id="p2_r4_to" Â  class="fieldPrint r4_to Â  c-from"></div>
Â  Â  <div id="p2_r5_from" class="fieldPrint r5_from c-from"></div>
Â  Â  <div id="p2_r5_to" Â  class="fieldPrint r5_to Â  c-from"></div>

Â  Â  <div id="p2_r1_msa" Â  class="fieldPrint r1 c-msa"></div>
Â  Â  <div id="p2_r1_alt" Â  class="fieldPrint r1 c-alt"></div>
Â  Â  <div id="p2_r1_tas" Â  class="fieldPrint r1 c-tas"></div>
Â  Â  <div id="p2_r1_tr" Â  Â class="fieldPrint r1 c-tr"></div>
Â  Â  <div id="p2_r1_wv" Â  Â class="fieldPrint r1 c-wv"></div>
Â  Â  <div id="p2_r1_hdgt" Â class="fieldPrint r1 c-hdgt"></div>
Â  Â  <div id="p2_r1_hdgm" Â class="fieldPrint r1 c-hdgm"></div>
Â  Â  <div id="p2_r1_gs" Â  Â class="fieldPrint r1 c-gs"></div>
Â  Â  <div id="p2_r1_dist" Â class="fieldPrint r1 c-dist"></div>
Â  Â  <div id="p2_r1_time" Â class="fieldPrint r1 c-time"></div>

Â  Â  <div id="p2_r2_msa" Â  class="fieldPrint r2 c-msa"></div>
Â  Â  <div id="p2_r2_alt" Â  class="fieldPrint r2 c-alt"></div>
Â  Â  <div id="p2_r2_tas" Â  class="fieldPrint r2 c-tas"></div>
Â  Â  <div id="p2_r2_tr" Â  Â class="fieldPrint r2 c-tr"></div>
Â  Â  <div id="p2_r2_wv" Â  Â class="fieldPrint r2 c-wv"></div>
Â  Â  <div id="p2_r2_hdgt" Â class="fieldPrint r2 c-hdgt"></div>
Â  Â  <div id="p2_r2_hdgm" Â class="fieldPrint r2 c-hdgm"></div>
Â  Â  <div id="p2_r2_gs" Â  Â class="fieldPrint r2 c-gs"></div>
Â  Â  <div id="p2_r2_dist" Â class="fieldPrint r2 c-dist"></div>
Â  Â  <div id="p2_r2_time" Â class="fieldPrint r2 c-time"></div>

Â  Â  <div id="p2_r3_msa" Â  class="fieldPrint r3 c-msa"></div>
Â  Â  <div id="p2_r3_alt" Â  class="fieldPrint r3 c-alt"></div>
Â  Â  <div id="p2_r3_tas" Â  class="fieldPrint r3 c-tas"></div>
Â  Â  <div id="p2_r3_tr" Â  Â class="fieldPrint r3 c-tr"></div>
Â  Â  <div id="p2_r3_wv" Â  Â class="fieldPrint r3 c-wv"></div>
Â  Â  <div id="p2_r3_hdgt" Â class="fieldPrint r3 c-hdgt"></div>
Â  Â  <div id="p2_r3_hdgm" Â class="fieldPrint r3 c-hdgm"></div>
Â  Â  <div id="p2_r3_gs" Â  Â class="fieldPrint r3 c-gs"></div>
Â  Â  <div id="p2_r3_dist" Â class="fieldPrint r3 c-dist"></div>
Â  Â  <div id="p2_r3_time" Â class="fieldPrint r3 c-time"></div>

Â  Â  <div id="p2_r4_msa" Â  class="fieldPrint r4 c-msa"></div>
Â  Â  <div id="p2_r4_alt" Â  class="fieldPrint r4 c-alt"></div>
Â  Â  <div id="p2_r4_tas" Â  class="fieldPrint r4 c-tas"></div>
Â  Â  <div id="p2_r4_tr" Â  Â class="fieldPrint r4 c-tr"></div>
Â  Â  <div id="p2_r4_wv" Â  Â class="fieldPrint r4 c-wv"></div>
Â  Â  <div id="p2_r4_hdgt" Â class="fieldPrint r4 c-hdgt"></div>
Â  Â  <div id="p2_r4_hdgm" Â class="fieldPrint r4 c-hdgm"></div>
Â  Â  <div id="p2_r4_gs" Â  Â class="fieldPrint r4 c-gs"></div>
Â  Â  <div id="p2_r4_dist" Â class="fieldPrint r4 c-dist"></div>
Â  Â  <div id="p2_r4_time" Â class="fieldPrint r4 c-time"></div>

Â  Â  <div id="p2_r5_msa" Â  class="fieldPrint r5 c-msa"></div>
Â  Â  <div id="p2_r5_alt" Â  class="fieldPrint r5 c-alt"></div>
Â  Â  <div id="p2_r5_tas" Â  class="fieldPrint r5 c-tas"></div>
Â  Â  <div id="p2_r5_tr" Â  Â class="fieldPrint r5 c-tr"></div>
Â  Â  <div id="p2_r5_wv" Â  Â class="fieldPrint r5 c-wv"></div>
Â  Â  <div id="p2_r5_hdgt" Â class="fieldPrint r5 c-hdgt"></div>
Â  Â  <div id="p2_r5_hdgm" Â class="fieldPrint r5 c-hdgm"></div>
Â  Â  <div id="p2_r5_gs" Â  Â class="fieldPrint r5 c-gs"></div>
Â  Â  <div id="p2_r5_dist" Â class="fieldPrint r5 c-dist"></div>
Â  Â  <div id="p2_r5_time" Â class="fieldPrint r5 c-time"></div>

Â  Â  <div id="p2_fob" Â  Â  Â class="fieldPrint bottom_fob"></div>
Â  Â  <div id="p2_fuelReq" Â class="fieldPrint bottom_fuelReq"></div>
Â  Â  <div id="p2_clearance"class="fieldPrint bottom_clearance"></div>
Â  </div>

Â  <div class="printPage" id="page3">
Â  Â  <div id="p3_pilot" Â  Â  Â class="fieldPrint top_pilot"></div>
Â  Â  <div id="p3_acreg" Â  Â  Â class="fieldPrint top_acreg"></div>
Â  Â  <div id="p3_from" Â  Â  Â  class="fieldPrint top_from"></div>
Â  Â  <div id="p3_to" Â  Â  Â  Â  class="fieldPrint top_to"></div>
Â  Â  <div id="p3_distance" Â  class="fieldPrint top_distance"></div>
Â  Â  <div id="p3_fltTime" Â  Â class="fieldPrint top_fltTime"></div>
Â  Â  <div id="p3_alt" Â  Â  Â  Â class="fieldPrint top_alt"></div>
Â  Â  <div id="p3_altDist" Â  Â class="fieldPrint top_altDist"></div>
Â  Â  <div id="p3_brakesOff" Â class="fieldPrint top_brakesOff"></div>
Â  Â  <div id="p3_brakesOn" Â  class="fieldPrint top_brakesOn"></div>
Â  Â  <div id="p3_tkofInfo" Â  class="fieldPrint top_tkofInfo"></div>
Â  Â  <div id="p3_ldgInfo" Â  Â class="fieldPrint top_ldgInfo"></div>

Â  Â  <div id="p3_r1_from" class="fieldPrint r1_from c-from"></div>
Â  Â  <div id="p3_r1_to" Â  class="fieldPrint r1_to Â  c-from"></div>
Â  Â  <div id="p3_r2_from" class="fieldPrint r2_from c-from"></div>
Â  Â  <div id="p3_r2_to" Â  class="fieldPrint r2_to Â  c-from"></div>
Â  Â  <div id="p3_r3_from" class="fieldPrint r3_from c-from"></div>
Â  Â  <div id="p3_r3_to" Â  class="fieldPrint r3_to Â  c-from"></div>
Â  Â  <div id="p3_r4_from" class="fieldPrint r4_from c-from"></div>
Â  Â  <div id="p3_r4_to" Â  class="fieldPrint r4_to Â  c-from"></div>
Â  Â  <div id="p3_r5_from" class="fieldPrint r5_from c-from"></div>
Â  Â  <div id="p3_r5_to" Â  class="fieldPrint r5_to Â  c-from"></div>

Â  Â  <div id="p3_r1_msa" Â  class="fieldPrint r1 c-msa"></div>
Â  Â  <div id="p3_r1_alt" Â  class="fieldPrint r1 c-alt"></div>
Â  Â  <div id="p3_r1_tas" Â  class="fieldPrint r1 c-tas"></div>
Â  Â  <div id="p3_r1_tr" Â  Â class="fieldPrint r1 c-tr"></div>
Â  Â  <div id="p3_r1_wv" Â  Â class="fieldPrint r1 c-wv"></div>
Â  Â  <div id="p3_r1_hdgt" Â class="fieldPrint r1 c-hdgt"></div>
Â  Â  <div id="p3_r1_hdgm" Â class="fieldPrint r1 c-hdgm"></div>
Â  Â  <div id="p3_r1_gs" Â  Â class="fieldPrint r1 c-gs"></div>
Â  Â  <div id="p3_r1_dist" Â class="fieldPrint r1 c-dist"></div>
Â  Â  <div id="p3_r1_time" Â class="fieldPrint r1 c-time"></div>

Â  Â  <div id="p3_r2_msa" Â  class="fieldPrint r2 c-msa"></div>
Â  Â  <div id="p3_r2_alt" Â  class="fieldPrint r2 c-alt"></div>
Â  Â  <div id="p3_r2_tas" Â  class="fieldPrint r2 c-tas"></div>
Â  Â  <div id="p3_r2_tr" Â  Â class="fieldPrint r2 c-tr"></div>
Â  Â  <div id="p3_r2_wv" Â  Â class="fieldPrint r2 c-wv"></div>
Â  Â  <div id="p3_r2_hdgt" Â class="fieldPrint r2 c-hdgt"></div>
Â  Â  <div id="p3_r2_hdgm" Â class="fieldPrint r2 c-hdgm"></div>
Â  Â  <div id="p3_r2_gs" Â  Â class="fieldPrint r2 c-gs"></div>
Â  Â  <div id="p3_r2_dist" Â class="fieldPrint r2 c-dist"></div>
Â  Â  <div id="p3_r2_time" Â class="fieldPrint r2 c-time"></div>

Â  Â  <div id="p3_r3_msa" Â  class="fieldPrint r3 c-msa"></div>
Â  Â  <div id="p3_r3_alt" Â  class="fieldPrint r3 c-alt"></div>
Â  Â  <div id="p3_r3_tas" Â  class="fieldPrint r3 c-tas"></div>
Â  Â  <div id="p3_r3_tr" Â  Â class="fieldPrint r3 c-tr"></div>
Â  Â  <div id="p3_r3_wv" Â  Â class="fieldPrint r3 c-wv"></div>
Â  Â  <div id="p3_r3_hdgt" Â class="fieldPrint r3 c-hdgt"></div>
Â  Â  <div id="p3_r3_hdgm" Â class="fieldPrint r3 c-hdgm"></div>
Â  Â  <div id="p3_r3_gs" Â  Â class="fieldPrint r3 c-gs"></div>
Â  Â  <div id="p3_r3_dist" Â class="fieldPrint r3 c-dist"></div>
Â  Â  <div id="p3_r3_time" Â class="fieldPrint r3 c-time"></div>

Â  Â  <div id="p3_r4_msa" Â  class="fieldPrint r4 c-msa"></div>
Â  Â  <div id="p3_r4_alt" Â  class="fieldPrint r4 c-alt"></div>
Â  Â  <div id="p3_r4_tas" Â  class="fieldPrint r4 c-tas"></div>
Â  Â  <div id="p3_r4_tr" Â  Â class="fieldPrint r4 c-tr"></div>
Â  Â  <div id="p3_r4_wv" Â  Â class="fieldPrint r4 c-wv"></div>
Â  Â  <div id="p3_r4_hdgt" Â class="fieldPrint r4 c-hdgt"></div>
Â  Â  <div id="p3_r4_hdgm" Â class="fieldPrint r4 c-hdgm"></div>
Â  Â  <div id="p3_r4_gs" Â  Â class="fieldPrint r4 c-gs"></div>
Â  Â  <div id="p3_r4_dist" Â class="fieldPrint r4 c-dist"></div>
Â  Â  <div id="p3_r4_time" Â class="fieldPrint r4 c-time"></div>

Â  Â  <div id="p3_r5_msa" Â  class="fieldPrint r5 c-msa"></div>
Â  Â  <div id="p3_r5_alt" Â  class="fieldPrint r5 c-alt"></div>
Â  Â  <div id="p3_r5_tas" Â  class="fieldPrint r5 c-tas"></div>
Â  Â  <div id="p3_r5_tr" Â  Â class="fieldPrint r5 c-tr"></div>
Â  Â  <div id="p3_r5_wv" Â  Â class="fieldPrint r5 c-wv"></div>
Â  Â  <div id="p3_r5_hdgt" Â class="fieldPrint r5 c-hdgt"></div>
Â  Â  <div id="p3_r5_hdgm" Â class="fieldPrint r5 c-hdgm"></div>
Â  Â  <div id="p3_r5_gs" Â  Â class="fieldPrint r5 c-gs"></div>
Â  Â  <div id="p3_r5_dist" Â class="fieldPrint r5 c-dist"></div>
Â  Â  <div id="p3_r5_time" Â class="fieldPrint r5 c-time"></div>

Â  Â  <div id="p3_fob" Â  Â  Â class="fieldPrint bottom_fob"></div>
Â  Â  <div id="p3_fuelReq" Â class="fieldPrint bottom_fuelReq"></div>
Â  Â  <div id="p3_clearance"class="fieldPrint bottom_clearance"></div>
Â  </div>
</div>

<script>
/* ---------- Local Storage & Waypoint Constants (UPDATED with Coordinates) ---------- */
const STORAGE_KEY = 'dentoNavlogData';
const R_NM = 3440.07; // Radius of Earth in Nautical Miles

// Function to convert DDÂ°MM'SS.SS" to Decimal Degrees
function parseCoordinate(coord) {
Â  Â  if (!coord) return null;
Â  Â  // Regex adjusted to handle potential double quotes if not escaped correctly in original paste
Â  Â  const parts = coord.match(/(\d+)Â°(\d+)'([\d.]+)["]?([NSWE])/);
Â  Â  if (!parts) return null;

Â  Â  let [, deg, min, sec, dir] = parts;
Â  Â  deg = parseInt(deg);
Â  Â  min = parseInt(min);
Â  Â  sec = parseFloat(sec);

Â  Â  let dec = deg + (min / 60) + (sec / 3600);

Â  Â  // Apply sign for South/West
Â  Â  if (dir === 'S' || dir === 'W') {
Â  Â  Â  Â  dec = -dec;
Â  Â  }
Â  Â  return dec;
}

// Coordinate data in raw format, automatically parsed below
const RAW_WAYPOINTS = {
Â  Â  "LCLK": { lat: "34Â°52'23.25\"N", lon: "33Â°37'22.15\"E" },
Â  Â  "LCPH": { lat: "34Â°43'4.14\"N", lon: "32Â°29'1.83\"E" },
Â  Â  "VRP ORANGE GROVE": {}, 
Â  Â  "VRP POWER STATION": {},
Â  Â  "VRP XYLOTYMBOU": {},
Â  Â  "VRP DHEKELIA": {},
Â  Â  "SALT LAKE": { lat: "34Â°53'36.04\"N", lon: "33Â°37'36.58\"E" },
Â  Â  "SIA": { lat: "34Â°57'17.88\"N", lon: "33Â°23'22.33\"E" },
Â  Â  "MOSFILOTI": { lat: "34Â°57'8.99\"N", lon: "33Â°25'31.30\"E" },
Â  Â  "KALOCHORIO": { lat: "34Â°55'40.29\"N", lon: "33Â°32'11.60\"E" },
Â  Â  "ALAMPRA": { lat: "34Â°59'19.21\"N", lon: "33Â°24'3.14\"E" },
Â  Â  "MARKI": { lat: "35Â°1'25.36\"N", lon: "33Â°19'33.79\"E" },
Â  Â  "PERA": {},
Â  Â  "DIPOTAMOS DAM": { lat: "34Â°51'24.08\"N", lon: "33Â°21'17.74\"E" },
Â  Â  "KALAVASOS DAM": { lat: "34Â°48'16.26\"N", lon: "33Â°15'25.48\"E" },
Â  Â  "GERMASOGEIA DAM": { lat: "34Â°44'53.68\"N", lon: "33Â°5'13.02\"E" },
Â  Â  "KOURIS DAM": { lat: "34Â°43'40.06\"N", lon: "32Â°55'5.51\"E" },
Â  Â  "PACHNA": { lat: "34Â°46'41.27\"N", lon: "32Â°46'41.27\"E" }, // Assuming the last value was the correct longitude format
Â  Â  "TRACHYPEDOULA": { lat: "34Â°48'1.96\"N", lon: "32Â°40'44.51\"E" },
Â  Â  "ACHELIA": { lat: "34Â°44'20.55\"N", lon: "32Â°29'10.21\"E" },
Â  Â  "ERGATES": { lat: "35Â°3'15.21\"N", lon: "33Â°14'38.57\"E" }
};

// Converted WAYPOINTS object (filled during initialization)
const WAYPOINTS = {};

/* ---------- Geo/Math Helpers ---------- */

function deg2rad(d){ return d * Math.PI / 180; }
function rad2deg(r){ return r * 180 / Math.PI; }

/**
Â * Calculates True Track (TR) and Distance between two points using the Great Circle method (Haversine).
Â * @param {object} p1 - {lat: number, lon: number} object for the departure point (Decimal Degrees).
Â * @param {object} p2 - {lat: number, lon: number} object for the arrival point (Decimal Degrees).
Â * @returns {object|null} - {tr: number, dist: number} or null if data is missing.
Â */
function calculateTRAndDistance(p1, p2) {
Â  Â  if (typeof p1.lat !== 'number' || typeof p1.lon !== 'number' || 
Â  Â  Â  Â  typeof p2.lat !== 'number' || typeof p2.lon !== 'number') {
Â  Â  Â  Â  return null;
Â  Â  }

Â  Â  const lat1 = deg2rad(p1.lat);
Â  Â  const lon1 = deg2rad(p1.lon);
Â  Â  const lat2 = deg2rad(p2.lat);
Â  Â  const lon2 = deg2rad(p2.lon);

Â  Â  const dLon = lon2 - lon1;

Â  Â  // Haversine formula for distance
Â  Â  const a = Math.sin((lat2 - lat1) / 2) ** 2 + 
Â  Â  Â  Â  Â  Â  Â  Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
Â  Â  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
Â  Â  const dist = R_NM * c;

Â  Â  // Initial True Course (Track)
Â  Â  const y = Math.sin(dLon) * Math.cos(lat2);
Â  Â  const x = Math.cos(lat1) * Math.sin(lat2) - 
Â  Â  Â  Â  Â  Â  Â  Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
Â  Â  
Â  Â  // Check for pole or same point (where x and y might be zero)
Â  Â  if (x === 0 && y === 0) return { tr: 0, dist: 0 };

Â  Â  let tr = Math.atan2(y, x);
Â  Â  tr = (rad2deg(tr) + 360) % 360;

Â  Â  return { tr: tr, dist: dist };
}


/* ---------- METAR API FUNCTION (NEW) ---------- */
async function getMetar() {
Â  Â  const icao = document.getElementById('metarIcao').value.toUpperCase().trim();
Â  Â  const metarOutput = document.getElementById('rawMetar');
Â  Â  const button = document.getElementById('fetchMetarBtn');

Â  Â  if (icao.length !== 4) {
Â  Â  Â  Â  metarOutput.value = "Error: Please enter a valid 4-letter ICAO code.";
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  // Disable button and show loading state
Â  Â  button.textContent = "Fetching...";
Â  Â  button.disabled = true;
Â  Â  metarOutput.value = "Fetching METAR for " + icao + "...";

Â  Â  const apiUrl = `https://aviationweather.gov/api/data/metar?ids=${icao}&format=json`;

Â  Â  try {
Â  Â  Â  Â  const response = await fetch(apiUrl);
Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  throw new Error(`HTTP error! status: ${response.status}`);
Â  Â  Â  Â  }
Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  if (data.length === 0 || !data[0].rawOb) {
Â  Â  Â  Â  Â  Â  metarOutput.value = `No current METAR found for ${icao}.`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  metarOutput.value = data[0].rawOb;
Â  Â  Â  Â  }
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("METAR fetch failed:", error);
Â  Â  Â  Â  metarOutput.value = `Error fetching METAR. Check console for details. (CORS or network issue: ${error.message})`;
Â  Â  } finally {
Â  Â  Â  Â  button.textContent = "â˜ï¸ Get Live METAR";
Â  Â  Â  Â  button.disabled = false;
Â  Â  Â  Â  autoSave(); 
Â  Â  }
}


/* ---------- helper to read / write cells (supports wpField) ---------- */
function getCellValue(row, col) {
Â  Â  const cell = row.children[col];
Â  Â  if (!cell) return "";
Â  Â  // Look for the direct input field first (which gets populated by select)
Â  Â  let el = cell.querySelector("input:not([type='hidden'])");
Â  Â  if (el) return el.value || "";
Â  Â  // Fallback to select if input isn't found/used (primarily for compatibility)
Â  Â  el = cell.querySelector("select");
Â  Â  if (el) return el.value || "";
Â  Â  return "";
}

function setCellValue(row, col, value) {
Â  Â  const cell = row.children[col];
Â  Â  if (!cell) return;
Â  Â  let input = cell.querySelector("input, textarea");
Â  Â  
Â  Â  // Add temporary class for calculated cells (col 7, 8, 9, 10, 12, 13)
Â  Â  if (col >= 7 && col <= 10 || col === 12 || col === 13) {
Â  Â  Â  Â  cell.classList.add('calculated-flash');
Â  Â  Â  Â  setTimeout(() => cell.classList.remove('calculated-flash'), 600);
Â  Â  }
Â  Â  
Â  Â  if (input) input.value = value || "";
Â  Â  const sel = cell.querySelector("select");
Â  Â  if (sel) {
Â  Â  Â  Â  let found = false;
Â  Â  Â  Â  for (const opt of sel.options) {
Â  Â  Â  Â  Â  Â  if (opt.value === value || opt.text === value) {
Â  Â  Â  Â  Â  Â  Â  Â  sel.value = opt.value;
Â  Â  Â  Â  Â  Â  Â  Â  found = true;
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  if (!found) {
Â  Â  Â  Â  Â  Â  sel.value = ""; 
Â  Â  Â  Â  }
Â  Â  }
}

/* Smart handler for waypoint dropdown (fills its own input + next leg FROM) */
function handleWpSelectChange(sel) {
Â  Â  const text = sel.value || (sel.tagName === 'INPUT' ? sel.value : ''); // If input, use its value, else use select value
Â  Â  const row Â = sel.closest("tr");
Â  Â  if (!row) return;

    let selectElement;
    let isToColumn = false;

    // Determine if the change came from a select or an input field within the waypoint cell
    if (sel.tagName === 'SELECT') {
        selectElement = sel;
        // The corresponding input is the next sibling
        const inputElement = sel.nextElementSibling;
        if (inputElement) inputElement.value = text;
    } else if (sel.tagName === 'INPUT') {
        // The corresponding select is the previous sibling
        selectElement = sel.previousElementSibling;
        if (selectElement) selectElement.value = text;
    }

    const cell = sel.closest("td");
    const colIndex = Array.from(row.children).indexOf(cell);
    if (colIndex === 1) isToColumn = true;

Â  Â  const tbody = row.parentElement;
Â  Â  const rows = Array.from(tbody.children);
Â  Â  const rowIndex = rows.indexOf(row);
Â  Â  
Â  Â  let fromWpName = getCellValue(row, 0);
Â  Â  let toWpName = getCellValue(row, 1);
    
    // Auto-fill next leg's FROM if changing TO
Â  Â  if (isToColumn && rowIndex + 1 < rows.length) {
Â  Â  Â  Â  const nextRow = rows[rowIndex + 1];
Â  Â  Â  Â  const nextFromCell = nextRow.children[0];
Â  Â  Â  Â  if (nextFromCell) {
Â  Â  Â  Â  Â  Â  const nextInput Â = nextFromCell.querySelector("input");
Â  Â  Â  Â  Â  Â  const nextSelect = nextFromCell.querySelector("select");
Â  Â  Â  Â  Â  Â  if (nextInput) Â nextInput.value = text;
Â  Â  Â  Â  Â  Â  if (nextSelect) nextSelect.value = text;
Â  Â  Â  Â  }
Â  Â  }


Â  Â  // --- Perform Geo Calculation (TR and Distance) ---
Â  Â  const fromWp = WAYPOINTS[fromWpName];
Â  Â  const toWp = WAYPOINTS[toWpName];
Â  Â  
Â  Â  if (fromWp && toWp && typeof fromWp.lat === 'number' && typeof toWp.lat === 'number') {
Â  Â  Â  Â  const geoResult = calculateTRAndDistance(fromWp, toWp);
Â  Â  Â  Â  if (geoResult) {
Â  Â  Â  Â  Â  Â  setCellValue(row, 5, geoResult.tr.toFixed(0)); // Set TR (Col 5)
Â  Â  Â  Â  Â  Â  setCellValue(row, 11, geoResult.dist.toFixed(1)); // Set Distance (Col 11)
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  calculateAll(); // Trigger full calculation based on new TR/Dist
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  setCellValue(row, 5, "");
Â  Â  Â  Â  Â  Â  setCellValue(row, 11, "");
Â  Â  Â  Â  Â  Â  calculateAll();
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  // Clear calculated fields if coordinates are missing (VRPs, Custom inputs)
Â  Â  Â  Â  setCellValue(row, 5, "");
Â  Â  Â  Â  setCellValue(row, 11, "");
Â  Â  Â  Â  calculateAll();
Â  Â  }
Â  Â  autoSave(); // Save changes
}

// Helper to create waypoint options
function createWpOptions() {
Â  Â  // Use the keys of the WAYPOINTS object
Â  Â  return Object.keys(WAYPOINTS).map(key => `<option value="${key}">${key}</option>`).join('');
}

// Add row (modified for autoSave integration)
function addRow() {
Â  Â  const wpOptions = createWpOptions();
Â  Â  const rowHTML = `
Â  Â  <tr>
Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  <div class="wpField">
Â  Â  Â  Â  Â  Â  Â  Â  <select onchange="handleWpSelectChange(this);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value=""></option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${wpOptions}
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  <input oninput="handleWpSelectChange(this); autoSave();">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </td>
Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  <div class="wpField">
Â  Â  Â  Â  Â  Â  Â  Â  <select onchange="handleWpSelectChange(this);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value=""></option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${wpOptions}
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  <input oninput="handleWpSelectChange(this); autoSave();">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </td>
Â  Â  Â  Â  <td><input type="number" min="0" oninput="autoSave()"></td>
Â  Â  Â  Â  <td><input type="number" min="0" oninput="autoSave()"></td>
Â  Â  Â  Â  <td><input type="number" min="0" value="95" oninput="autoSave()"></td>
Â  Â  Â  Â  <td><input type="number" min="0" max="360" oninput="autoSave()"></td>
Â  Â  Â  Â  <td><input placeholder="ddd/ss" oninput="autoSave()"></td>
Â  Â  Â  Â  <td><input readonly></td>
Â  Â  Â  Â  <td><input readonly></td>
Â  Â  Â  Â  <td><input readonly></td>
Â  Â  Â  Â  <td><input readonly></td>
Â  Â  Â  Â  <td><input type="number" min="0" oninput="autoSave()"></td>
Â  Â  Â  Â  <td><input readonly></td>
Â  Â  Â  Â  <td><input readonly></td>
Â  Â  Â  Â  <td><input oninput="autoSave()"></td>
Â  Â  </tr>`;
Â  Â  document.querySelector("#navlog tbody").insertAdjacentHTML("beforeend", rowHTML);
Â  Â  // Re-bind listeners for new elements inside the row
Â  Â  setupAutoSaveListeners(document.querySelector("#navlog tbody tr:last-child"));
Â  Â  autoSave(); // Save after adding a row
}

function calculateAll() {
Â  Â  const variation = parseFloat(document.getElementById("variation").value) || 0;
Â  Â  const fuelburn = parseFloat(document.getElementById("fuelburn").value) || 0;
Â  Â  const depTimeStr = document.getElementById("depTime").value || "08:00";

Â  Â  let rows = document.querySelectorAll("#navlog tbody tr");
Â  Â  let cumulativeMinutes = 0;
Â  Â  let totalDist = 0;
Â  Â  let totalTimeMin = 0;

Â  Â  rows.forEach(row => {
Â  Â  Â  Â  const TAS Â = parseFloat(getCellValue(row, 4)) || 0;
Â  Â  Â  Â  const TR Â  = parseFloat(getCellValue(row, 5)) || 0;
Â  Â  Â  Â  const windStr = getCellValue(row, 6).trim();
Â  Â  Â  Â  const dist = parseFloat(getCellValue(row, 11)) || 0;

Â  Â  Â  Â  let wDir = 0, wSpd = 0;
Â  Â  Â  Â  if (windStr.includes("/")) {
Â  Â  Â  Â  Â  Â  const parts = windStr.split("/");
Â  Â  Â  Â  Â  Â  wDir = parseFloat(parts[0]) || 0;
Â  Â  Â  Â  Â  Â  wSpd = parseFloat(parts[1]) || 0;
Â  Â  Â  Â  }

Â  Â  Â  Â  let rel = deg2rad(wDir - TR);
Â  Â  Â  Â  let WCA = 0;
Â  Â  Â  Â  if (TAS > 0) {
Â  Â  Â  Â  Â  Â  let x = (wSpd / TAS) * Math.sin(rel);
Â  Â  Â  Â  Â  Â  if (x > 1) x = 1;
Â  Â  Â  Â  Â  Â  if (x < -1) x = -1;
Â  Â  Â  Â  Â  Â  WCA = rad2deg(Math.asin(x));
Â  Â  Â  Â  }
Â  Â  Â  Â  let HDG_T = (TR + WCA + 360) % 360; // Normalize to 0-359
Â  Â  Â  Â  let GS = TAS - wSpd * Math.cos(rel);
Â  Â  Â  Â  if (!isFinite(GS) || GS <= 0) GS = TAS;

Â  Â  Â  Â  let legMin = 0;
Â  Â  Â  Â  if (GS > 0 && dist > 0) {
Â  Â  Â  Â  Â  Â  legMin = dist / GS * 60;
Â  Â  Â  Â  }

Â  Â  Â  Â  cumulativeMinutes += legMin;
Â  Â  Â  Â  totalDist += dist;
Â  Â  Â  Â  totalTimeMin += legMin;

Â  Â  Â  Â  const eta = computeETA(depTimeStr, cumulativeMinutes);
Â  Â  Â  Â  let HDG_M = (HDG_T - variation + 360) % 360; // Normalize to 0-359

Â  Â  Â  Â  setCellValue(row, 7, Â WCA.toFixed(1));
Â  Â  Â  Â  setCellValue(row, 8, Â HDG_T.toFixed(0));
Â  Â  Â  Â  setCellValue(row, 9, Â HDG_M.toFixed(0));
Â  Â  Â  Â  setCellValue(row,10, GS.toFixed(0));
Â  Â  Â  Â  setCellValue(row,12, legMin ? legMin.toFixed(0) + " min" : "");
Â  Â  Â  Â  setCellValue(row,13, eta);
Â  Â  });

Â  Â  document.getElementById("totalDist").value = totalDist.toFixed(1);

Â  Â  const hours = totalTimeMin / 60;
Â  Â  const fuelReq = hours * fuelburn;
Â  Â  document.getElementById("fuelReq").value = fuelReq ? fuelReq.toFixed(1) + " L" : "";
Â  Â  
Â  Â  autoSave(); // Save immediately after calculation
}

function computeETA(depTimeStr, addedMin) {
Â  Â  const [h,m] = depTimeStr.split(":").map(x => parseInt(x) || 0);
Â  Â  const base = new Date("2025-01-01T00:00:00");
Â  Â  base.setHours(h,m,0,0);
Â  Â  base.setMinutes(base.getMinutes() + addedMin);
Â  Â  const hh = String(base.getHours()).padStart(2,"0");
Â  Â  const mm = String(base.getMinutes()).padStart(2,"0");
Â  Â  return `${hh}:${mm}`;
}

/* ---------- Local Storage Autosave/Autoload ---------- */

function autoSave() {
Â  Â  const data = {
Â  Â  Â  Â  top: {
Â  Â  Â  Â  Â  Â  pilot: document.getElementById("pilot").value,
Â  Â  Â  Â  Â  Â  acreg: document.getElementById("acreg").value,
Â  Â  Â  Â  Â  Â  from: document.getElementById("from").value,
Â  Â  Â  Â  Â  Â  to: document.getElementById("to").value,
Â  Â  Â  Â  Â  Â  plannedTime: document.getElementById("plannedTime").value,
Â  Â  Â  Â  Â  Â  alt: document.getElementById("alt").value,
Â  Â  Â  Â  Â  Â  altDist: document.getElementById("altDist").value,
Â  Â  Â  Â  Â  Â  depTime: document.getElementById("depTime").value,
Â  Â  Â  Â  Â  Â  variation: document.getElementById("variation").value,
Â  Â  Â  Â  Â  Â  fuelburn: document.getElementById("fuelburn").value,
Â  Â  Â  Â  Â  Â  brakesOff: document.getElementById("brakesOff").value,
Â  Â  Â  Â  Â  Â  brakesOn: document.getElementById("brakesOn").value,
Â  Â  Â  Â  Â  Â  tkofInfo: document.getElementById("tkofInfo").value,
Â  Â  Â  Â  Â  Â  ldgInfo: document.getElementById("ldgInfo").value,
Â  Â  Â  Â  Â  Â  fob: document.getElementById("fob").value,
Â  Â  Â  Â  Â  Â  clearance: document.getElementById("clearance").value,
Â  Â  Â  Â  Â  Â  // Save METAR data
Â  Â  Â  Â  Â  Â  metarIcao: document.getElementById("metarIcao").value,
Â  Â  Â  Â  Â  Â  rawMetar: document.getElementById("rawMetar").value
Â  Â  Â  Â  },
Â  Â  Â  Â  rows: [],
Â  Â  Â  Â  stations: []
Â  Â  };

Â  Â  document.querySelectorAll("#navlog tbody tr").forEach(r => {
Â  Â  Â  Â  const rowData = [];
Â  Â  Â  Â  for (let i = 0; i < r.children.length; i++) {
Â  Â  Â  Â  Â  Â  rowData.push(getCellValue(r, i));
Â  Â  Â  Â  }
Â  Â  Â  Â  data.rows.push(rowData);
Â  Â  });

Â  Â  document.querySelectorAll("fieldset legend + table tbody tr").forEach(r => {
Â  Â  Â  Â  data.stations.push(Array.from(r.children).map(c => {
Â  Â  Â  Â  Â  Â  const inp = c.querySelector("input");
Â  Â  Â  Â  Â  Â  return inp ? inp.value : "";
Â  Â  Â  Â  }));
Â  Â  });

Â  Â  try {
Â  Â  Â  Â  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
Â  Â  Â  Â  // console.log("Navlog data auto-saved.");
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Could not save data to local storage:", e);
Â  Â  }
}

function createNavlogRowHtml() {
Â  Â  const wpOptions = createWpOptions();
Â  Â  return `
Â  Â  <tr>
Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  <div class="wpField">
Â  Â  Â  Â  Â  Â  Â  Â  <select onchange="handleWpSelectChange(this);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value=""></option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${wpOptions}
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  <input oninput="handleWpSelectChange(this); autoSave();">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </td>
Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  <div class="wpField">
Â  Â  Â  Â  Â  Â  Â  Â  <select onchange="handleWpSelectChange(this);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value=""></option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${wpOptions}
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  <input oninput="handleWpSelectChange(this); autoSave();">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </td>
Â  Â  Â  Â  <td><input type="number" min="0" oninput="autoSave()"></td>
Â  Â  Â  Â  <td><input type="number" min="0" oninput="autoSave()"></td>
Â  Â  Â  Â  <td><input type="number" min="0" value="95" oninput="autoSave()"></td>
Â  Â  Â  Â  <td><input type="number" min="0" max="360" oninput="autoSave()"></td>
Â  Â  Â  Â  <td><input placeholder="ddd/ss" oninput="autoSave()"></td>
Â  Â  Â  Â  <td><input readonly></td>
Â  Â  Â  Â  <td><input readonly></td>
Â  Â  Â  Â  <td><input readonly></td>
Â  Â  Â  Â  <td><input readonly></td>
Â  Â  Â  Â  <td><input type="number" min="0" oninput="autoSave()"></td>
Â  Â  Â  Â  <td><input readonly></td>
Â  Â  Â  Â  <td><input readonly></td>
Â  Â  Â  Â  <td><input oninput="autoSave()"></td>
Â  Â  </tr>`;
}

function loadDataToForm(data) {
Â  Â  // Load Top Info
Â  Â  const t = data.top || {};
Â  Â  document.getElementById("pilot").value = t.pilot || "";
Â  Â  document.getElementById("acreg").value = t.acreg || "";
Â  Â  document.getElementById("from").value = t.from || "";
Â  Â  document.getElementById("to").value = t.to || "";
Â  Â  document.getElementById("plannedTime").value = t.plannedTime || "";
Â  Â  document.getElementById("alt").value = t.alt || "";
Â  Â  document.getElementById("altDist").value = t.altDist || "";
Â  Â  document.getElementById("depTime").value = t.depTime || "08:00"; 
Â  Â  document.getElementById("variation").value = t.variation || "4"; 
Â  Â  document.getElementById("fuelburn").value = t.fuelburn || "10"; 
Â  Â  document.getElementById("brakesOff").value = t.brakesOff || "";
Â  Â  document.getElementById("brakesOn").value = t.brakesOn || "";
Â  Â  document.getElementById("tkofInfo").value = t.tkofInfo || "";
Â  Â  document.getElementById("ldgInfo").value = t.ldgInfo || "";
Â  Â  document.getElementById("fob").value = t.fob || "";
Â  Â  document.getElementById("clearance").value = t.clearance || "";
Â  Â  // Load METAR data
Â  Â  document.getElementById("metarIcao").value = t.metarIcao || "";
Â  Â  document.getElementById("rawMetar").value = t.rawMetar || "";

Â  Â  // Load Navlog Rows
Â  Â  const tbody = document.querySelector("#navlog tbody");
Â  Â  tbody.innerHTML = "";
Â  Â  (data.rows || []).forEach(rowArr => {
Â  Â  Â  Â  tbody.insertAdjacentHTML("beforeend", createNavlogRowHtml());
Â  Â  Â  Â  
Â  Â  Â  Â  const last = tbody.querySelector("tr:last-child");
Â  Â  Â  Â  rowArr.forEach((val, i) => {
Â  Â  Â  Â  Â  Â  setCellValue(last, i, val);
Â  Â  Â  Â  });
Â  Â  });

Â  Â  // Load Stations
Â  Â  const stationRows = document.querySelectorAll("fieldset legend + table tbody tr");
Â  Â  (data.stations || []).forEach((rowArr, rowIndex) => {
Â  Â  Â  Â  if (stationRows[rowIndex]) {
Â  Â  Â  Â  Â  Â  rowArr.forEach((val, colIndex) => {
Â  Â  Â  Â  Â  Â  Â  Â  const inp = stationRows[rowIndex].children[colIndex].querySelector("input");
Â  Â  Â  Â  Â  Â  Â  Â  if (inp) inp.value = val;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // Re-run calculations for consistency and visual feedback
Â  Â  calculateAll();
}

function autoLoad() {
Â  Â  try {
Â  Â  Â  Â  const savedData = localStorage.getItem(STORAGE_KEY);
Â  Â  Â  Â  if (!savedData) return false;

Â  Â  Â  Â  const data = JSON.parse(savedData);
Â  Â  Â  Â  loadDataToForm(data);
Â  Â  Â  Â  
Â  Â  Â  Â  // console.log("Navlog data auto-loaded.");
Â  Â  Â  Â  return true; // Data was loaded
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Could not load data from local storage:", e);
Â  Â  Â  Â  return false; // Load failed
Â  Â  }
}

function manualSave() {
Â  Â  // Force a save to ensure all current data is collected
Â  Â  autoSave(); 

Â  Â  // Retrieve the data saved by autoSave
Â  Â  const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
Â  Â  
Â  Â  // Download logic
Â  Â  const blob = new Blob([JSON.stringify(data)], {type:"application/json"});
Â  Â  const a = document.createElement("a");
Â  Â  a.href = URL.createObjectURL(blob);
Â  Â  a.download = "navlog_dento.json";
Â  Â  a.click();
}

function manualLoad() {
Â  Â  const input = document.createElement("input");
Â  Â  input.type = "file";
Â  Â  input.accept = ".json";
Â  Â  input.onchange = e => {
Â  Â  Â  Â  const file = e.target.files[0];
Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = () => {
Â  Â  Â  Â  Â  Â  const data = JSON.parse(reader.result);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Load the data from the JSON file
Â  Â  Â  Â  Â  Â  loadDataToForm(data);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Re-run setup to bind listeners to new elements and save
Â  Â  Â  Â  Â  Â  setupAutoSaveListeners();
Â  Â  Â  Â  Â  Â  autoSave(); 
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.readAsText(file);
Â  Â  };
Â  Â  input.click();
}

/* ---------- Event Listener Setup and Init (UPDATED) ---------- */

function setupAutoSaveListeners(root = document) {
Â  Â  // Listen for changes on all key input and textarea fields
Â  Â  // We ignore elements that already have inline oninput/onchange listeners
Â  Â  const inputs = root.querySelectorAll('input:not([readonly]):not([type="hidden"]):not([oninput]), textarea, select:not([onchange])');
Â  Â  inputs.forEach(input => {
Â  Â  Â  Â  // Remove existing listener to prevent duplicates
Â  Â  Â  Â  input.removeEventListener('input', autoSave);
Â  Â  Â  Â  input.removeEventListener('change', autoSave);

Â  Â  Â  Â  if (input.tagName === 'SELECT') {
Â  Â  Â  Â  Â  Â  input.addEventListener('change', autoSave);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  input.addEventListener('input', autoSave);
Â  Â  Â  Â  }
Â  Â  });
}

function initializeWaypoints() {
    // Convert RAW_WAYPOINTS to decimal degrees once at startup
    for (const name in RAW_WAYPOINTS) {
        const raw = RAW_WAYPOINTS[name];
        WAYPOINTS[name] = {
            lat: raw.lat ? parseCoordinate(raw.lat) : null,
            lon: raw.lon ? parseCoordinate(raw.lon) : null,
            name: name
        };
    }
}

window.onload = function() {
    initializeWaypoints();
    
Â  Â  const dataLoaded = autoLoad(); // Attempt to load saved data
Â  Â  
Â  Â  if (!dataLoaded || document.querySelectorAll("#navlog tbody tr").length === 0) {
Â  Â  Â  Â  // Only add default rows if no data was loaded or if the table is empty
Â  Â  Â  Â  addRow(); 
Â  Â  Â  Â  addRow();
Â  Â  Â  Â  // Recalculate and save initial state
Â  Â  Â  Â  calculateAll();
Â  Â  Â  Â  autoSave();
Â  Â  }
Â  Â  
Â  Â  // Set up listeners for all existing and newly loaded elements
Â  Â  setupAutoSaveListeners();
};


/* -------- overlay helpers (kept unchanged) -------- */

function fillTopOverlay(prefix) {
Â  Â  document.getElementById(prefix + "_pilot").textContent Â  Â  = document.getElementById("pilot").value;
Â  Â  document.getElementById(prefix + "_acreg").textContent Â  Â  = document.getElementById("acreg").value;
Â  Â  document.getElementById(prefix + "_from").textContent Â  Â  Â = document.getElementById("from").value;
Â  Â  document.getElementById(prefix + "_to").textContent Â  Â  Â  Â = document.getElementById("to").value;
Â  Â  document.getElementById(prefix + "_distance").textContent Â = document.getElementById("totalDist").value;
Â  Â  document.getElementById(prefix + "_fltTime").textContent Â  = document.getElementById("plannedTime").value;
Â  Â  document.getElementById(prefix + "_alt").textContent Â  Â  Â  = document.getElementById("alt").value;
Â  Â  document.getElementById(prefix + "_altDist").textContent Â  = document.getElementById("altDist").value;
Â  Â  document.getElementById(prefix + "_brakesOff").textContent = document.getElementById("brakesOff").value;
Â  Â  document.getElementById(prefix + "_brakesOn").textContent Â = document.getElementById("brakesOn").value;
Â  Â  document.getElementById(prefix + "_tkofInfo").textContent Â = document.getElementById("tkofInfo").value;
Â  Â  document.getElementById(prefix + "_ldgInfo").textContent Â  = document.getElementById("ldgInfo").value;
Â  Â  document.getElementById(prefix + "_fob").textContent Â  Â  Â  = document.getElementById("fob").value;
Â  Â  document.getElementById(prefix + "_fuelReq").textContent Â  = document.getElementById("fuelReq").value;
Â  Â  document.getElementById(prefix + "_clearance").textContent = document.getElementById("clearance").value;
}

function fillPageLeg(prefix, slotIndex, row) {
Â  Â  const fromDiv = document.getElementById(`${prefix}_r${slotIndex}_from`);
Â  Â  const toDiv Â  = document.getElementById(`${prefix}_r${slotIndex}_to`);
Â  Â  const msaDiv Â = document.getElementById(`${prefix}_r${slotIndex}_msa`);
Â  Â  const altDiv Â = document.getElementById(`${prefix}_r${slotIndex}_alt`);
Â  Â  const tasDiv Â = document.getElementById(`${prefix}_r${slotIndex}_tas`);
Â  Â  const trDiv Â  = document.getElementById(`${prefix}_r${slotIndex}_tr`);
Â  Â  const wvDiv Â  = document.getElementById(`${prefix}_r${slotIndex}_wv`);
Â  Â  const hdgtDiv = document.getElementById(`${prefix}_r${slotIndex}_hdgt`);
Â  Â  const hdgmDiv = document.getElementById(`${prefix}_r${slotIndex}_hdgm`);
Â  Â  const gsDiv Â  = document.getElementById(`${prefix}_r${slotIndex}_gs`);
Â  Â  const distDiv = document.getElementById(`${prefix}_r${slotIndex}_dist`);
Â  Â  const timeDiv = document.getElementById(`${prefix}_r${slotIndex}_time`);

Â  Â  if (!row) {
Â  Â  Â  Â  if (fromDiv) fromDiv.textContent = "";
Â  Â  Â  Â  if (toDiv) Â  toDiv.textContent Â  = "";
Â  Â  Â  Â  if (msaDiv) Â msaDiv.textContent Â = "";
Â  Â  Â  Â  if (altDiv) Â altDiv.textContent Â = "";
Â  Â  Â  Â  if (tasDiv) Â tasDiv.textContent Â = "";
Â  Â  Â  Â  if (trDiv) Â  trDiv.textContent Â  = "";
Â  Â  Â  Â  if (wvDiv) Â  wvDiv.textContent Â  = "";
Â  Â  Â  Â  if (hdgtDiv) hdgtDiv.textContent = "";
Â  Â  Â  Â  if (hdgmDiv) hdgmDiv.textContent = "";
Â  Â  Â  Â  if (gsDiv) Â  gsDiv.textContent Â  = "";
Â  Â  Â  Â  if (distDiv) distDiv.textContent = "";
Â  Â  Â  Â  if (timeDiv) timeDiv.textContent = "";
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const from Â = getCellValue(row, 0);
Â  Â  const to Â  Â = getCellValue(row, 1);
Â  Â  const msa Â  = getCellValue(row, 2);
Â  Â  const alt Â  = getCellValue(row, 3);
Â  Â  const tas Â  = getCellValue(row, 4);
Â  Â  const tr Â  Â = getCellValue(row, 5);
Â  Â  const wv Â  Â = getCellValue(row, 6);
Â  Â  const hdgt Â = getCellValue(row, 8);
Â  Â  const hdgm Â = getCellValue(row, 9);
Â  Â  const gs Â  Â = getCellValue(row,10);
Â  Â  const dist Â = getCellValue(row,11);
Â  Â  const time Â = getCellValue(row,12);

Â  Â  if (fromDiv) fromDiv.textContent = from;
Â  Â  if (toDiv) Â  toDiv.textContent Â  = to;
Â  Â  if (msaDiv) Â msaDiv.textContent Â = msa;
Â  Â  if (altDiv) Â altDiv.textContent Â = alt;
Â  Â  if (tasDiv) Â tasDiv.textContent Â = tas;
Â  Â  if (trDiv) Â  trDiv.textContent Â  = tr;
Â  Â  if (wvDiv) Â  wvDiv.textContent Â  = wv;
Â  Â  if (hdgtDiv) hdgtDiv.textContent = hdgt;
Â  Â  if (hdgmDiv) hdgmDiv.textContent = hdgm;
Â  Â  if (gsDiv) Â  gsDiv.textContent Â  = gs;
Â  Â  if (distDiv) distDiv.textContent = dist;
Â  Â  if (timeDiv) timeDiv.textContent = time;
}

function fillOverlayFromForm() {
Â  Â  const rows = Array.from(document.querySelectorAll("#navlog tbody tr"));

Â  Â  const page2 = document.getElementById("page2");
Â  Â  const page3 = document.getElementById("page3");

Â  Â  // Show/hide second & third pages depending on leg count
Â  Â  page2.style.display = rows.length > 5 Â ? "block" : "none";
Â  Â  page3.style.display = rows.length > 10 ? "block" : "none";

Â  Â  // Page 1: legs 1â€“5
Â  Â  fillTopOverlay("p1");
Â  Â  for (let i = 0; i < 5; i++) {
Â  Â  Â  Â  fillPageLeg("p1", i+1, rows[i] || null);
Â  Â  }

Â  Â  // Page 2: legs 6â€“10
Â  Â  if (rows.length > 5) {
Â  Â  Â  Â  fillTopOverlay("p2");
Â  Â  Â  Â  for (let i = 0; i < 5; i++) {
Â  Â  Â  Â  Â  Â  fillPageLeg("p2", i+1, rows[5 + i] || null);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // Page 3: legs 11â€“15
Â  Â  if (rows.length > 10) {
Â  Â  Â  Â  fillTopOverlay("p3");
Â  Â  Â  Â  for (let i = 0; i < 5; i++) {
Â  Â  Â  Â  Â  Â  fillPageLeg("p3", i+1, rows[10 + i] || null);
Â  Â  Â  Â  }
Â  Â  }
}

function previewOverlay() {
Â  Â  fillOverlayFromForm();
Â  Â  document.body.classList.add("show-overlay");
}

function closeOverlay() {
Â  Â  document.body.classList.remove("show-overlay");
}

function exportPDF(){
Â  Â  fillOverlayFromForm();
Â  Â  window.print();
}

</script>
</body>
</html>