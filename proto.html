<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Dento Digital NAVLOG</title>
<style>
    /* --- PROFESSIONAL LOOK & FEEL --- */
    body {
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; /* Modern Font Stack */
        background: #f7f7f7; /* Clean Off-white background */
        margin: 0;
        color: #333;
    }
    h1 {
        background: #002147; /* Rich Navy Blue Header */
        color: white;
        margin: 0;
        padding: 16px 25px; /* Increased vertical padding */
        font-size: 24px;
        letter-spacing: 0.5px;
    }
    h5 {
        background: #002147;
        color: #b0c4de;
        margin: 0;
        padding: 0 25px 10px;
        font-weight: normal;
        font-size: 11px;
        text-transform: uppercase;
    }
    .container {
        padding: 20px 25px; /* Increased padding */
    }
    fieldset {
        border: 1px solid #d4d4d4; /* Lighter border for clean look */
        margin-bottom: 15px;
        background: #fff;
        border-radius: 6px; /* Subtle rounding */
        padding: 15px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* Soft drop shadow */
    }
    legend {
        padding: 0 8px;
        font-weight: 600; /* Slightly bolder */
        color: #002147; /* Match header color */
        font-size: 13px;
    }
    .row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px; /* Increased gap */
        margin-bottom: 10px;
        align-items: flex-end; /* Align inputs to the bottom */
    }
    /* New style for Metar area */
    .metar-row {
        display: flex;
        align-items: flex-start;
        gap: 20px;
        margin-top: 15px;
    }
    .metar-input-group {
        display: flex;
        flex-direction: column;
        flex-basis: 250px;
        flex-shrink: 0;
    }
    .metar-output {
        flex-grow: 1;
        min-width: 300px;
    }
    .field {
        display: flex;
        flex-direction: column;
        font-size: 12px;
        flex-grow: 1; /* Allow fields to grow */
    }
    .field label {
        margin-bottom: 4px;
        color: #555;
    }
    .field input, .field textarea, .wpField input, .wpField select {
        padding: 8px;
        min-width: 100px;
        border: 1px solid #ccc;
        font-size: 13px; /* Slightly larger font */
        border-radius: 4px;
        transition: border-color 0.2s, box-shadow 0.2s; /* ANIMATION */
    }
    .field input:focus, .field textarea:focus, .wpField input:focus, .wpField select:focus {
        border-color: #007bff; /* Accent blue focus */
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25); /* Subtle glow */
        outline: none;
    }
    textarea {
        width: 100%;
        min-height: 100px; /* Increased height */
        resize: vertical;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
        margin-top: 15px;
        border-radius: 4px;
        overflow: hidden; /* Ensures rounded corners */
    }
    th {
        background: #e9ecef; /* Light gray header */
        color: #333;
        font-weight: 600;
        border: 1px solid #ccc;
        padding: 8px 4px;
        font-size: 12px;
        text-transform: uppercase;
    }
    td {
        border: 1px solid #e0e0e0; /* Lighter cell borders */
        padding: 6px 4px;
        text-align: center;
        font-size: 12px;
    }
    /* Zebra Striping for table clarity */
    #navlog tbody tr:nth-child(even) {
        background-color: #f9f9f9;
    }
    input[readonly] {
        background: #e9ecef; /* Slightly darker read-only background */
        color: #555;
        font-weight: bold;
    }
    button {
        padding: 10px 15px;
        margin: 4px 6px 10px 0;
        border: none;
        background: #007bff; /* Accent Blue button */
        color: white;
        cursor: pointer;
        border-radius: 4px;
        font-size: 13px;
        font-weight: 600;
        transition: background 0.2s, transform 0.2s; /* ANIMATION */
    }
    button:hover {
        background: #0056b3; /* Darker blue on hover */
        transform: translateY(-1px); /* Subtle lift ANIMATION */
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    button:active {
        transform: translateY(0);
    }
    /* Special button color for calculation */
    button[onclick*="calculateAll"] {
        background: #28a745; /* Green for Calculate */
    }
    button[onclick*="calculateAll"]:hover {
        background: #1e7e34;
    }
    /* Special button color for METAR */
    #fetchMetarBtn {
        background: #ffc107; /* Yellow/Amber for Weather */
        color: #333;
    }
    #fetchMetarBtn:hover {
        background: #e0a800;
    }

    /* waypoint field (dropdown + input) */
    .wpField {
        display: flex;
        flex-direction: column;
    }
    .wpField select {
        font-size: 12px;
        padding: 6px;
        margin-bottom: 4px;
    }

    /* ---------- PRINT OVERLAY (Excel layout) ---------- */

    /* Hidden by default on screen */
    #printSheetWrapper {
        display: none;
    }

    /* Show overlay + hide editor in preview mode */
    body.show-overlay #printSheetWrapper {
        display: block;
    }
    body.show-overlay #editor,
    body.show-overlay h1,
    body.show-overlay h5 {
        display: none;
    }

    .printPage {
        position: relative;
        width: 210mm;   /* A4 portrait */
        height: 297mm;
        background: url("navlog_excel_template.png") no-repeat center;
        background-size: contain;
        page-break-after: always;
    }
    .fieldPrint {
        position: absolute;
        font-size: 9pt;
        white-space: nowrap;
    }

    #overlayCloseBtn {
        position: absolute;
        top: 8px;
        right: 8px;
        padding: 4px 8px;
        background: rgba(0,0,0,0.65);
        color: #fff;
        border: none;
        font-size: 11px;
        cursor: pointer;
        border-radius: 3px;
        z-index: 10;
    }

    /* ---- Tuned positions ---- */
    /* Top flight info (same on all pages) */
    .top_pilot     { top: 13.4%; left: 38%; width: 30%; }
    .top_acreg     { top: 13.5%; left: 77%; width: 20%; }

    .top_from      { top: 15.3%; left: 40%; width: 30%; }
    .top_to        { top: 15.3%; left: 78%; width: 20%; }

    .top_distance  { top: 18%;  left: 41%; width: 20%; }
    .top_fltTime   { top: 18%;  left: 81%; width: 20%; }

    .top_alt       { top: 20%;  left: 40%; width: 30%; }
    .top_altDist   { top: 20%;  left: 82%; width: 20%; }

    .top_brakesOff { top: 21.5%; left: 27%; width: 15%; }
    .top_brakesOn  { top: 23%;  left: 27%; width: 15%; }

    .top_tkofInfo  { top: 21.5%; left: 58%; width: 30%; }
    .top_ldgInfo   { top: 22.78%;  left: 58%; width: 30%; }

    /* MAIN ROW TOPS FOR OTHER COLUMNS (MSA / ALT / TAS / etc.) */
    .r1 { top: 27%; }
    .r2 { top: 32%; }
    .r3 { top: 36%; }
    .r4 { top: 40%; }
    .r5 { top: 44%; }

    .c-from { left: 6%;  width: 15%; }
    .c-msa  { left: 22%; width: 6%;  }
    .c-alt  { left: 29%; width: 6%;  }
    .c-tas  { left: 37%; width: 6%;  }
    .c-tr   { left: 42%; width: 6%;  }
    .c-wv   { left: 47%; width: 8%;  }
    .c-hdgt { left: 54%; width: 6%;  }
    .c-hdgm { left: 60%; width: 6%;  }
    .c-gs   { left: 67%; width: 6%;  }
    .c-dist { left: 73%; width: 6%;  }
    .c-time { left: 79%; width: 6%;  }

    /* FROM/TO COLUMN ‚Äì separate line per row */
    .r1_from { top: 25.5%;  }
    .r1_to   { top: 28.4%;  }
    .r2_from { top: 29.5%;  }
    .r2_to   { top: 32%;  }
    .r3_from { top: 33.5%;  }
    .r3_to   { top: 36.2%;  }
    .r4_from { top: 37.5%;  }
    .r4_to   { top: 40%;  }
    .r5_from { top: 41.6%;  }
    .r5_to   { top: 44%;  }

    /* Fuel + clearance */
    .bottom_fob      { top: 52%; left: 25%; width: 15%; }
    .bottom_fuelReq  { top: 53.5%; left: 25%; width: 15%; }
    .bottom_clearance{ top: 47%; left: 35%; width: 55%; height: 18%; white-space: pre-wrap; }
    /* End of tuned positions - DO NOT CHANGE LINES ABOVE THIS COMMENT */

    /* ANIMATION FOR CALCULATED FIELDS (optional visual feedback) */
    @keyframes flashGreen {
        0% { background-color: #fff; }
        50% { background-color: #e6ffed; } /* Light green flash */
        100% { background-color: #fff; }
    }
    .calculated-flash {
        animation: flashGreen 0.6s ease-out;
    }
    #navlog tbody tr:nth-child(even) .calculated-flash {
        animation: flashGreen 0.6s ease-out;
    }

    /* PRINT MODE */
    @media print {
        body { background: #fff; }
        #editor, h1, h5 { display: none !important; }
        #printSheetWrapper { display: block !important; }
        button { display: none !important; }
    }
</style>
</head>
<body>

<h1>Dento Digital Navlog</h1>
<h5>CREATED BY MICHAEL MITRY</H5>

<div id="editor" class="container">

<fieldset>
<legend>Flight Info</legend>
<div class="row">
    <div class="field">
        <label>Pilot</label>
        <input id="pilot">
    </div>
    <div class="field">
        <label>A/C Reg</label>
        <input id="acreg">
    </div>
    <div class="field">
        <label>From</label>
        <input id="from">
    </div>
    <div class="field">
        <label>To</label>
        <input id="to">
    </div>
    <div class="field">
        <label>Total Distance (NM)</label>
        <input id="totalDist" readonly>
    </div>
    <div class="field">
        <label>Planned Flight Time</label>
        <input id="plannedTime" placeholder="hh:mm">
    </div>
</div>

<div class="row">
    <div class="field">
        <label>Alternate</label>
        <input id="alt">
    </div>
    <div class="field">
        <label>Alt Distance (NM)</label>
        <input id="altDist">
    </div>
    <div class="field">
        <label>Dep Time (UTC / LT)</label>
        <input id="depTime" value="08:00" placeholder="hh:mm">
    </div>
    <div class="field">
        <label>Variation (E+ / W-)</label>
        <input id="variation" value="4">
    </div>
    <div class="field">
        <label>Fuel Burn (L/hr)</label>
        <input id="fuelburn" value="10">
    </div>
</div>

<div class="metar-row">
    <div class="metar-input-group">
        <label for="metarIcao">METAR Station (ICAO)</label>
        <input id="metarIcao" placeholder="e.g., LCLK or LCPH" oninput="autoSave()">
        <button id="fetchMetarBtn" onclick="getMetar()">‚òÅÔ∏è Get Live METAR</button>
    </div>
    <div class="metar-output">
        <label for="rawMetar">Raw METAR Report</label>
        <textarea id="rawMetar" readonly placeholder="METAR data will appear here..."></textarea>
    </div>
</div>
</fieldset>

<fieldset>
<legend>Brakes / Runway / Temperature</legend>
<div class="row">
    <div class="field">
        <label>Brakes Off</label>
        <input id="brakesOff" placeholder="hh:mm">
    </div>
    <div class="field">
        <label>Brakes On</label>
        <input id="brakesOn" placeholder="hh:mm">
    </div>
    <div class="field">
        <label>Takeoff RWY / Wind / Temp</label>
        <input id="tkofInfo" placeholder="e.g. 2000' 040/10 +20¬∞C">
    </div>
    <div class="field">
        <label>Landing RWY / Wind / Temp</label>
        <input id="ldgInfo" placeholder="e.g. 5000' 220/12 +24¬∞C">
    </div>
</div>
</fieldset>

<button onclick="addRow()">‚ûï Add Waypoint</button>
<button onclick="calculateAll();">üß† Auto-Calculate</button>
<button onclick="manualSave()">üíæ Download Data</button>
<button onclick="manualLoad()">üìÇ Upload Data</button>
<button onclick="previewOverlay()">üëÄ Preview layout</button>
<button onclick="exportPDF()">üìÑ Print / PDF</button>

<table id="navlog">
<thead>
<tr>
    <th>FROM</th>
    <th>TO</th>
    <th>MSA</th>
    <th>ALT</th>
    <th>TAS</th>
    <th>TR (T)</th>
    <th>W/V (dir/spd)</th>
    <th>WCA</th>
    <th>HDG (T)</th>
    <th>HDG (M)</th>
    <th>G/S</th>
    <th>Dist</th>
    <th>Time</th>
    <th>ETA</th>
    <th>ATA</th>
</tr>
</thead>
<tbody></tbody>
</table>

<div class="row" style="margin-top:10px;">
    <div style="flex:1;">
        <fieldset>
            <legend>Fuel</legend>
            <div class="field">
                <label>FOB (start)</label>
                <input id="fob">
            </div>
            <div class="field">
                <label>Fuel Required (calc)</label>
                <input id="fuelReq" readonly>
            </div>
        </fieldset>

        <fieldset>
            <legend>Stations</legend>
            <table>
                <thead>
                    <tr><th>STATION</th><th>CRS</th><th>FREQ</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input></td><td><input></td><td><input></td>
                    </tr>
                    <tr>
                        <td><input></td><td><input></td><td><input></td>
                    </tr>
                    <tr>
                        <td><input></td><td><input></td><td><input></td>
                    </tr>
                </tbody>
            </table>
        </fieldset>
    </div>
    <div style="flex:2%;">
        <fieldset>
            <legend>Clearance / Observations</legend>
            <textarea id="clearance"></textarea>
        </fieldset>
    </div>
</div>

</div> <div id="printSheetWrapper">
  <div class="printPage" id="page1">
    <button id="overlayCloseBtn" type="button" onclick="closeOverlay()">Back</button>

    <div id="p1_pilot"      class="fieldPrint top_pilot"></div>
    <div id="p1_acreg"      class="fieldPrint top_acreg"></div>
    <div id="p1_from"       class="fieldPrint top_from"></div>
    <div id="p1_to"         class="fieldPrint top_to"></div>
    <div id="p1_distance"   class="fieldPrint top_distance"></div>
    <div id="p1_fltTime"    class="fieldPrint top_fltTime"></div>
    <div id="p1_alt"        class="fieldPrint top_alt"></div>
    <div id="p1_altDist"    class="fieldPrint top_altDist"></div>
    <div id="p1_brakesOff"  class="fieldPrint top_brakesOff"></div>
    <div id="p1_brakesOn"   class="fieldPrint top_brakesOn"></div>
    <div id="p1_tkofInfo"   class="fieldPrint top_tkofInfo"></div>
    <div id="p1_ldgInfo"    class="fieldPrint top_ldgInfo"></div>

    <div id="p1_r1_from" class="fieldPrint r1_from c-from"></div>
    <div id="p1_r1_to"   class="fieldPrint r1_to   c-from"></div>
    <div id="p1_r2_from" class="fieldPrint r2_from c-from"></div>
    <div id="p1_r2_to"   class="fieldPrint r2_to   c-from"></div>
    <div id="p1_r3_from" class="fieldPrint r3_from c-from"></div>
    <div id="p1_r3_to"   class="fieldPrint r3_to   c-from"></div>
    <div id="p1_r4_from" class="fieldPrint r4_from c-from"></div>
    <div id="p1_r4_to"   class="fieldPrint r4_to   c-from"></div>
    <div id="p1_r5_from" class="fieldPrint r5_from c-from"></div>
    <div id="p1_r5_to"   class="fieldPrint r5_to   c-from"></div>

    <div id="p1_r1_msa"   class="fieldPrint r1 c-msa"></div>
    <div id="p1_r1_alt"   class="fieldPrint r1 c-alt"></div>
    <div id="p1_r1_tas"   class="fieldPrint r1 c-tas"></div>
    <div id="p1_r1_tr"    class="fieldPrint r1 c-tr"></div>
    <div id="p1_r1_wv"    class="fieldPrint r1 c-wv"></div>
    <div id="p1_r1_hdgt"  class="fieldPrint r1 c-hdgt"></div>
    <div id="p1_r1_hdgm"  class="fieldPrint r1 c-hdgm"></div>
    <div id="p1_r1_gs"    class="fieldPrint r1 c-gs"></div>
    <div id="p1_r1_dist"  class="fieldPrint r1 c-dist"></div>
    <div id="p1_r1_time"  class="fieldPrint r1 c-time"></div>

    <div id="p1_r2_msa"   class="fieldPrint r2 c-msa"></div>
    <div id="p1_r2_alt"   class="fieldPrint r2 c-alt"></div>
    <div id="p1_r2_tas"   class="fieldPrint r2 c-tas"></div>
    <div id="p2_r2_tr"    class="fieldPrint r2 c-tr"></div>
    <div id="p2_r2_wv"    class="fieldPrint r2 c-wv"></div>
    <div id="p2_r2_hdgt"  class="fieldPrint r2 c-hdgt"></div>
    <div id="p2_r2_hdgm"  class="fieldPrint r2 c-hdgm"></div>
    <div id="p2_r2_gs"    class="fieldPrint r2 c-gs"></div>
    <div id="p2_r2_dist"  class="fieldPrint r2 c-dist"></div>
    <div id="p2_r2_time"  class="fieldPrint r2 c-time"></div>

    <div id="p1_r3_msa"   class="fieldPrint r3 c-msa"></div>
    <div id="p1_r3_alt"   class="fieldPrint r3 c-alt"></div>
    <div id="p1_r3_tas"   class="fieldPrint r3 c-tas"></div>
    <div id="p1_r3_tr"    class="fieldPrint r3 c-tr"></div>
    <div id="p1_r3_wv"    class="fieldPrint r3 c-wv"></div>
    <div id="p1_r3_hdgt"  class="fieldPrint r3 c-hdgt"></div>
    <div id="p1_r3_hdgm"  class="fieldPrint r3 c-hdgm"></div>
    <div id="p1_r3_gs"    class="fieldPrint r3 c-gs"></div>
    <div id="p1_r3_dist"  class="fieldPrint r3 c-dist"></div>
    <div id="p1_r3_time"  class="fieldPrint r3 c-time"></div>

    <div id="p1_r4_msa"   class="fieldPrint r4 c-msa"></div>
    <div id="p1_r4_alt"   class="fieldPrint r4 c-alt"></div>
    <div id="p1_r4_tas"   class="fieldPrint r4 c-tas"></div>
    <div id="p1_r4_tr"    class="fieldPrint r4 c-tr"></div>
    <div id="p1_r4_wv"    class="fieldPrint r4 c-wv"></div>
    <div id="p1_r4_hdgt"  class="fieldPrint r4 c-hdgt"></div>
    <div id="p1_r4_hdgm"  class="fieldPrint r4 c-hdgm"></div>
    <div id="p1_r4_gs"    class="fieldPrint r4 c-gs"></div>
    <div id="p1_r4_dist"  class="fieldPrint r4 c-dist"></div>
    <div id="p1_r4_time"  class="fieldPrint r4 c-time"></div>

    <div id="p1_r5_msa"   class="fieldPrint r5 c-msa"></div>
    <div id="p1_r5_alt"   class="fieldPrint r5 c-alt"></div>
    <div id="p1_r5_tas"   class="fieldPrint r5 c-tas"></div>
    <div id="p1_r5_tr"    class="fieldPrint r5 c-tr"></div>
    <div id="p1_r5_wv"    class="fieldPrint r5 c-wv"></div>
    <div id="p1_r5_hdgt"  class="fieldPrint r5 c-hdgt"></div>
    <div id="p1_r5_hdgm"  class="fieldPrint r5 c-hdgm"></div>
    <div id="p1_r5_gs"    class="fieldPrint r5 c-gs"></div>
    <div id="p1_r5_dist"  class="fieldPrint r5 c-dist"></div>
    <div id="p1_r5_time"  class="fieldPrint r1 c-time"></div>

    <div id="p1_fob"      class="fieldPrint bottom_fob"></div>
    <div id="p1_fuelReq"  class="fieldPrint bottom_fuelReq"></div>
    <div id="p1_clearance"class="fieldPrint bottom_clearance"></div>
  </div>

  <div class="printPage" id="page2">
    <div id="p2_pilot"      class="fieldPrint top_pilot"></div>
    <div id="p2_acreg"      class="fieldPrint top_acreg"></div>
    <div id="p2_from"       class="fieldPrint top_from"></div>
    <div id="p2_to"         class="fieldPrint top_to"></div>
    <div id="p2_distance"   class="fieldPrint top_distance"></div>
    <div id="p2_fltTime"    class="fieldPrint top_fltTime"></div>
    <div id="p2_alt"        class="fieldPrint top_alt"></div>
    <div id="p2_altDist"    class="fieldPrint top_altDist"></div>
    <div id="p2_brakesOff"  class="fieldPrint top_brakesOff"></div>
    <div id="p2_brakesOn"   class="fieldPrint top_brakesOn"></div>
    <div id="p2_tkofInfo"   class="fieldPrint top_tkofInfo"></div>
    <div id="p2_ldgInfo"    class="fieldPrint top_ldgInfo"></div>

    <div id="p2_r1_from" class="fieldPrint r1_from c-from"></div>
    <div id="p2_r1_to"   class="fieldPrint r1_to   c-from"></div>
    <div id="p2_r2_from" class="fieldPrint r2_from c-from"></div>
    <div id="p2_r2_to"   class="fieldPrint r2_to   c-from"></div>
    <div id="p2_r3_from" class="fieldPrint r3_from c-from"></div>
    <div id="p2_r3_to"   class="fieldPrint r3_to   c-from"></div>
    <div id="p2_r4_from" class="fieldPrint r4_from c-from"></div>
    <div id="p2_r4_to"   class="fieldPrint r4_to   c-from"></div>
    <div id="p2_r5_from" class="fieldPrint r5_from c-from"></div>
    <div id="p2_r5_to"   class="fieldPrint r5_to   c-from"></div>

    <div id="p2_r1_msa"   class="fieldPrint r1 c-msa"></div>
    <div id="p2_r1_alt"   class="fieldPrint r1 c-alt"></div>
    <div id="p2_r1_tas"   class="fieldPrint r1 c-tas"></div>
    <div id="p2_r1_tr"    class="fieldPrint r1 c-tr"></div>
    <div id="p2_r1_wv"    class="fieldPrint r1 c-wv"></div>
    <div id="p2_r1_hdgt"  class="fieldPrint r1 c-hdgt"></div>
    <div id="p2_r1_hdgm"  class="fieldPrint r1 c-hdgm"></div>
    <div id="p2_r1_gs"    class="fieldPrint r1 c-gs"></div>
    <div id="p2_r1_dist"  class="fieldPrint r1 c-dist"></div>
    <div id="p2_r1_time"  class="fieldPrint r1 c-time"></div>

    <div id="p2_r2_msa"   class="fieldPrint r2 c-msa"></div>
    <div id="p2_r2_alt"   class="fieldPrint r2 c-alt"></div>
    <div id="p2_r2_tas"   class="fieldPrint r2 c-tas"></div>
    <div id="p2_r2_tr"    class="fieldPrint r2 c-tr"></div>
    <div id="p2_r2_wv"    class="fieldPrint r2 c-wv"></div>
    <div id="p2_r2_hdgt"  class="fieldPrint r2 c-hdgt"></div>
    <div id="p2_r2_hdgm"  class="fieldPrint r2 c-hdgm"></div>
    <div id="p2_r2_gs"    class="fieldPrint r2 c-gs"></div>
    <div id="p2_r2_dist"  class="fieldPrint r2 c-dist"></div>
    <div id="p2_r2_time"  class="fieldPrint r2 c-time"></div>

    <div id="p2_r3_msa"   class="fieldPrint r3 c-msa"></div>
    <div id="p2_r3_alt"   class="fieldPrint r3 c-alt"></div>
    <div id="p2_r3_tas"   class="fieldPrint r3 c-tas"></div>
    <div id="p2_r3_tr"    class="fieldPrint r3 c-tr"></div>
    <div id="p2_r3_wv"    class="fieldPrint r3 c-wv"></div>
    <div id="p2_r3_hdgt"  class="fieldPrint r3 c-hdgt"></div>
    <div id="p2_r3_hdgm"  class="fieldPrint r3 c-hdgm"></div>
    <div id="p2_r3_gs"    class="fieldPrint r3 c-gs"></div>
    <div id="p2_r3_dist"  class="fieldPrint r3 c-dist"></div>
    <div id="p2_r3_time"  class="fieldPrint r3 c-time"></div>

    <div id="p2_r4_msa"   class="fieldPrint r4 c-msa"></div>
    <div id="p2_r4_alt"   class="fieldPrint r4 c-alt"></div>
    <div id="p2_r4_tas"   class="fieldPrint r4 c-tas"></div>
    <div id="p2_r4_tr"    class="fieldPrint r4 c-tr"></div>
    <div id="p2_r4_wv"    class="fieldPrint r4 c-wv"></div>
    <div id="p2_r4_hdgt"  class="fieldPrint r4 c-hdgt"></div>
    <div id="p2_r4_hdgm"  class="fieldPrint r4 c-hdgm"></div>
    <div id="p2_r4_gs"    class="fieldPrint r4 c-gs"></div>
    <div id="p2_r4_dist"  class="fieldPrint r4 c-dist"></div>
    <div id="p2_r4_time"  class="fieldPrint r4 c-time"></div>

    <div id="p2_r5_msa"   class="fieldPrint r5 c-msa"></div>
    <div id="p2_r5_alt"   class="fieldPrint r5 c-alt"></div>
    <div id="p2_r5_tas"   class="fieldPrint r5 c-tas"></div>
    <div id="p2_r5_tr"    class="fieldPrint r5 c-tr"></div>
    <div id="p2_r5_wv"    class="fieldPrint r5 c-wv"></div>
    <div id="p2_r5_hdgt"  class="fieldPrint r5 c-hdgt"></div>
    <div id="p2_r5_hdgm"  class="fieldPrint r5 c-hdgm"></div>
    <div id="p2_r5_gs"    class="fieldPrint r5 c-gs"></div>
    <div id="p2_r5_dist"  class="fieldPrint r5 c-dist"></div>
    <div id="p2_r5_time"  class="fieldPrint r5 c-time"></div>

    <div id="p2_fob"      class="fieldPrint bottom_fob"></div>
    <div id="p2_fuelReq"  class="fieldPrint bottom_fuelReq"></div>
    <div id="p2_clearance"class="fieldPrint bottom_clearance"></div>
  </div>

  <div class="printPage" id="page3">
    <div id="p3_pilot"      class="fieldPrint top_pilot"></div>
    <div id="p3_acreg"      class="fieldPrint top_acreg"></div>
    <div id="p3_from"       class="fieldPrint top_from"></div>
    <div id="p3_to"         class="fieldPrint top_to"></div>
    <div id="p3_distance"   class="fieldPrint top_distance"></div>
    <div id="p3_fltTime"    class="fieldPrint top_fltTime"></div>
    <div id="p3_alt"        class="fieldPrint top_alt"></div>
    <div id="p3_altDist"    class="fieldPrint top_altDist"></div>
    <div id="p3_brakesOff"  class="fieldPrint top_brakesOff"></div>
    <div id="p3_brakesOn"   class="fieldPrint top_brakesOn"></div>
    <div id="p3_tkofInfo"   class="fieldPrint top_tkofInfo"></div>
    <div id="p3_ldgInfo"    class="fieldPrint top_ldgInfo"></div>

    <div id="p3_r1_from" class="fieldPrint r1_from c-from"></div>
    <div id="p3_r1_to"   class="fieldPrint r1_to   c-from"></div>
    <div id="p3_r2_from" class="fieldPrint r2_from c-from"></div>
    <div id="p3_r2_to"   class="fieldPrint r2_to   c-from"></div>
    <div id="p3_r3_from" class="fieldPrint r3_from c-from"></div>
    <div id="p3_r3_to"   class="fieldPrint r3_to   c-from"></div>
    <div id="p3_r4_from" class="fieldPrint r4_from c-from"></div>
    <div id="p3_r4_to"   class="fieldPrint r4_to   c-from"></div>
    <div id="p3_r5_from" class="fieldPrint r5_from c-from"></div>
    <div id="p3_r5_to"   class="fieldPrint r5_to   c-from"></div>

    <div id="p3_r1_msa"   class="fieldPrint r1 c-msa"></div>
    <div id="p3_r1_alt"   class="fieldPrint r1 c-alt"></div>
    <div id="p3_r1_tas"   class="fieldPrint r1 c-tas"></div>
    <div id="p3_r1_tr"    class="fieldPrint r1 c-tr"></div>
    <div id="p3_r1_wv"    class="fieldPrint r1 c-wv"></div>
    <div id="p3_r1_hdgt"  class="fieldPrint r1 c-hdgt"></div>
    <div id="p3_r1_hdgm"  class="fieldPrint r1 c-hdgm"></div>
    <div id="p3_r1_gs"    class="fieldPrint r1 c-gs"></div>
    <div id="p3_r1_dist"  class="fieldPrint r1 c-dist"></div>
    <div id="p3_r1_time"  class="fieldPrint r1 c-time"></div>

    <div id="p3_r2_msa"   class="fieldPrint r2 c-msa"></div>
    <div id="p3_r2_alt"   class="fieldPrint r2 c-alt"></div>
    <div id="p3_r2_tas"   class="fieldPrint r2 c-tas"></div>
    <div id="p3_r2_tr"    class="fieldPrint r2 c-tr"></div>
    <div id="p3_r2_wv"    class="fieldPrint r2 c-wv"></div>
    <div id="p3_r2_hdgt"  class="fieldPrint r2 c-hdgt"></div>
    <div id="p3_r2_hdgm"  class="fieldPrint r2 c-hdgm"></div>
    <div id="p3_r2_gs"    class="fieldPrint r2 c-gs"></div>
    <div id="p3_r2_dist"  class="fieldPrint r2 c-dist"></div>
    <div id="p3_r2_time"  class="fieldPrint r2 c-time"></div>

    <div id="p3_r3_msa"   class="fieldPrint r3 c-msa"></div>
    <div id="p3_r3_alt"   class="fieldPrint r3 c-alt"></div>
    <div id="p3_r3_tas"   class="fieldPrint r3 c-tas"></div>
    <div id="p3_r3_tr"    class="fieldPrint r3 c-tr"></div>
    <div id="p3_r3_wv"    class="fieldPrint r3 c-wv"></div>
    <div id="p3_r3_hdgt"  class="fieldPrint r3 c-hdgt"></div>
    <div id="p3_r3_hdgm"  class="fieldPrint r3 c-hdgm"></div>
    <div id="p3_r3_gs"    class="fieldPrint r3 c-gs"></div>
    <div id="p3_r3_dist"  class="fieldPrint r3 c-dist"></div>
    <div id="p3_r3_time"  class="fieldPrint r3 c-time"></div>

    <div id="p3_r4_msa"   class="fieldPrint r4 c-msa"></div>
    <div id="p3_r4_alt"   class="fieldPrint r4 c-alt"></div>
    <div id="p3_r4_tas"   class="fieldPrint r4 c-tas"></div>
    <div id="p3_r4_tr"    class="fieldPrint r4 c-tr"></div>
    <div id="p3_r4_wv"    class="fieldPrint r4 c-wv"></div>
    <div id="p3_r4_hdgt"  class="fieldPrint r4 c-hdgt"></div>
    <div id="p3_r4_hdgm"  class="fieldPrint r4 c-hdgm"></div>
    <div id="p3_r4_gs"    class="fieldPrint r4 c-gs"></div>
    <div id="p3_r4_dist"  class="fieldPrint r4 c-dist"></div>
    <div id="p3_r4_time"  class="fieldPrint r4 c-time"></div>

    <div id="p3_r5_msa"   class="fieldPrint r5 c-msa"></div>
    <div id="p3_r5_alt"   class="fieldPrint r5 c-alt"></div>
    <div id="p3_r5_tas"   class="fieldPrint r5 c-tas"></div>
    <div id="p3_r5_tr"    class="fieldPrint r5 c-tr"></div>
    <div id="p3_r5_wv"    class="fieldPrint r5 c-wv"></div>
    <div id="p3_r5_hdgt"  class="fieldPrint r5 c-hdgt"></div>
    <div id="p3_r5_hdgm"  class="fieldPrint r5 c-hdgm"></div>
    <div id="p3_r5_gs"    class="fieldPrint r5 c-gs"></div>
    <div id="p3_r5_dist"  class="fieldPrint r5 c-dist"></div>
    <div id="p3_r5_time"  class="fieldPrint r5 c-time"></div>

    <div id="p3_fob"      class="fieldPrint bottom_fob"></div>
    <div id="p3_fuelReq"  class="fieldPrint bottom_fuelReq"></div>
    <div id="p3_clearance"class="fieldPrint bottom_clearance"></div>
  </div>
</div>

<script>
/* ---------- Local Storage & Waypoint Constants ---------- */
const STORAGE_KEY = 'dentoNavlogData';
const WAYPOINTS = [
    "LCLK", "LCPH", "LCSB", "VRP ORANGE GROVE", "VRP POWER STATION",
    "VRP XYLOTYMBOU", "VRP DHEKELIA", "SALT LAKE", "SIA", "MOSFILOTI",
    "KALOCHORIO", "ALAMPRA", "MARKI", "PERA", "DIPOTAMOS DAM",
    "KALAVASOS DAM", "GERMASOGEIA DAM", "KOURIS DAM", "PACHNA",
    "TRACHYPEDOULA", "ACHELIA"
];

/* ---------- METAR API FUNCTION (NEW) ---------- */
async function getMetar() {
    const icao = document.getElementById('metarIcao').value.toUpperCase().trim();
    const metarOutput = document.getElementById('rawMetar');
    const button = document.getElementById('fetchMetarBtn');

    if (icao.length !== 4) {
        metarOutput.value = "Error: Please enter a valid 4-letter ICAO code.";
        return;
    }
    
    // Disable button and show loading state
    button.textContent = "Fetching...";
    button.disabled = true;
    metarOutput.value = "Fetching METAR for " + icao + "...";

    // Aviation Weather Center (NOAA) API endpoint
    // We request raw METAR data in JSON format for the specified ICAO ID
    const apiUrl = `https://aviationweather.gov/api/data/metar?ids=${icao}&format=json`;

    try {
        const response = await fetch(apiUrl);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();

        if (data.length === 0 || !data[0].rawOb) {
            metarOutput.value = `No current METAR found for ${icao}.`;
        } else {
            metarOutput.value = data[0].rawOb;
        }
    } catch (error) {
        console.error("METAR fetch failed:", error);
        metarOutput.value = `Error fetching METAR. Check console for details. (CORS or network issue: ${error.message})`;
    } finally {
        button.textContent = "‚òÅÔ∏è Get Live METAR";
        button.disabled = false;
        autoSave(); // Save the METAR result
    }
}

/* ---------- helper to read / write cells (supports wpField) ---------- */
function getCellValue(row, col) {
    const cell = row.children[col];
    if (!cell) return "";
    let el = cell.querySelector("input, textarea");
    if (el) return el.value || "";
    el = cell.querySelector("select");
    if (el) return el.value || "";
    return "";
}

function setCellValue(row, col, value) {
    const cell = row.children[col];
    if (!cell) return;
    let input = cell.querySelector("input, textarea");
    
    // Add temporary class for calculated cells (col 7, 8, 9, 10, 12, 13)
    if (col >= 7 && col <= 10 || col === 12 || col === 13) {
        cell.classList.add('calculated-flash');
        setTimeout(() => cell.classList.remove('calculated-flash'), 600);
    }
    
    if (input) input.value = value || "";
    const sel = cell.querySelector("select");
    if (sel) {
        let found = false;
        for (const opt of sel.options) {
            if (opt.value === value || opt.text === value) {
                sel.value = opt.value;
                found = true;
                break;
            }
        }
        if (!found) {
            sel.value = ""; 
        }
    }
}

/* Smart handler for waypoint dropdown (fills its own input + next leg FROM) */
function handleWpSelectChange(sel) {
    const text = sel.value;
    const input = sel.nextElementSibling;
    if (input) input.value = text;

    const cell = sel.closest("td");
    const row  = sel.closest("tr");
    if (!cell || !row) return;

    const tbody = row.parentElement;
    const rows = Array.from(tbody.children);
    const rowIndex = rows.indexOf(row);
    const colIndex = Array.from(row.children).indexOf(cell);

    // If this is TO column (index 1), auto-fill next leg's FROM
    if (colIndex === 1 && rowIndex + 1 < rows.length) {
        const nextRow = rows[rowIndex + 1];
        const nextFromCell = nextRow.children[0];
        if (nextFromCell) {
            const nextInput  = nextFromCell.querySelector("input");
            const nextSelect = nextFromCell.querySelector("select");
            if (nextInput)  nextInput.value = text;
            if (nextSelect) nextSelect.value = text;
        }
    }
}

// Helper to create waypoint options
function createWpOptions() {
    return WAYPOINTS.map(wp => `<option value="${wp}">${wp}</option>`).join('');
}

// Add row (modified for autoSave integration)
function addRow() {
    const wpOptions = createWpOptions();
    const rowHTML = `
    <tr>
        <td>
            <div class="wpField">
                <select onchange="handleWpSelectChange(this); autoSave();">
                    <option value=""></option>
                    ${wpOptions}
                </select>
                <input oninput="autoSave()">
            </div>
        </td>
        <td>
            <div class="wpField">
                <select onchange="handleWpSelectChange(this); autoSave();">
                    <option value=""></option>
                    ${wpOptions}
                </select>
                <input oninput="autoSave()">
            </div>
        </td>
        <td><input type="number" min="0" oninput="autoSave()"></td>
        <td><input type="number" min="0" oninput="autoSave()"></td>
        <td><input type="number" min="0" value="95" oninput="autoSave()"></td>
        <td><input type="number" min="0" max="360" oninput="autoSave()"></td>
        <td><input placeholder="ddd/ss" oninput="autoSave()"></td>
        <td><input readonly></td>
        <td><input readonly></td>
        <td><input readonly></td>
        <td><input readonly></td>
        <td><input type="number" min="0" oninput="autoSave()"></td>
        <td><input readonly></td>
        <td><input readonly></td>
        <td><input oninput="autoSave()"></td>
    </tr>`;
    document.querySelector("#navlog tbody").insertAdjacentHTML("beforeend", rowHTML);
    // Re-bind listeners for new elements inside the row
    setupAutoSaveListeners(document.querySelector("#navlog tbody tr:last-child"));
    autoSave(); // Save after adding a row
}

function deg2rad(d){ return d * Math.PI / 180; }
function rad2deg(r){ return r * 180 / Math.PI; }

function calculateAll() {
    const variation = parseFloat(document.getElementById("variation").value) || 0;
    const fuelburn = parseFloat(document.getElementById("fuelburn").value) || 0;
    const depTimeStr = document.getElementById("depTime").value || "08:00";

    let rows = document.querySelectorAll("#navlog tbody tr");
    let cumulativeMinutes = 0;
    let totalDist = 0;
    let totalTimeMin = 0;

    rows.forEach(row => {
        const TAS  = parseFloat(getCellValue(row, 4)) || 0;
        const TR   = parseFloat(getCellValue(row, 5)) || 0;
        const windStr = getCellValue(row, 6).trim();
        const dist = parseFloat(getCellValue(row, 11)) || 0;

        let wDir = 0, wSpd = 0;
        if (windStr.includes("/")) {
            const parts = windStr.split("/");
            wDir = parseFloat(parts[0]) || 0;
            wSpd = parseFloat(parts[1]) || 0;
        }

        let rel = deg2rad(wDir - TR);
        let WCA = 0;
        if (TAS > 0) {
            let x = (wSpd / TAS) * Math.sin(rel);
            if (x > 1) x = 1;
            if (x < -1) x = -1;
            WCA = rad2deg(Math.asin(x));
        }
        let HDG_T = (TR + WCA + 360) % 360; // Normalize to 0-359
        let GS = TAS - wSpd * Math.cos(rel);
        if (!isFinite(GS) || GS <= 0) GS = TAS;

        let legMin = 0;
        if (GS > 0 && dist > 0) {
            legMin = dist / GS * 60;
        }

        cumulativeMinutes += legMin;
        totalDist += dist;
        totalTimeMin += legMin;

        const eta = computeETA(depTimeStr, cumulativeMinutes);
        let HDG_M = (HDG_T - variation + 360) % 360; // Normalize to 0-359

        setCellValue(row, 7,  WCA.toFixed(1));
        setCellValue(row, 8,  HDG_T.toFixed(0));
        setCellValue(row, 9,  HDG_M.toFixed(0));
        setCellValue(row,10, GS.toFixed(0));
        setCellValue(row,12, legMin ? legMin.toFixed(0) + " min" : "");
        setCellValue(row,13, eta);
    });

    document.getElementById("totalDist").value = totalDist.toFixed(1);

    const hours = totalTimeMin / 60;
    const fuelReq = hours * fuelburn;
    document.getElementById("fuelReq").value = fuelReq ? fuelReq.toFixed(1) + " L" : "";
    
    autoSave(); // Save immediately after calculation
}

function computeETA(depTimeStr, addedMin) {
    const [h,m] = depTimeStr.split(":").map(x => parseInt(x) || 0);
    const base = new Date("2025-01-01T00:00:00");
    base.setHours(h,m,0,0);
    base.setMinutes(base.getMinutes() + addedMin);
    const hh = String(base.getHours()).padStart(2,"0");
    const mm = String(base.getMinutes()).padStart(2,"0");
    return `${hh}:${mm}`;
}

/* ---------- Local Storage Autosave/Autoload ---------- */

function autoSave() {
    const data = {
        top: {
            pilot: document.getElementById("pilot").value,
            acreg: document.getElementById("acreg").value,
            from: document.getElementById("from").value,
            to: document.getElementById("to").value,
            plannedTime: document.getElementById("plannedTime").value,
            alt: document.getElementById("alt").value,
            altDist: document.getElementById("altDist").value,
            depTime: document.getElementById("depTime").value,
            variation: document.getElementById("variation").value,
            fuelburn: document.getElementById("fuelburn").value,
            brakesOff: document.getElementById("brakesOff").value,
            brakesOn: document.getElementById("brakesOn").value,
            tkofInfo: document.getElementById("tkofInfo").value,
            ldgInfo: document.getElementById("ldgInfo").value,
            fob: document.getElementById("fob").value,
            clearance: document.getElementById("clearance").value,
            // Save METAR data
            metarIcao: document.getElementById("metarIcao").value,
            rawMetar: document.getElementById("rawMetar").value
        },
        rows: [],
        stations: []
    };

    document.querySelectorAll("#navlog tbody tr").forEach(r => {
        const rowData = [];
        for (let i = 0; i < r.children.length; i++) {
            rowData.push(getCellValue(r, i));
        }
        data.rows.push(rowData);
    });

    document.querySelectorAll("fieldset legend + table tbody tr").forEach(r => {
        data.stations.push(Array.from(r.children).map(c => {
            const inp = c.querySelector("input");
            return inp ? inp.value : "";
        }));
    });

    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        // console.log("Navlog data auto-saved.");
    } catch (e) {
        console.error("Could not save data to local storage:", e);
    }
}

function createNavlogRowHtml() {
    const wpOptions = createWpOptions();
    return `
    <tr>
        <td>
            <div class="wpField">
                <select onchange="handleWpSelectChange(this); autoSave();">
                    <option value=""></option>
                    ${wpOptions}
                </select>
                <input oninput="autoSave()">
            </div>
        </td>
        <td>
            <div class="wpField">
                <select onchange="handleWpSelectChange(this); autoSave();">
                    <option value=""></option>
                    ${wpOptions}
                </select>
                <input oninput="autoSave()">
            </div>
        </td>
        <td><input type="number" min="0" oninput="autoSave()"></td>
        <td><input type="number" min="0" oninput="autoSave()"></td>
        <td><input type="number" min="0" value="95" oninput="autoSave()"></td>
        <td><input type="number" min="0" max="360" oninput="autoSave()"></td>
        <td><input placeholder="ddd/ss" oninput="autoSave()"></td>
        <td><input readonly></td>
        <td><input readonly></td>
        <td><input readonly></td>
        <td><input readonly></td>
        <td><input type="number" min="0" oninput="autoSave()"></td>
        <td><input readonly></td>
        <td><input readonly></td>
        <td><input oninput="autoSave()"></td>
    </tr>`;
}

function loadDataToForm(data) {
    // Load Top Info
    const t = data.top || {};
    document.getElementById("pilot").value = t.pilot || "";
    document.getElementById("acreg").value = t.acreg || "";
    document.getElementById("from").value = t.from || "";
    document.getElementById("to").value = t.to || "";
    document.getElementById("plannedTime").value = t.plannedTime || "";
    document.getElementById("alt").value = t.alt || "";
    document.getElementById("altDist").value = t.altDist || "";
    document.getElementById("depTime").value = t.depTime || "08:00"; 
    document.getElementById("variation").value = t.variation || "4"; 
    document.getElementById("fuelburn").value = t.fuelburn || "10"; 
    document.getElementById("brakesOff").value = t.brakesOff || "";
    document.getElementById("brakesOn").value = t.brakesOn || "";
    document.getElementById("tkofInfo").value = t.tkofInfo || "";
    document.getElementById("ldgInfo").value = t.ldgInfo || "";
    document.getElementById("fob").value = t.fob || "";
    document.getElementById("clearance").value = t.clearance || "";
    // Load METAR data
    document.getElementById("metarIcao").value = t.metarIcao || "";
    document.getElementById("rawMetar").value = t.rawMetar || "";

    // Load Navlog Rows
    const tbody = document.querySelector("#navlog tbody");
    tbody.innerHTML = "";
    (data.rows || []).forEach(rowArr => {
        tbody.insertAdjacentHTML("beforeend", createNavlogRowHtml());
        
        const last = tbody.querySelector("tr:last-child");
        rowArr.forEach((val, i) => {
            setCellValue(last, i, val);
        });
    });

    // Load Stations
    const stationRows = document.querySelectorAll("fieldset legend + table tbody tr");
    (data.stations || []).forEach((rowArr, rowIndex) => {
        if (stationRows[rowIndex]) {
            rowArr.forEach((val, colIndex) => {
                const inp = stationRows[rowIndex].children[colIndex].querySelector("input");
                if (inp) inp.value = val;
            });
        }
    });

    // Re-run calculations for consistency and visual feedback
    calculateAll();
}

function autoLoad() {
    try {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (!savedData) return false;

        const data = JSON.parse(savedData);
        loadDataToForm(data);
        
        // console.log("Navlog data auto-loaded.");
        return true; // Data was loaded
    } catch (e) {
        console.error("Could not load data from local storage:", e);
        return false; // Load failed
    }
}

function manualSave() {
    // Force a save to ensure all current data is collected
    autoSave(); 

    // Retrieve the data saved by autoSave
    const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
    
    // Download logic
    const blob = new Blob([JSON.stringify(data)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "navlog_dento.json";
    a.click();
}

function manualLoad() {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = ".json";
    input.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = () => {
            const data = JSON.parse(reader.result);
            
            // Load the data from the JSON file
            loadDataToForm(data);
            
            // Re-run setup to bind listeners to new elements and save
            setupAutoSaveListeners();
            autoSave(); 
        };
        reader.readAsText(file);
    };
    input.click();
}

/* ---------- Event Listener Setup and Init ---------- */

function setupAutoSaveListeners(root = document) {
    // Listen for changes on all key input and textarea fields
    const inputs = root.querySelectorAll('input:not([readonly]):not([type="hidden"]), textarea, select');
    inputs.forEach(input => {
        // Remove existing listener to prevent duplicates
        input.removeEventListener('input', autoSave);
        input.removeEventListener('change', autoSave);

        if (input.tagName === 'SELECT') {
            input.addEventListener('change', autoSave);
        } else {
            input.addEventListener('input', autoSave);
        }
    });
}

window.onload = function() {
    const dataLoaded = autoLoad(); // Attempt to load saved data
    
    if (!dataLoaded || document.querySelectorAll("#navlog tbody tr").length === 0) {
        // Only add default rows if no data was loaded or if the table is empty
        addRow(); 
        addRow();
        // Recalculate and save initial state
        calculateAll();
        autoSave();
    }
    
    // Set up listeners for all existing and newly loaded elements
    setupAutoSaveListeners();
};


/* -------- overlay helpers (kept unchanged) -------- */

function fillTopOverlay(prefix) {
    document.getElementById(prefix + "_pilot").textContent     = document.getElementById("pilot").value;
    document.getElementById(prefix + "_acreg").textContent     = document.getElementById("acreg").value;
    document.getElementById(prefix + "_from").textContent      = document.getElementById("from").value;
    document.getElementById(prefix + "_to").textContent        = document.getElementById("to").value;
    document.getElementById(prefix + "_distance").textContent  = document.getElementById("totalDist").value;
    document.getElementById(prefix + "_fltTime").textContent   = document.getElementById("plannedTime").value;
    document.getElementById(prefix + "_alt").textContent       = document.getElementById("alt").value;
    document.getElementById(prefix + "_altDist").textContent   = document.getElementById("altDist").value;
    document.getElementById(prefix + "_brakesOff").textContent = document.getElementById("brakesOff").value;
    document.getElementById(prefix + "_brakesOn").textContent  = document.getElementById("brakesOn").value;
    document.getElementById(prefix + "_tkofInfo").textContent  = document.getElementById("tkofInfo").value;
    document.getElementById(prefix + "_ldgInfo").textContent   = document.getElementById("ldgInfo").value;
    document.getElementById(prefix + "_fob").textContent       = document.getElementById("fob").value;
    document.getElementById(prefix + "_fuelReq").textContent   = document.getElementById("fuelReq").value;
    document.getElementById(prefix + "_clearance").textContent = document.getElementById("clearance").value;
}

function fillPageLeg(prefix, slotIndex, row) {
    const fromDiv = document.getElementById(`${prefix}_r${slotIndex}_from`);
    const toDiv   = document.getElementById(`${prefix}_r${slotIndex}_to`);
    const msaDiv  = document.getElementById(`${prefix}_r${slotIndex}_msa`);
    const altDiv  = document.getElementById(`${prefix}_r${slotIndex}_alt`);
    const tasDiv  = document.getElementById(`${prefix}_r${slotIndex}_tas`);
    const trDiv   = document.getElementById(`${prefix}_r${slotIndex}_tr`);
    const wvDiv   = document.getElementById(`${prefix}_r${slotIndex}_wv`);
    const hdgtDiv = document.getElementById(`${prefix}_r${slotIndex}_hdgt`);
    const hdgmDiv = document.getElementById(`${prefix}_r${slotIndex}_hdgm`);
    const gsDiv   = document.getElementById(`${prefix}_r${slotIndex}_gs`);
    const distDiv = document.getElementById(`${prefix}_r${slotIndex}_dist`);
    const timeDiv = document.getElementById(`${prefix}_r${slotIndex}_time`);

    if (!row) {
        if (fromDiv) fromDiv.textContent = "";
        if (toDiv)   toDiv.textContent   = "";
        if (msaDiv)  msaDiv.textContent  = "";
        if (altDiv)  altDiv.textContent  = "";
        if (tasDiv)  tasDiv.textContent  = "";
        if (trDiv)   trDiv.textContent   = "";
        if (wvDiv)   wvDiv.textContent   = "";
        if (hdgtDiv) hdgtDiv.textContent = "";
        if (hdgmDiv) hdgmDiv.textContent = "";
        if (gsDiv)   gsDiv.textContent   = "";
        if (distDiv) distDiv.textContent = "";
        if (timeDiv) timeDiv.textContent = "";
        return;
    }

    const from  = getCellValue(row, 0);
    const to    = getCellValue(row, 1);
    const msa   = getCellValue(row, 2);
    const alt   = getCellValue(row, 3);
    const tas   = getCellValue(row, 4);
    const tr    = getCellValue(row, 5);
    const wv    = getCellValue(row, 6);
    const hdgt  = getCellValue(row, 8);
    const hdgm  = getCellValue(row, 9);
    const gs    = getCellValue(row,10);
    const dist  = getCellValue(row,11);
    const time  = getCellValue(row,12);

    if (fromDiv) fromDiv.textContent = from;
    if (toDiv)   toDiv.textContent   = to;
    if (msaDiv)  msaDiv.textContent  = msa;
    if (altDiv)  altDiv.textContent  = alt;
    if (tasDiv)  tasDiv.textContent  = tas;
    if (trDiv)   trDiv.textContent   = tr;
    if (wvDiv)   wvDiv.textContent   = wv;
    if (hdgtDiv) hdgtDiv.textContent = hdgt;
    if (hdgmDiv) hdgmDiv.textContent = hdgm;
    if (gsDiv)   gsDiv.textContent   = gs;
    if (distDiv) distDiv.textContent = dist;
    if (timeDiv) timeDiv.textContent = time;
}

function fillOverlayFromForm() {
    const rows = Array.from(document.querySelectorAll("#navlog tbody tr"));

    const page2 = document.getElementById("page2");
    const page3 = document.getElementById("page3");

    // Show/hide second & third pages depending on leg count
    page2.style.display = rows.length > 5  ? "block" : "none";
    page3.style.display = rows.length > 10 ? "block" : "none";

    // Page 1: legs 1‚Äì5
    fillTopOverlay("p1");
    for (let i = 0; i < 5; i++) {
        fillPageLeg("p1", i+1, rows[i] || null);
    }

    // Page 2: legs 6‚Äì10
    if (rows.length > 5) {
        fillTopOverlay("p2");
        for (let i = 0; i < 5; i++) {
            fillPageLeg("p2", i+1, rows[5 + i] || null);
        }
    }

    // Page 3: legs 11‚Äì15
    if (rows.length > 10) {
        fillTopOverlay("p3");
        for (let i = 0; i < 5; i++) {
            fillPageLeg("p3", i+1, rows[10 + i] || null);
        }
    }
}

function previewOverlay() {
    fillOverlayFromForm();
    document.body.classList.add("show-overlay");
}

function closeOverlay() {
    document.body.classList.remove("show-overlay");
}

function exportPDF(){
    fillOverlayFromForm();
    window.print();
}

</script>
</body>
</html>